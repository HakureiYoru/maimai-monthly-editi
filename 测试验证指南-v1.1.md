# 评分任务系统 v1.1 - 测试验证指南

## 测试环境准备

### 1. 数据库更新
确保 `UserRatingTasks` 集合已添加 `lastRefreshTime` 字段：

```
字段名: lastRefreshTime
类型: Date & Time
必填: 否
默认值: 当前时间
```

### 2. 代码部署
确认以下文件已更新并发布：
- ✅ `src/backend/ratingTaskManager.jsw`
- ✅ `src/public/custom-html/task-interface.html`

---

## 测试场景

### 场景1：权重计算优化测试 ✅

**目标**：验证冷门权重不再轻易达到100分

**测试步骤**：

1. **访问任务页面**
   - 登录已验证的用户账号
   - 进入"任务"页面

2. **检查冷门度数值**
   - 查看当前任务的冷门度显示
   - 记录3条任务的权重值

3. **预期结果**：
   - ✅ 大部分作品的冷门度应在 30-70 之间
   - ✅ 只有极少数极度冷门的作品会达到 70+ 
   - ✅ 几乎不会出现 100 分的作品
   - ✅ 权重分布更加合理，区分度更高

**测试数据示例**：
```
作品 #123: 冷门度 45 (5个评分) ✓
作品 #456: 冷门度 62 (3个评分) ✓
作品 #789: 冷门度 38 (8个评分) ✓
```

---

### 场景2：任务刷新时间显示测试 ✅

**目标**：验证刷新时间提示正确显示

**测试步骤**：

1. **首次访问任务页面**
   - 登录用户
   - 打开任务页面

2. **检查刷新时间显示**
   - 查看任务标题下方的刷新时间提示
   - 确认显示格式：`下次刷新: X小时Y分钟后`

3. **预期结果**：
   - ✅ 显示"下次刷新: 48小时0分钟后"（首次访问）
   - ✅ 时间格式清晰易读
   - ✅ 颜色为灰色 (#718096)

**截图示例**：
```
┌─────────────────────────────────┐
│  📋 当前任务                     │
│                                  │
│  下次刷新: 47小时23分钟后        │
│                                  │
│  [ Check ]                       │
└─────────────────────────────────┘
```

---

### 场景3：任务自动刷新功能测试 ✅

**目标**：验证任务在48小时后自动刷新

**测试步骤（方法A - 快速测试）**：

1. **手动修改刷新时间**
   - 在 Wix CMS 中找到当前用户的 `UserRatingTasks` 记录
   - 将 `lastRefreshTime` 改为 2 天前（例如：2025-10-04）
   - 保存修改

2. **访问任务页面**
   - 点击"Check"按钮刷新任务

3. **验证刷新效果**
   - 查看任务列表是否已更新
   - 确认刷新时间提示变为"任务即将刷新，点击Check更新"
   - 点击Check后，任务列表应该刷新
   - 刷新后，`lastRefreshTime` 应更新为当前时间

4. **预期结果**：
   - ✅ 系统检测到超过48小时
   - ✅ 显示蓝色高亮提示："任务即将刷新，点击Check更新"
   - ✅ 点击Check后任务列表更新
   - ✅ 新的3条任务可能与之前不同（基于最新权重）
   - ✅ 刷新时间重置为"下次刷新: 48小时0分钟后"

**测试步骤（方法B - 实际等待）**：

1. 记录当前任务和刷新时间
2. 等待48小时
3. 再次访问任务页面
4. 验证任务已自动刷新

---

### 场景4：刷新倒计时准确性测试 ✅

**目标**：验证刷新倒计时实时更新

**测试步骤**：

1. **记录初始时间**
   - 访问任务页面
   - 记录显示的刷新倒计时（例如：47小时30分钟）

2. **等待1小时后重新访问**
   - 刷新页面或重新进入任务页面
   - 查看刷新倒计时是否减少了1小时

3. **预期结果**：
   - ✅ 倒计时准确减少
   - ✅ 时间计算正确（误差在几分钟内可接受）

---

### 场景5：已完成任务与自主评论统计测试 ✅

**目标**：验证任务完成后的统计正确性

**测试步骤**：

1. **查看当前任务**
   - 记录3条当前任务的作品编号
   - 记录已完成任务数量和自主评论数量

2. **完成一个任务作品的评分**
   - 在主会场找到任务作品
   - 提交评分和评论

3. **返回任务页面验证**
   - 已完成任务数 +1
   - 该作品出现在"已完成任务作品"列表中
   - 任务列表中该作品消失（替换为新任务或空）

4. **完成一个非任务作品的评分**
   - 在主会场评分一个不在任务列表中的作品
   - 返回任务页面

5. **预期结果**：
   - ✅ 任务作品计入"已完成任务"
   - ✅ 非任务作品计入"自主评论"
   - ✅ 统计卡片数字正确更新
   - ✅ 作品编号正确显示在对应列表中

---

### 场景6：未验证用户提示测试 ✅

**目标**：验证未验证用户看到正确提示

**测试步骤**：

1. **使用未验证账号登录**
   - 登录一个未报名比赛的用户
   - 访问任务页面

2. **预期结果**：
   - ✅ 显示"未验证"状态
   - ✅ 提示文字："您尚未报名比赛，无法接受和完成任务"
   - ✅ 不显示任务内容
   - ✅ 进度条显示 0/10

---

### 场景7：Check按钮功能测试 ✅

**目标**：验证Check按钮正常工作

**测试步骤**：

1. **点击Check按钮**
   - 在任务页面点击Check按钮

2. **观察加载状态**
   - 应显示"加载任务中..."
   - 加载动画正常显示

3. **验证数据更新**
   - 任务数据重新加载
   - 如果有新完成的任务，列表应更新
   - 统计数据应同步

4. **预期结果**：
   - ✅ 显示加载状态
   - ✅ 数据正确刷新
   - ✅ 无JavaScript错误

---

## 浏览器控制台检查

在每个测试场景中，打开浏览器控制台（F12），检查：

### 无错误日志 ✅
- 无 JavaScript 错误
- 无网络请求失败
- 无 Wix API 调用失败

### 正常日志输出 ✅
```
[HTML] 页面加载完成，发送TASK_PAGE_READY消息
[HTML] 收到消息: {type: 'TASK_DATA_RESPONSE', data: {...}}
[HTML] 开始渲染, taskData: {...}
[HTML] 解析数据: 任务数 3, 已完成 5, 自主评论 2
```

### 刷新检测日志 ✅
当任务需要刷新时，应看到：
```
用户 {userId} 任务已超时，将刷新任务列表
```

---

## 性能测试

### 页面加载速度 ✅
- 任务页面应在 2 秒内完成渲染
- Check按钮响应应在 1 秒内

### 数据库查询优化 ✅
- 权重计算不应造成明显卡顿
- 刷新检查应快速完成（<100ms）

---

## 回归测试

确保以下原有功能仍正常工作：

### 任务分配 ✅
- 排除用户自己的作品
- 排除已评分作品
- 优先分配冷门作品
- 最多显示3条任务

### 进度追踪 ✅
- 进度条正确显示 (0-10)
- 已完成列表正确显示
- 自主评论列表正确显示

### 主会场集成 ✅
- 提交评论后任务正确标记完成
- 任务作品高亮提示正常
- 积分正确累加

---

## 测试通过标准

所有测试场景均需满足以下标准：

### 功能正确性 ✅
- [ ] 权重计算符合新公式（45基础 + 最高25加成）
- [ ] 刷新时间显示正确
- [ ] 48小时后任务自动刷新
- [ ] 刷新提示准确显示

### 用户体验 ✅
- [ ] 界面无闪烁或卡顿
- [ ] 时间提示清晰易读
- [ ] 操作反馈及时
- [ ] 无错误提示或异常

### 数据准确性 ✅
- [ ] 任务完成统计正确
- [ ] 自主评论统计正确
- [ ] 刷新时间记录准确
- [ ] 权重数值合理

---

## 问题记录表

如发现问题，请记录：

| 问题ID | 场景 | 描述 | 严重程度 | 状态 |
|--------|------|------|----------|------|
| - | - | - | - | - |

**严重程度**：
- P0: 阻塞性问题（无法使用）
- P1: 严重问题（功能异常）
- P2: 一般问题（体验不佳）
- P3: 轻微问题（建议优化）

---

## 测试总结

### 测试完成后，确认以下检查清单：

#### 核心功能 ✅
- [ ] 权重优化生效
- [ ] 定期刷新正常
- [ ] 刷新提示显示
- [ ] Check按钮工作

#### 数据同步 ✅
- [ ] 任务完成计数正确
- [ ] 刷新时间记录准确
- [ ] 数据库字段正常

#### 用户体验 ✅
- [ ] 界面显示正常
- [ ] 交互流畅
- [ ] 提示清晰
- [ ] 无明显bug

#### 兼容性 ✅
- [ ] 现有功能不受影响
- [ ] 历史数据兼容
- [ ] 主会场集成正常

---

## 测试签名

**测试人员**: ___________  
**测试日期**: ___________  
**测试结果**: □ 通过  □ 不通过  
**备注**: ___________

---

**版本**: v1.1  
**文档日期**: 2025-10-06  
**测试范围**: 权重优化 + 定期刷新功能

