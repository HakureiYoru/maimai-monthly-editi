# 楼中楼邮件通知配置说明

## 功能概述

当用户的正式评论收到楼中楼回复时，系统会自动使用 **Wix Triggered Emails** 发送邮件通知给原评论作者（不包括作者自评）。

## 邮件内容格式

```
主题：您的评论收到了新回复

亲爱的 [用户昵称]，

您给 XX 号作品的正式评论：
"[原评论内容]"

被添加了楼中楼：
"[楼中楼回复内容]"

---
这是一封自动通知邮件，请勿直接回复。
```

**注意：邮件中不会显示回复者的昵称。**

## 实现方式

### 1. 代码文件

- **后端模块**：`src/backend/emailNotifications.jsw`
  - `sendReplyNotification()` - 发送邮件通知的主函数
  - 使用 `triggeredEmails.emailMember()` 发送邮件
  
- **前端页面**：`src/pages/CommentReplies.s12mz.js`
  - 在提交楼中楼回复时自动调用邮件通知函数

### 2. Wix Triggered Emails 配置

#### 已配置的邮件模板

- **邮件ID**: `UzNgRgj`
- **邮件类型**: Email Site Members（向网站会员发送邮件）

#### 邮件模板中的变量

代码会自动填充以下变量：

| 变量名 | 说明 | 类型 |
|--------|------|------|
| `recipientNickname` | 接收者昵称 | 字符串 |
| `workNumber` | 作品编号 | 字符串 |
| `originalCommentText` | 原评论内容 | 字符串 |
| `replyContent` | 楼中楼回复内容 | 字符串 |

#### 如何修改邮件模板

1. **进入Wix编辑器**
   - 点击左侧工具栏的 "Developer Tools（开发工具）"
   - 选择 "Triggered Emails"

2. **找到邮件模板**
   - 找到ID为 `UzNgRgj` 的邮件模板
   - 点击编辑

3. **编辑邮件内容**
   - 在邮件内容中使用变量格式：`${变量名}`
   - 例如：`${recipientNickname}`, `${workNumber}`
   - 保存修改

### 4. 通知发送逻辑

系统会在以下情况发送邮件：

✅ **会发送邮件**：
- 正式评论（非作者自评）收到楼中楼回复
- 回复者不是原评论作者本人

❌ **不会发送邮件**：
- 作者自评收到楼中楼回复（作者自评不算正式评论）
- 用户回复自己的评论
- 作品不存在或已被淘汰

## 测试验证

### 测试步骤：

1. **用户A** 对作品 #10 提交正式评论（不是作品作者）
2. **用户B** 在用户A的评论下添加楼中楼回复
3. 检查 `EmailQueue` 集合是否创建了新记录
4. 等待几分钟，检查 **用户A** 的邮箱是否收到通知邮件

### 调试信息：

在浏览器控制台中可以看到以下日志：
- `邮件通知结果: {success: true, message: "邮件通知已发送", ...}`
- 或错误信息：`发送邮件通知失败（不影响回复提交）: ...`

## 注意事项

1. **邮件发送不会阻塞用户操作**
   - 即使邮件发送失败，楼中楼回复仍会成功提交
   - 错误只会记录在控制台，不影响用户体验

2. **隐私保护**
   - 邮件中不显示回复者的昵称
   - 系统会自动识别作者自评并跳过通知

3. **性能考虑**
   - 邮件发送为异步操作，不影响页面响应速度
   - 使用Wix原生的Triggered Emails API，稳定可靠

4. **权限要求**
   - 邮件只发送给已注册的网站会员
   - 需要用户有有效的邮箱地址

## 故障排查

### 问题：用户没有收到邮件

**检查清单**：
- [ ] Triggered Email模板（ID: `UzNgRgj`）是否已创建并激活？
- [ ] 用户是否为已登录的网站会员？
- [ ] 用户是否有有效的邮箱地址？
- [ ] 检查用户的垃圾邮件文件夹
- [ ] 查看浏览器控制台是否有错误日志

### 问题：邮件内容显示变量名而非实际值

**解决方案**：
- 确保邮件模板中使用正确的变量格式：`${变量名}`
- 变量名必须与代码中定义的完全一致
- 检查邮件模板是否保存成功

### 问题：控制台显示"发送Triggered Email失败"

**可能原因**：
- Triggered Email模板可能已被删除或ID不正确
- 接收者不是有效的网站会员
- Wix服务暂时不可用

**解决方案**：
- 确认邮件模板ID `UzNgRgj` 仍然有效
- 确认接收者是已注册的会员
- 稍后重试或联系Wix技术支持

## 代码示例

### 后端调用示例

```javascript
// 注意：后端代码使用 wix-crm-backend
import { triggeredEmails } from 'wix-crm-backend';

await triggeredEmails.emailMember('UzNgRgj', recipientUserId, {
  variables: {
    recipientNickname: "张三",
    workNumber: "10",
    originalCommentText: "这个谱面很棒！",
    replyContent: "感谢您的评论！"
  }
});
```

**重要提示**：
- 后端文件（`.jsw`）使用：`import { triggeredEmails } from 'wix-crm-backend'`
- 前端文件（`.js`）使用：`import { triggeredEmails } from 'wix-crm'`

### 完整工作流程

1. 用户B在用户A的评论下添加楼中楼回复
2. `CommentReplies.s12mz.js` 调用 `sendReplyNotification()`
3. 后端检查：是否为自己回复自己？是否为作者自评？
4. 获取接收者（用户A）的昵称和信息
5. 调用 `triggeredEmails.emailMember()` 发送邮件
6. Wix自动将邮件发送到用户A的邮箱

## 未来优化建议

1. **邮件模板美化**
   - 在Wix Triggered Emails编辑器中美化模板
   - 添加品牌Logo和颜色主题
   - 添加按钮链接，直接跳转到评论位置

2. **批量通知**
   - 如果短时间内收到多条回复，合并为一封邮件
   - 添加摘要功能

3. **通知偏好设置**
   - 在用户设置页面添加"邮件通知开关"
   - 允许用户选择接收通知的类型

4. **通知统计**
   - 在CMS中记录邮件发送日志
   - 统计邮件发送成功率

---

## 相关文件

- `src/backend/emailNotifications.jsw` - 邮件通知后端逻辑
- `src/pages/CommentReplies.s12mz.js` - 楼中楼回复页面
- `src/backend/getUserPublicInfo.jsw` - 用户信息获取模块

## 参考文档

- [Wix Triggered Emails 官方文档](https://dev.wix.com/docs/develop-websites/articles/workspace-tools/developer-tools/triggered-emails/sending-a-triggered-email-to-members)
- [Wix CRM Backend API](https://www.wix.com/velo/reference/wix-crm-backend/triggeredemails)

