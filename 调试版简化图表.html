<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è°ƒè¯•ç‰ˆå›¾è¡¨</title>
  <style>
    body {
      background: transparent;
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    
    .debug-container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .data-info {
      background: #e2e3e5;
      color: #383d41;
      border: 1px solid #d6d8db;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    
    canvas {
      width: 100% !important;
      height: 300px !important;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
  <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.min.js"></script>
</head>
<body>
  <div class="debug-container">
    <h2>ğŸ”§ å›¾è¡¨è°ƒè¯•æ¨¡å¼</h2>
    <div id="status" class="status loading">ç­‰å¾…æ•°æ®ä¸­...</div>
    <div id="dataInfo" class="data-info" style="display: none;"></div>
    <canvas id="debugChart" style="display: none;"></canvas>
    
    <h3>ğŸ•’ æ¶ˆæ¯æ—¥å¿—:</h3>
    <div id="messageLog" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa;"></div>
  </div>

  <script>
    let chart = null;
    let messageCount = 0;
    
    function log(message, type = 'info') {
      messageCount++;
      const timestamp = new Date().toLocaleTimeString();
      const logDiv = document.getElementById('messageLog');
      const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
      logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[è°ƒè¯•å›¾è¡¨] ${message}`);
    }
    
    function updateStatus(message, type = 'loading') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }
    
    function showDataInfo(data) {
      const dataDiv = document.getElementById('dataInfo');
      dataDiv.style.display = 'block';
      dataDiv.textContent = `æ¥æ”¶åˆ°çš„æ•°æ®:
ä½œå“æ•°é‡: ${data.workNumbers?.length || 0}
è¯„åˆ†æ•°é‡: ${data.scores?.length || 0}  
è¯„è®ºæ•°é‡: ${data.commentsCounts?.length || 0}
ç¤ºä¾‹ä½œå“: ${data.workNumbers?.slice(0, 3).join(', ') || 'æ— '}
ç¤ºä¾‹è¯„åˆ†: ${data.scores?.slice(0, 3).join(', ') || 'æ— '}
ç¤ºä¾‹è¯„è®ºæ•°: ${data.commentsCounts?.slice(0, 3).join(', ') || 'æ— '}`;
    }
    
    function createDebugChart(workNumbers, scores, commentsCounts) {
      try {
        log('å¼€å§‹åˆ›å»ºå›¾è¡¨...', 'info');
        
        if (!workNumbers || !scores || !commentsCounts) {
          throw new Error('æ•°æ®ä¸å®Œæ•´');
        }
        
        // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
        if (typeof Chart === 'undefined') {
          log('Chart.jsæœªåŠ è½½ï¼Œå°è¯•åˆ›å»ºç®€å•å›¾è¡¨', 'error');
          createSimpleChart(workNumbers, scores, commentsCounts);
          return;
        }
        
        // å–å‰10ä¸ªæ•°æ®ç‚¹
        const maxItems = 10;
        const labels = workNumbers.slice(0, maxItems).map(n => `#${n}`);
        const scoreData = scores.slice(0, maxItems);
        const commentData = commentsCounts.slice(0, maxItems);
        
        const ctx = document.getElementById('debugChart').getContext('2d');
        
        if (chart) {
          chart.destroy();
        }
        
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'è¯„åˆ†',
                data: scoreData,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                yAxisID: 'y-score'
              },
              {
                label: 'è¯„è®ºæ•°',
                data: commentData,
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                yAxisID: 'y-comment'
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              'y-score': {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'è¯„åˆ†'
                }
              },
              'y-comment': {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'è¯„è®ºæ•°'
                },
                grid: {
                  drawOnChartArea: false
                }
              }
            }
          }
        });
        
        document.getElementById('debugChart').style.display = 'block';
        updateStatus('å›¾è¡¨åˆ›å»ºæˆåŠŸï¼', 'success');
        log('å›¾è¡¨åˆ›å»ºæˆåŠŸ', 'success');
        
      } catch (error) {
        updateStatus('å›¾è¡¨åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
        log('å›¾è¡¨åˆ›å»ºå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ: ' + error.message, 'error');
        createSimpleChart(workNumbers, scores, commentsCounts);
      }
    }
    
    function createSimpleChart(workNumbers, scores, commentsCounts) {
      try {
        log('åˆ›å»ºç®€å•HTMLå›¾è¡¨...', 'info');
        
        // å–å‰10ä¸ªæ•°æ®ç‚¹
        const maxItems = 10;
        const items = workNumbers.slice(0, maxItems).map((num, i) => ({
          workNumber: num,
          score: scores[i] || 0,
          comments: commentsCounts[i] || 0
        }));
        
        // æŒ‰è¯„è®ºæ•°æ’åº
        items.sort((a, b) => b.comments - a.comments);
        
        const canvas = document.getElementById('debugChart');
        canvas.style.display = 'none';
        
        // åˆ›å»ºHTMLè¡¨æ ¼å›¾è¡¨
        const chartHtml = `
          <div style="margin-top: 20px;">
            <h3>ğŸ“Š ä½œå“æ’è¡Œæ¦œ</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
              ${items.map((item, index) => `
                <div style="
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  padding: 15px;
                  border-radius: 8px;
                  min-width: 120px;
                  text-align: center;
                  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                ">
                  <div style="font-size: 18px; font-weight: bold;">ä½œå“ #${item.workNumber}</div>
                  <div style="margin: 8px 0; font-size: 14px;">è¯„åˆ†: ${Math.round(item.score)}</div>
                  <div style="font-size: 14px;">è¯„è®º: ${item.comments}æ¡</div>
                  <div style="margin-top: 5px; font-size: 12px; opacity: 0.8;">ç¬¬${index + 1}å</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        
        const container = canvas.parentNode;
        const chartDiv = document.createElement('div');
        chartDiv.innerHTML = chartHtml;
        container.appendChild(chartDiv);
        
        updateStatus('ç®€å•å›¾è¡¨åˆ›å»ºæˆåŠŸï¼', 'success');
        log('ç®€å•å›¾è¡¨åˆ›å»ºæˆåŠŸ', 'success');
        
      } catch (error) {
        updateStatus('æ‰€æœ‰å›¾è¡¨æ–¹æ¡ˆéƒ½å¤±è´¥: ' + error.message, 'error');
        log('æ‰€æœ‰å›¾è¡¨æ–¹æ¡ˆéƒ½å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    function processMessage(data) {
      try {
        log(`æ¥æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data).substring(0, 100)}...`);
        
        if (data && data.workNumbers && data.scores && data.commentsCounts) {
          log('æ•°æ®æ ¼å¼æ­£ç¡®ï¼Œå¼€å§‹å¤„ç†', 'success');
          showDataInfo(data);
          createDebugChart(data.workNumbers, data.scores, data.commentsCounts);
        } else {
          log('æ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–ç¼ºå°‘å¿…è¦å­—æ®µ', 'error');
        }
      } catch (error) {
        log('å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: ' + error.message, 'error');
      }
    }
    
    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', () => {
      log('è°ƒè¯•å›¾è¡¨é¡µé¢åŠ è½½å®Œæˆ');
      updateStatus('ç­‰å¾…çˆ¶é¡µé¢æ•°æ®...', 'loading');
      
      // å‘çˆ¶é¡µé¢å‘é€å°±ç»ªæ¶ˆæ¯
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'chart-ready' }, '*');
          log('å·²å‘çˆ¶é¡µé¢å‘é€å°±ç»ªæ¶ˆæ¯');
        }
      } catch (error) {
        log('å‘é€å°±ç»ªæ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
      }
      
      // 5ç§’åæ˜¾ç¤ºæµ‹è¯•æ•°æ®
      setTimeout(() => {
        if (!chart) {
          log('5ç§’åä»æœªæ”¶åˆ°æ•°æ®ï¼Œæ˜¾ç¤ºæµ‹è¯•å›¾è¡¨');
          updateStatus('æ˜¾ç¤ºæµ‹è¯•æ•°æ®', 'loading');
          const testData = {
            workNumbers: ['1', '2', '3', '4', '5'],
            scores: [850, 750, 920, 680, 780],
            commentsCounts: [15, 8, 23, 5, 12]
          };
          processMessage(testData);
        }
      }, 5000);
    });
    
    // å¤šç§æ¶ˆæ¯ç›‘å¬æ–¹å¼
    window.addEventListener('message', (event) => {
      log(`æ ‡å‡†æ¶ˆæ¯ç›‘å¬æ”¶åˆ°: origin=${event.origin}`);
      processMessage(event.data);
    });
    
    window.receiveChartData = function(data) {
      log('ç›´æ¥å‡½æ•°è°ƒç”¨æ”¶åˆ°æ•°æ®');
      processMessage(data);
    };
    
    // å…¨å±€å˜é‡è½®è¯¢
    setInterval(() => {
      if (window.chartData && !window.chartDataProcessed) {
        log('è½®è¯¢æ£€æµ‹åˆ°å…¨å±€å˜é‡æ•°æ®');
        processMessage(window.chartData);
        window.chartDataProcessed = true;
      }
    }, 1000);
    
    // è®©çˆ¶é¡µé¢èƒ½å¤Ÿè®¿é—®è¿™ä¸ªå‡½æ•°
    window.debugChart = {
      processMessage: processMessage,
      log: log
    };
    
  </script>
</body>
</html>
