# 评论系统迁移清单

## 🎯 迁移目标

将旧的评论系统（基于Wix原生组件）迁移到新的HTML自定义元件。

## ✅ 迁移前检查

- [ ] 已备份当前页面和代码
- [ ] 已创建测试账号用于验证功能
- [ ] 已在开发/测试环境中部署新HTML元件
- [ ] 已阅读 `COMMENT_SYSTEM_DEPLOYMENT.md` 文档

## 📋 分步迁移流程

### 阶段 1: 部署新系统（保留旧系统）

#### 步骤 1.1: 添加HTML元件
- [ ] 在 Wix 编辑器中添加 HTML iframe 元件
- [ ] 设置元件ID为 `commentSystemPanel`
- [ ] 上传 `comment-system.html` 文件
- [ ] 调整元件大小和位置

#### 步骤 1.2: 确认代码集成
- [ ] 确认 `Stage_主会场.vz6uu.js` 中包含 `initCommentSystemPanel()` 调用
- [ ] 确认所有集成函数已添加到文件末尾
- [ ] 保存并发布代码

#### 步骤 1.3: 隐藏旧组件（暂不删除）
在 `$w.onReady` 函数的开始处添加以下代码：

```javascript
// 【迁移阶段】临时隐藏旧评论组件，用于测试新HTML元件
const hideOldCommentComponents = true; // 设置为 false 可快速恢复旧系统

if (hideOldCommentComponents) {
  try {
    console.log("[迁移] 隐藏旧评论组件...");
    
    // 输入区组件
    if ($w("#Comment")) $w("#Comment").hide();
    if ($w("#inputNumber")) $w("#inputNumber").hide();
    if ($w("#inputScore")) $w("#inputScore").hide();
    if ($w("#submit")) $w("#submit").hide();
    if ($w("#submitprocess")) $w("#submitprocess").hide();
    
    // 筛选和列表组件
    if ($w("#radioGroupComment")) $w("#radioGroupComment").hide();
    if ($w("#dropdownFilter")) $w("#dropdownFilter").hide();
    if ($w("#repeater1")) $w("#repeater1").hide();
    if ($w("#pagination1")) $w("#pagination1").hide();
    if ($w("#pagination2")) $w("#pagination2").hide();
    
    console.log("[迁移] 旧组件已隐藏");
  } catch (error) {
    console.error("[迁移] 隐藏旧组件时出错:", error);
  }
}
```

- [ ] 添加上述代码
- [ ] 保存并发布

### 阶段 2: 测试新系统

#### 步骤 2.1: 基础功能测试
- [ ] 页面加载正常
- [ ] 新HTML元件正确显示
- [ ] 控制台无错误信息
- [ ] 作品选项正确加载
- [ ] 评论列表正确显示

#### 步骤 2.2: 评论提交测试
- [ ] 未登录状态：正确提示"未登录"
- [ ] 未报名状态：正确提示"未报名"
- [ ] 正常提交评论：成功提交并显示
- [ ] 重复提交：正确阻止（非作者自评）
- [ ] 作者自评：允许提交，显示为Sc
- [ ] 淘汰作品：正确阻止提交

#### 步骤 2.3: 评论显示测试
- [ ] 评分显示正确（普通评论、Sc、Re、?）
- [ ] 评分背景色正确（红色渐变、紫色、蓝色、灰色）
- [ ] 作品评级信息正确（T0-T4、评分不足、暂无评分）
- [ ] 淘汰作品标记正确显示
- [ ] 回复数量正确显示

#### 步骤 2.4: 筛选功能测试
- [ ] 作品筛选：选择特定作品后只显示该作品评论
- [ ] "所有评论"：显示所有评论
- [ ] "仅评分"：只显示正式评分（排除Sc和Re）
- [ ] "仅你的评论"：只显示当前用户评论

#### 步骤 2.5: 分页功能测试
- [ ] 分页信息正确显示
- [ ] "上一页"/"下一页"按钮正常工作
- [ ] 顶部和底部分页器同步
- [ ] 首页时"上一页"禁用
- [ ] 末页时"下一页"禁用

#### 步骤 2.6: 操作功能测试
- [ ] "查看完整"：打开 TextPopup 显示完整内容
- [ ] "跳转到作品"：执行跳转操作
- [ ] "查看回复"：打开回复面板
- [ ] "删除"：打开删除确认面板并正确执行删除

#### 步骤 2.7: 集成功能测试
- [ ] 任务系统：提交任务作品评论时任务状态更新
- [ ] 积分系统：提交评论后积分增加
- [ ] 删除确认：删除流程完整工作
- [ ] 回复面板：查看和提交回复正常

#### 步骤 2.8: 性能测试
- [ ] 大量评论（100+）时加载速度可接受
- [ ] 筛选和分页响应及时
- [ ] 提交评论后刷新速度合理
- [ ] 无明显内存泄漏

### 阶段 3: 清理旧系统（谨慎操作）

**⚠️ 警告**: 只有在确认新系统完全正常后才执行此阶段！

#### 步骤 3.1: 备份
- [ ] 完整备份当前页面
- [ ] 导出当前代码到本地文件

#### 步骤 3.2: 移除旧组件事件监听器

在 `Stage_主会场.vz6uu.js` 中注释或删除以下函数调用（在 `$w.onReady` 中）：

```javascript
// 【已废弃】旧评论系统的事件监听器设置，新系统已集成到HTML元件中
// setupSearchAndPaginationEvents();
// setupCommentsPaginationEvents();
// setupSubmitButtonEvent();
// setupDropdownFilterEvent();
// setupScoreCheckboxEvent();
// setupWorkSelectionEvent();
```

- [ ] 注释掉上述函数调用
- [ ] 测试确认无影响
- [ ] 保存并发布

#### 步骤 3.3: 标记可删除的函数

以下函数仅用于旧系统，可以保留（作为备份）或删除：

**评论输入相关**:
- `updateCommentControlsVerificationStatus()` - 如果没有其他地方使用
- `setupWorkSelectionEvent()` - 旧作品选择事件
- `setupSubmitButtonEvent()` - 旧提交按钮事件

**评论显示相关**:
- `setupDropdownFilterEvent()` - 旧筛选事件
- `setupScoreCheckboxEvent()` - 旧评分筛选事件
- `setupCommentsPaginationEvents()` - 旧分页事件
- `setDropdownValue()` - 如果只用于旧系统
- `loadAllFormalComments()` - 如果只用于旧系统

**Repeater相关**:
- Repeater1 的 `onItemReady` 回调（199-456行）

**建议**: 
- [ ] 先注释这些函数而非删除
- [ ] 运行至少一周无问题后再考虑删除
- [ ] 删除前再次确认没有其他地方引用

#### 步骤 3.4: 删除Wix组件

在 Wix 编辑器中删除以下组件：

**输入区组件**:
- [ ] `#Comment` - 评论文本框
- [ ] `#inputNumber` - 作品编号下拉框
- [ ] `#inputScore` - 评分输入框
- [ ] `#submit` - 提交按钮
- [ ] `#submitprocess` - 提交状态文字

**筛选和列表组件**:
- [ ] `#radioGroupComment` - 评论类型筛选
- [ ] `#dropdownFilter` - 作品筛选下拉框
- [ ] `#repeater1` - 评论列表 repeater
- [ ] `#pagination1` - 顶部分页器
- [ ] `#pagination2` - 底部分页器

**相关标签和容器**:
- [ ] 检查是否有仅用于这些组件的标签、容器等
- [ ] 删除这些辅助组件

#### 步骤 3.5: 代码最终清理

- [ ] 删除隐藏旧组件的临时代码（步骤1.3中添加的）
- [ ] 删除或注释已标记为可删除的函数
- [ ] 清理未使用的导入和常量
- [ ] 运行代码格式化
- [ ] 最终测试

### 阶段 4: 验证和监控

#### 步骤 4.1: 用户验收测试
- [ ] 邀请真实用户测试
- [ ] 收集用户反馈
- [ ] 记录任何问题

#### 步骤 4.2: 监控
- [ ] 监控错误日志（至少一周）
- [ ] 检查性能指标
- [ ] 关注用户报告的问题

#### 步骤 4.3: 文档更新
- [ ] 更新相关文档
- [ ] 记录迁移经验
- [ ] 更新维护指南

## 🔄 回滚计划

如果新系统出现严重问题需要回滚：

### 快速回滚（保留旧组件时）
1. 设置 `hideOldCommentComponents = false`
2. 隐藏或删除 `#commentSystemPanel` HTML元件
3. 保存并发布

### 完全回滚（已删除旧组件时）
1. 从备份恢复页面和代码
2. 重新发布

## 📊 迁移进度追踪

### 当前阶段: ___________

- 阶段 1: 部署新系统 - [ ] 未开始 [ ] 进行中 [ ] 已完成
- 阶段 2: 测试新系统 - [ ] 未开始 [ ] 进行中 [ ] 已完成
- 阶段 3: 清理旧系统 - [ ] 未开始 [ ] 进行中 [ ] 已完成
- 阶段 4: 验证和监控 - [ ] 未开始 [ ] 进行中 [ ] 已完成

### 发现的问题

| 问题描述 | 严重性 | 状态 | 解决方案 |
|---------|--------|------|---------|
|         |        |      |         |

### 迁移时间线

| 阶段 | 开始日期 | 完成日期 | 用时 |
|------|---------|---------|------|
| 1    |         |         |      |
| 2    |         |         |      |
| 3    |         |         |      |
| 4    |         |         |      |

## 📞 技术支持

遇到问题时的检查顺序：
1. ✅ 检查浏览器控制台错误
2. ✅ 确认HTML元件ID正确 (`commentSystemPanel`)
3. ✅ 确认所有代码已保存并发布
4. ✅ 查看 `COMMENT_SYSTEM_DEPLOYMENT.md` 的"已知问题"
5. ✅ 检查本清单的常见问题

## 🎓 经验教训

迁移完成后，记录关键经验：

### 成功要点
- 

### 遇到的挑战
- 

### 改进建议
- 

---

**创建日期**: 2025-10-26  
**最后更新**: 2025-10-26  
**版本**: 1.0

