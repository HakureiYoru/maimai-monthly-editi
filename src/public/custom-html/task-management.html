<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: rgba(0, 0, 0, 0);
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(42, 42, 42, 0.92);
            border: 1px solid #555;
            padding: 25px;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #fff;
            font-size: 28px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid #555;
            background: #333;
            color: #fff;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #777;
            background: #3a3a3a;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        select,
        button {
            padding: 12px 20px;
            border: 1px solid #555;
            font-size: 14px;
            cursor: pointer;
            background: #333;
            color: #fff;
        }

        select:hover,
        button:hover {
            border-color: #777;
            background: #3a3a3a;
        }

        button {
            background: #555;
            color: #fff;
            border-color: #666;
        }

        button:hover {
            background: #666;
        }

        .btn-refresh-user {
            background: #28a745;
            color: #fff;
            border: 1px solid #28a745;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-refresh-user:hover {
            background: #218838;
        }

        .btn-refresh-user:disabled {
            background: #555;
            border-color: #666;
            cursor: not-allowed;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(42, 42, 42, 0.92);
            padding: 20px;
            border: 1px solid #555;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 8px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
        }

        /* ç”¨æˆ·å¡ç‰‡ */
        .users-grid {
            display: grid;
            gap: 20px;
        }

        .user-card {
            background: rgba(42, 42, 42, 0.92);
            border: 1px solid #555;
            padding: 20px;
        }

        .user-card:hover {
            background: #3a3a3a;
        }

        .user-header {
            display: flex;
            gap: 15px;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quality-badge {
            padding: 4px 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .quality-high {
            background: #FFD700;
            color: #000;
        }

        .quality-low {
            background: #666;
            color: #fff;
        }

        .user-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #ccc;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .progress-mini {
            display: inline-block;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .progress-complete {
            background: #28a745;
            color: #fff;
        }

        .progress-active {
            background: #ffc107;
            color: #000;
        }

        .progress-low {
            background: #dc3545;
            color: #fff;
        }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .tasks-section {
            margin-top: 15px;
        }

        .tasks-header {
            font-size: 15px;
            font-weight: bold;
            color: #ccc;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .tasks-header:hover {
            color: #fff;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        .tasks-list {
            display: grid;
            gap: 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tasks-list.expanded {
            max-height: 3000px;
        }

        .task-item {
            background: #333;
            padding: 15px;
            border-left: 3px solid #666;
        }

        .task-work-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-work-id {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .task-work-title {
            font-size: 13px;
            color: #ccc;
            margin-left: 8px;
        }

        .weight-badge {
            background: #d63031;
            color: #fff;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .weight-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #2a2a2a;
        }

        .weight-detail-item {
            font-size: 12px;
        }

        .weight-label {
            color: #888;
            margin-right: 5px;
        }

        .weight-value {
            font-weight: bold;
            color: #fff;
        }

        .balance-factor {
            display: inline-block;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .balance-increase {
            background: #28a745;
            color: #fff;
        }

        .balance-decrease {
            background: #dc3545;
            color: #fff;
        }

        .balance-neutral {
            background: #666;
            color: #fff;
        }

        .ratio-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #2a2a2a;
            font-size: 12px;
            color: #ddd;
        }

        .ratio-bar {
            flex: 1;
            height: 18px;
            overflow: hidden;
            background: #444;
            display: flex;
        }

        .ratio-high {
            background: #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 10px;
            font-weight: bold;
        }

        .ratio-low {
            background: #90EE90;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 10px;
            font-weight: bold;
        }

        .ratio-status {
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .ratio-balanced {
            background: #28a745;
            color: #fff;
        }

        .ratio-unbalanced {
            background: #ffc107;
            color: #000;
        }

        .no-tasks {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 14px;
            background: #2a2a2a;
        }

        /* å·²å®Œæˆåˆ—è¡¨æ ·å¼ */
        .completed-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .completed-title {
            font-size: 14px;
            font-weight: bold;
            color: #ccc;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .works-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }


        .work-item {
            background: #555;
            padding: 10px 6px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            color: #fff;
            cursor: default;
        }

        .work-item:hover {
            background: #666;
        }

        .work-item-free {
            background: #444;
        }

        .empty-list {
            text-align: center;
            color: #888;
            padding: 10px;
            font-size: 12px;
            background: #2a2a2a;
        }

        .loading,
        .error {
            text-align: center;
            padding: 60px 20px;
            background: rgba(42, 42, 42, 0.92);
            border: 1px solid #555;
        }

        .loading {
            color: #ccc;
            font-size: 18px;
        }

        .error {
            color: #e74c3c;
            font-size: 18px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #444;
            border-top: 4px solid #ccc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 16px;
        }

        /* ä½œå“æƒé‡å¯¹æ¯”è¡¨æ ¼ */
        .works-comparison-section {
            background: rgba(42, 42, 42, 0.92);
            border: 1px solid #555;
            padding: 25px;
            margin-bottom: 20px;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }

        .comparison-header:hover h2 {
            color: #ccc;
        }

        .comparison-header h2 {
            color: #fff;
            font-size: 22px;
            margin: 0;
        }

        .formula-box {
            background: #333;
            border-left: 3px solid #666;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.8;
            color: #ddd;
        }

        .formula-title {
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
        }

        .formula-item {
            margin: 5px 0;
            padding-left: 15px;
        }

        .formula-highlight {
            background: #555;
            padding: 2px 6px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #fff;
        }

        .comparison-table-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .comparison-table-container.expanded {
            max-height: 5000px;
        }

        .works-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .works-table thead {
            background: #555;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .works-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 12px;
        }

        .works-table tbody tr {
            border-bottom: 1px solid #444;
        }

        .works-table tbody tr:hover {
            background: #3a3a3a;
        }

        .works-table td {
            padding: 10px;
            color: #ddd;
        }

        .works-table .work-id {
            font-weight: bold;
            color: #fff;
        }

        .works-table .work-title {
            color: #ccc;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .weight-cell {
            font-weight: bold;
            font-size: 14px;
        }

        .weight-high-user {
            color: #FFA500;
        }

        .weight-low-user {
            color: #32CD32;
        }

        .weight-diff-positive {
            color: #28a745;
        }

        .weight-diff-negative {
            color: #dc3545;
        }

        .weight-diff-neutral {
            color: #999;
        }

        .works-grid::-webkit-scrollbar {
            width: 6px;
        }

        .works-grid::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        .works-grid::-webkit-scrollbar-thumb {
            background: #555;
        }

        @media (max-width: 768px) {
            .user-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .weight-details {
                grid-template-columns: 1fr;
            }

            .works-table {
                font-size: 11px;
            }

            .works-table th,
            .works-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·åæˆ–ID...">
                    <span class="search-icon">ğŸ”</span>
                </div>
                <select id="qualityFilter">
                    <option value="all">å…¨éƒ¨ç”¨æˆ·</option>
                    <option value="high">ä»… Qualified ç”¨æˆ·</option>
                    <option value="low">ä»…æ™®é€šç”¨æˆ·</option>
                </select>
                <select id="completionFilter">
                    <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="has-tasks">æœ‰ä»»åŠ¡çš„ç”¨æˆ·</option>
                    <option value="incomplete">æœªå®Œæˆä»»åŠ¡</option>
                    <option value="completed">å·²å®Œæˆç›®æ ‡</option>
                </select>
                <select id="sortBy">
                    <option value="completion">æŒ‰å®Œæˆåº¦æ’åº</option>
                    <option value="tasks">æŒ‰ä»»åŠ¡æ•°æ’åº</option>
                    <option value="quality">æŒ‰ç”¨æˆ·ç±»å‹æ’åº</option>
                    <option value="name">æŒ‰ç”¨æˆ·åæ’åº</option>
                </select>
                <button id="refreshBtn">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>
        </div>

        <div class="stats" id="stats">
            <!-- ç»Ÿè®¡å¡ç‰‡ä¼šåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- ä½œå“æƒé‡å¯¹æ¯”è¡¨æ ¼ -->
        <div class="works-comparison-section" id="worksComparisonSection" style="display: none;">
            <div class="comparison-header" onclick="toggleComparison()">
                <h2>ğŸ“Š ä½œå“æƒé‡å¯¹æ¯”è¡¨ (ç†è®ºæƒé‡)</h2>
                <span class="toggle-icon" id="comparisonToggleIcon">â–¼</span>
            </div>
            <div style="background: #2a2a2a; padding: 10px 15px; margin-bottom: 10px; border-left: 3px solid #FFA500; font-size: 12px; color: #FFA500;">
                âš ï¸ <strong>è¯´æ˜</strong>ï¼šæ­¤è¡¨æ˜¾ç¤ºæ‰€æœ‰ä½œå“çš„ç†è®ºæƒé‡ï¼ˆä¸è€ƒè™‘ç”¨æˆ·ä¸ªäººæƒ…å†µï¼‰ã€‚<br>
                å®é™…åˆ†é…æ—¶ä¼šæ’é™¤ï¼šç”¨æˆ·å·²è¯„è®ºçš„ä½œå“ã€å·²å®Œæˆçš„ä»»åŠ¡ã€ç”¨æˆ·è‡ªå·±çš„ä½œå“ã€‚<br>
                å› æ­¤ï¼Œæƒé‡é«˜çš„ä½œå“å¯èƒ½ä¸ä¼šè¢«åˆ†é…ç»™æŸäº›ç”¨æˆ·ã€‚
            </div>

            <div class="formula-box">
                <div class="formula-title">ğŸ”¬ æƒé‡è®¡ç®—æ–¹æ³•</div>
                <div class="formula-item">
                    <strong>æœŸæœ›è¯„åˆ†æ¨¡å‹</strong> (ä¸‰æ®µå¼å¢é•¿æ›²çº¿)
                    <br>â€¢ æ—©æœŸå¿«é€ŸæœŸ (0-5å¤©): æ¯å¤©1ä¸ªè¯„åˆ†ï¼Œè¾¾åˆ°5ä¸ª
                    <br>â€¢ ä¸­æœŸç¨³å®šæœŸ (6-14å¤©): æ¯å¤©0.78ä¸ªï¼Œä»5ä¸ªå¢è‡³12ä¸ª
                    <br>â€¢ åæœŸç¼“æ…¢æœŸ (15-30å¤©): æ¯å¤©0.5ä¸ªï¼Œä»12ä¸ªå¢è‡³20ä¸ª
                    <br>â€¢ è¶…æœŸä½œå“ (>30å¤©): æœŸæœ›è¾¾æ ‡20ä¸ªè¯„åˆ†
                </div>
                <div class="formula-item">
                    <strong>åŸºç¡€å†·é—¨æƒé‡</strong> = è¯„åˆ†ç¼ºå£æ¯”ä¾‹ Ã— 60 + æ—¶é—´ç´§è¿«åº¦åŠ æˆ
                    <br>â€¢ è¯„åˆ†ç¼ºå£æ¯”ä¾‹ = (æœŸæœ›è¯„åˆ† - å½“å‰è¯„åˆ†) / æœŸæœ›è¯„åˆ†
                    <br>â€¢ æ—¶é—´åŠ æˆ (å–æ»¡è¶³æ¡ä»¶çš„æœ€å¤§å€¼):
                    <br>&nbsp;&nbsp;3å¤©&lt;2è¯„ +15ï¼Œ5å¤©&lt;5è¯„ +20ï¼Œ7å¤©&lt;10è¯„ +30
                    <br>&nbsp;&nbsp;14å¤©&lt;15è¯„ +45ï¼Œ21å¤©&lt;18è¯„ +65ï¼Œ30å¤©&lt;20è¯„ +80
                </div>
                <div class="formula-item">
                    <strong>å‡è¡¡å› å­</strong> = æ ¹æ®ä½œå“å½“å‰é«˜ä½æƒé‡æ¯”ä¾‹åŠ¨æ€è°ƒæ•´
                    <br>â€¢ ç›®æ ‡æ¯”ä¾‹: <span class="formula-highlight">é«˜:ä½ = 1:2 (33.3%å æ¯”)</span>
                    <br>â€¢ å‡è¡¡åŒºé—´: <span class="formula-highlight">28%-45%</span> é«˜æƒé‡å æ¯”
                    <br>â€¢ é«˜æƒé‡è¿‡å¤š (>45%) â†’ Qualifiedç”¨æˆ· Ã—0.7ï¼Œæ™®é€šç”¨æˆ· Ã—1.3
                    <br>â€¢ é«˜æƒé‡ä¸è¶³ (&lt;28%) â†’ Qualifiedç”¨æˆ· Ã—1.3ï¼Œæ™®é€šç”¨æˆ· Ã—0.7
                    <br>â€¢ æ¯”ä¾‹å‡è¡¡ (28%-45%) â†’ æ‰€æœ‰ç”¨æˆ· Ã—1.0
                    <br>â€¢ åº”ç”¨æ—¶æœº: ä½œå“æœ‰â‰¥1ä¸ªè¯„åˆ†å³å¼€å§‹åº”ç”¨å‡è¡¡å› å­
                </div>
                <div class="formula-item">
                    <strong>æœ€ç»ˆä»»åŠ¡æƒé‡</strong> = <span class="formula-highlight">åŸºç¡€å†·é—¨æƒé‡ Ã— å‡è¡¡å› å­</span>
                    <br>â€¢ æœ€ç»ˆæƒé‡å†³å®šä½œå“åœ¨ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨ä¸­çš„æ’åºä½ç½®
                    <br>â€¢ æƒé‡è¶Šé«˜ï¼Œè¶Šå®¹æ˜“è¢«åˆ†é…ä¸ºä»»åŠ¡
                    <br>â€¢ ç†è®ºæœ€å¤§æƒé‡: ~182 (100%ç¼ºå£Ã—60+80åŠ æˆÃ—1.3å‡è¡¡)
                    <br>â€¢ è¯„åˆ†â‰¥20çš„ä½œå“æƒé‡ä¸º0ï¼Œä¸å†å‡ºç°åœ¨ä»»åŠ¡åˆ—è¡¨
                    <br>â€¢ <span style="color: #FFD700;">â­ åŒä¸€ä½œå“å¯¹ä¸åŒç”¨æˆ·æƒé‡ä¸åŒï¼</span>
                    <br>â€¢ æƒé‡æ— ä¸Šé™ï¼ŒçœŸå®åæ˜ ä½œå“å†·é—¨ç¨‹åº¦
                </div>
            </div>

            <div class="comparison-table-container expanded" id="comparisonTableContainer">
                <table class="works-table" id="worksComparisonTable">
                    <thead>
                        <tr>
                            <th>ä½œå“ID</th>
                            <th>ä½œå“æ ‡é¢˜</th>
                            <th>å¤©æ•°</th>
                            <th>è¯„åˆ†æ•°</th>
                            <th>é«˜/ä½è¯„åˆ†</th>
                            <th>æ¯”ä¾‹çŠ¶æ€</th>
                            <th>åŸºç¡€æƒé‡</th>
                            <th>Qualifiedæƒé‡</th>
                            <th>æ™®é€šæƒé‡</th>
                            <th>æƒé‡å·®å¼‚</th>
                        </tr>
                    </thead>
                    <tbody id="worksComparisonTableBody">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
            </div>
        </div>
    </div>

    <script>
        let allData = null;

        // ç›‘å¬æ¥è‡ªWixé¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (event.data.type === 'data') {
                allData = event.data.data;
                renderUsers(allData.users);
                updateStats(allData.stats);
                renderWorksComparison(allData.worksComparison);
            } else if (event.data.type === 'loading') {
                showLoading(event.data.message);
            } else if (event.data.type === 'error') {
                showError(event.data.message);
            } else if (event.data.type === 'refreshing') {
                // åˆ·æ–°ä¸­ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const button = document.querySelector(`[data-user-id="${event.data.userId}"]`);
                if (button) {
                    button.disabled = true;
                    button.textContent = 'â³ åˆ·æ–°ä¸­...';
                }
            } else if (event.data.type === 'refreshSuccess') {
                // åˆ·æ–°æˆåŠŸ
                showNotification('âœ… ' + event.data.message, 'success');
                // æ•°æ®ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½ï¼ŒæŒ‰é’®ä¼šåœ¨é‡æ–°æ¸²æŸ“æ—¶æ¢å¤
            } else if (event.data.type === 'refreshError') {
                // åˆ·æ–°å¤±è´¥
                showNotification('âŒ ' + event.data.message, 'error');
                const button = document.querySelector(`[data-user-id="${event.data.userId}"]`);
                if (button) {
                    button.disabled = false;
                    button.textContent = 'ğŸ”„ åˆ·æ–°ä»»åŠ¡';
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆï¼Œé€šçŸ¥Wixå‡†å¤‡æ¥æ”¶æ•°æ®
        window.onload = () => {
            window.parent.postMessage({ action: 'ready' }, '*');
        };

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers(users) {
            const content = document.getElementById('content');

            if (users.length === 0) {
                content.innerHTML = '<div class="no-data">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·</div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'users-grid';

            users.forEach(user => {
                const card = createUserCard(user);
                grid.appendChild(card);
            });

            content.innerHTML = '';
            content.appendChild(grid);
        }

        // åˆ›å»ºç”¨æˆ·å¡ç‰‡
        function createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'user-card';

            // å¤„ç†å¤´åƒ
            const avatarHtml = user.profileImageUrl && user.profileImageUrl.trim() !== ''
                ? `<img src="${user.profileImageUrl}" alt="å¤´åƒ">`
                : user.userName.substring(0, 2).toUpperCase();

            // ç”¨æˆ·è´¨é‡å¾½ç« 
            const qualityBadgeClass = user.isHighQuality ? 'quality-high' : 'quality-low';
            const qualityText = user.isHighQuality ? 'Qualified' : 'æ™®é€š';

            // å®Œæˆåº¦çŠ¶æ€
            const completionPercent = (user.completedCount / user.targetCompletion * 100).toFixed(0);
            let progressClass = 'progress-low';
            let hasCompletedTarget = false;
            if (user.completedCount >= user.targetCompletion) {
                progressClass = 'progress-complete';
                hasCompletedTarget = true;
            } else if (user.completedCount >= user.targetCompletion * 0.5) {
                progressClass = 'progress-active';
            }

            // ç”¨æˆ·é“¾æ¥
            const userLink = user.userSlug ? `/profile/${user.userSlug}` : '#';
            const userNameHtml = user.userSlug
                ? `<a href="${userLink}" target="_blank" style="color: #FFD700; text-decoration: none;">${user.userName}</a>`
                : user.userName;

            // ä»»åŠ¡åˆ—è¡¨HTML
            const tasksHtml = user.currentTasks && user.currentTasks.length > 0
                ? user.currentTasks.map(task => createTaskItemHtml(task, user.isHighQuality, hasCompletedTarget)).join('')
                : `<div class="no-tasks">ğŸ‰ å½“å‰æ— ${hasCompletedTarget ? 'å†·é—¨ä½œå“' : 'ä»»åŠ¡'}ï¼ˆå·²å®Œæˆæˆ–ç­‰å¾…åˆ·æ–°ï¼‰</div>`;

            // å·²å®Œæˆä»»åŠ¡ä½œå“åˆ—è¡¨
            const completedTasksHtml = user.completedTasks && user.completedTasks.length > 0
                ? user.completedTasks.map(workNum =>
                    `<div class="work-item" title="ä»»åŠ¡å®Œæˆä½œå“ #${workNum}">#${workNum}</div>`
                ).join('')
                : '<div class="empty-list">æš‚æ— å®Œæˆè®°å½•</div>';

            // è‡ªä¸»è¯„è®ºä½œå“åˆ—è¡¨
            const freeRatingsHtml = user.freeRatings && user.freeRatings.length > 0
                ? user.freeRatings.map(workNum =>
                    `<div class="work-item work-item-free" title="è‡ªä¸»è¯„è®ºä½œå“ #${workNum}">#${workNum}</div>`
                ).join('')
                : '<div class="empty-list">æš‚æ— è‡ªä¸»è¯„è®º</div>';

            card.innerHTML = `
                <div class="user-header">
                    <div class="user-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="user-info">
                        <div class="user-name">
                            ${userNameHtml}
                            <span class="quality-badge ${qualityBadgeClass}">${qualityText}</span>
                            ${hasCompletedTarget ? '<span class="quality-badge" style="background: #28a745; color: #fff;">âœ“ å·²å®Œæˆç›®æ ‡</span>' : ''}
                            <button class="btn-refresh-user" data-user-id="${user.userId}" onclick="refreshUserTask(this)">ğŸ”„ åˆ·æ–°ä»»åŠ¡</button>
                        </div>
                        <div class="user-stats">
                            <div class="stat-item">
                                <span>ğŸ“Š è¿›åº¦:</span>
                                <span class="progress-mini ${progressClass}">${user.completedCount}/${user.targetCompletion} (${completionPercent}%)</span>
                            </div>
                            <div class="stat-item">
                                <span>ğŸ“‹ å½“å‰${hasCompletedTarget ? 'å†·é—¨' : 'ä»»åŠ¡'}:</span>
                                <strong>${user.currentTasks?.length || 0} ä¸ª</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tasks-section">
                    <div class="tasks-header" onclick="toggleTasks(this)">
                        <span class="toggle-icon">â–¶</span>
                        <span>å½“å‰${hasCompletedTarget ? 'å†·é—¨ä½œå“' : 'ä»»åŠ¡'}è¯¦æƒ… (${user.currentTasks?.length || 0}ä¸ª)</span>
                    </div>
                    <div class="tasks-list">
                        ${tasksHtml}
                    </div>
                </div>
                <div class="completed-section">
                    <div class="completed-title">
                        <span>âœ… å·²å®Œæˆä»»åŠ¡ä½œå“ (${user.completedTasks?.length || 0})</span>
                    </div>
                    <div class="works-grid">
                        ${completedTasksHtml}
                    </div>
                </div>
                <div class="completed-section">
                    <div class="completed-title">
                        <span>ğŸ’¬ è‡ªä¸»è¯„è®ºä½œå“ (${user.freeRatings?.length || 0})</span>
                    </div>
                    <div class="works-grid">
                        ${freeRatingsHtml}
                    </div>
                </div>
            `;

            return card;
        }

        // åˆ›å»ºä»»åŠ¡é¡¹HTML
        function createTaskItemHtml(task, isUserHighQuality, hasCompletedTarget) {
            // é«˜ä½æƒé‡æ¯”ä¾‹
            const highPercent = task.currentRatings > 0
                ? (task.highWeightCount / task.currentRatings * 100).toFixed(0)
                : 0;
            const lowPercent = task.currentRatings > 0
                ? (task.lowWeightCount / task.currentRatings * 100).toFixed(0)
                : 0;

            const ratioText = task.lowWeightCount > 0
                ? `${task.ratio.toFixed(2)}:1`
                : (task.highWeightCount > 0 ? 'ä»…é«˜æƒé‡' : 'æ— è¯„åˆ†');

            const ratioStatusClass = task.ratioStatus === 'å‡è¡¡' ? 'ratio-balanced' : 'ratio-unbalanced';

            // å‡è¡¡å› å­æ ·å¼
            let balanceClass = 'balance-neutral';
            let balanceText = 'Ã—1.0 (æ— è°ƒæ•´)';
            if (task.balanceFactor > 1.0) {
                balanceClass = 'balance-increase';
                balanceText = `Ã—${task.balanceFactor.toFixed(2)} (æé«˜)`;
            } else if (task.balanceFactor < 1.0) {
                balanceClass = 'balance-decrease';
                balanceText = `Ã—${task.balanceFactor.toFixed(2)} (é™ä½)`;
            }

            // æƒé‡å˜åŒ–è¯´æ˜
            let weightExplanation = '';
            const taskTypeText = hasCompletedTarget ? 'å†·é—¨ä½œå“æƒé‡' : 'ä»»åŠ¡æƒé‡';
            if (task.balanceFactor !== 1.0) {
                if (isUserHighQuality) {
                    if (task.ratioStatus === 'é«˜æƒé‡è¿‡å¤š') {
                        weightExplanation = `âš  è¯¥ä½œå“é«˜æƒé‡è¯„åˆ†è¿‡å¤šï¼Œé™ä½æ‚¨çš„${taskTypeText}ä»¥å¼•å¯¼ä½æƒé‡ç”¨æˆ·è¯„åˆ†`;
                    } else if (task.ratioStatus === 'é«˜æƒé‡ä¸è¶³') {
                        weightExplanation = `â­ è¯¥ä½œå“éœ€è¦æ›´å¤šé«˜æƒé‡è¯„åˆ†ï¼Œæé«˜æ‚¨çš„${taskTypeText}`;
                    }
                } else {
                    if (task.ratioStatus === 'é«˜æƒé‡è¿‡å¤š') {
                        weightExplanation = `â­ è¯¥ä½œå“é«˜æƒé‡è¯„åˆ†è¿‡å¤šï¼Œæé«˜æ‚¨çš„${taskTypeText}ä»¥å¹³è¡¡æ¯”ä¾‹`;
                    } else if (task.ratioStatus === 'é«˜æƒé‡ä¸è¶³') {
                        weightExplanation = `âš  è¯¥ä½œå“éœ€è¦é«˜æƒé‡è¯„åˆ†ï¼Œé™ä½æ‚¨çš„${taskTypeText}`;
                    }
                }
            }

            return `
                <div class="task-item">
                    <div class="task-work-header">
                        <div>
                            <span class="task-work-id">#${task.workNumber}</span>
                            <span class="task-work-title">${task.workTitle}</span>
                        </div>
                        <span class="weight-badge">æœ€ç»ˆæƒé‡: ${task.finalWeight}</span>
                    </div>
                    
                    <div class="weight-details">
                        <div class="weight-detail-item">
                            <span class="weight-label">åŸºç¡€å†·é—¨æƒé‡:</span>
                            <span class="weight-value">${task.baseWeight}</span>
                        </div>
                        <div class="weight-detail-item">
                            <span class="weight-label">å‡è¡¡å› å­:</span>
                            <span class="balance-factor ${balanceClass}">${balanceText}</span>
                        </div>
                        <div class="weight-detail-item">
                            <span class="weight-label">å½“å‰è¯„åˆ†:</span>
                            <span class="weight-value">${task.currentRatings} ä¸ª (ç›®æ ‡20)</span>
                        </div>
                        <div class="weight-detail-item">
                            <span class="weight-label">æäº¤å¤©æ•°:</span>
                            <span class="weight-value">${task.daysSinceSubmission} å¤©</span>
                        </div>
                    </div>
                    
                    <div class="ratio-info">
                        <span style="font-size: 11px; color: #666;">é«˜ä½æƒé‡åˆ†å¸ƒ:</span>
                        <div class="ratio-bar">
                            ${task.highWeightCount > 0 ? `<div class="ratio-high" style="width: ${highPercent}%">${task.highWeightCount}äºº</div>` : ''}
                            ${task.lowWeightCount > 0 ? `<div class="ratio-low" style="width: ${lowPercent}%">${task.lowWeightCount}äºº</div>` : ''}
                        </div>
                        <span style="font-size: 12px; font-weight: bold;">${ratioText}</span>
                        <span class="ratio-status ${ratioStatusClass}">${task.ratioStatus}</span>
                    </div>
                    
                    ${weightExplanation ? `<div style="margin-top: 8px; padding: 8px; background: #2a2a2a; font-size: 11px; color: #87CEEB;">${weightExplanation}</div>` : ''}
                </div>
            `;
        }

        // åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
        function toggleTasks(header) {
            const icon = header.querySelector('.toggle-icon');
            const list = header.nextElementSibling;

            icon.classList.toggle('expanded');
            list.classList.toggle('expanded');
        }

        // åˆ‡æ¢ä½œå“æƒé‡å¯¹æ¯”è¡¨æ ¼æ˜¾ç¤º
        function toggleComparison() {
            const container = document.getElementById('comparisonTableContainer');
            const icon = document.getElementById('comparisonToggleIcon');

            container.classList.toggle('expanded');
            icon.textContent = container.classList.contains('expanded') ? 'â–¼' : 'â–¶';
        }

        // æ¸²æŸ“ä½œå“æƒé‡å¯¹æ¯”è¡¨æ ¼
        function renderWorksComparison(worksComparison) {
            if (!worksComparison || !worksComparison.works) {
                document.getElementById('worksComparisonSection').style.display = 'none';
                return;
            }

            document.getElementById('worksComparisonSection').style.display = 'block';

            const tbody = document.getElementById('worksComparisonTableBody');
            tbody.innerHTML = '';

            worksComparison.works.forEach(work => {
                const row = document.createElement('tr');

                // æ¯”ä¾‹çŠ¶æ€æ ·å¼
                const ratioStatusClass = work.ratioStatus === 'å‡è¡¡' ? 'ratio-balanced' : 'ratio-unbalanced';

                // æƒé‡å·®å¼‚æ ·å¼
                let diffClass = 'weight-diff-neutral';
                let diffSymbol = '';
                if (work.weightDifference > 0) {
                    diffClass = 'weight-diff-positive';
                    diffSymbol = '+';
                } else if (work.weightDifference < 0) {
                    diffClass = 'weight-diff-negative';
                }

                // å‡è¡¡å› å­æ˜¾ç¤º
                const factorHighText = work.balanceFactorHigh === 1.0
                    ? 'Ã—1.0'
                    : (work.balanceFactorHigh > 1.0 ? `Ã—${work.balanceFactorHigh.toFixed(1)}â†‘` : `Ã—${work.balanceFactorHigh.toFixed(1)}â†“`);

                const factorLowText = work.balanceFactorLow === 1.0
                    ? 'Ã—1.0'
                    : (work.balanceFactorLow > 1.0 ? `Ã—${work.balanceFactorLow.toFixed(1)}â†‘` : `Ã—${work.balanceFactorLow.toFixed(1)}â†“`);

                row.innerHTML = `
                    <td><span class="work-id">#${work.sequenceId}</span></td>
                    <td><span class="work-title" title="${work.title}">${work.title}</span></td>
                    <td>${work.daysSinceSubmission}å¤©</td>
                    <td>${work.currentRatings}/20</td>
                    <td>${work.highWeightCount}/${work.lowWeightCount}</td>
                    <td><span class="ratio-status ${ratioStatusClass}">${work.ratioStatus}</span></td>
                    <td>${work.baseWeight}</td>
                    <td class="weight-cell weight-high-user">
                        ${work.finalWeightHigh}
                        <small style="color: #999;">${factorHighText}</small>
                    </td>
                    <td class="weight-cell weight-low-user">
                        ${work.finalWeightLow}
                        <small style="color: #999;">${factorLowText}</small>
                    </td>
                    <td class="${diffClass}">
                        ${diffSymbol}${work.weightDifference}
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // åˆ·æ–°å•ä¸ªç”¨æˆ·çš„ä»»åŠ¡
        function refreshUserTask(button) {
            const userId = button.getAttribute('data-user-id');

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåˆ·æ–°ä¸­
            button.disabled = true;
            button.textContent = 'â³ åˆ·æ–°ä¸­...';

            // å‘é€åˆ·æ–°è¯·æ±‚
            window.parent.postMessage({
                action: 'refreshUserTask',
                userId: userId
            }, '*');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(stats) {
            if (!stats || !stats.totalUsers) {
                document.getElementById('stats').innerHTML = '';
                return;
            }

            const targetRatioText = `1:${(1 / stats.targetRatio).toFixed(1)}`;

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <h3>æ€»ç”¨æˆ·æ•°</h3>
                    <div class="number">${stats.totalUsers}</div>
                </div>
                <div class="stat-card">
                    <h3>Qualified ç”¨æˆ·</h3>
                    <div class="number" style="color: #FFA500;">${stats.highQualityUsers || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>æ™®é€šç”¨æˆ·</h3>
                    <div class="number" style="color: #32CD32;">${stats.lowQualityUsers || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>ç›®æ ‡æ¯”ä¾‹</h3>
                    <div class="number" style="font-size: 24px;">${targetRatioText}</div>
                </div>
                <div class="stat-card">
                    <h3>å®¹å¿åº¦</h3>
                    <div class="number" style="font-size: 24px;">Â±${(stats.tolerance * 100).toFixed(0)}%</div>
                </div>
            `;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(message) {
            document.getElementById('content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="error">
                    <p>âŒ ${message}</p>
                </div>
            `;
        }

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', (e) => {
            window.parent.postMessage({
                action: 'filter',
                filterType: 'search',
                value: e.target.value
            }, '*');
        });

        // ç”¨æˆ·è´¨é‡ç­›é€‰
        document.getElementById('qualityFilter').addEventListener('change', (e) => {
            window.parent.postMessage({
                action: 'filter',
                filterType: 'quality',
                value: e.target.value
            }, '*');
        });

        // å®Œæˆåº¦ç­›é€‰
        document.getElementById('completionFilter').addEventListener('change', (e) => {
            window.parent.postMessage({
                action: 'filter',
                filterType: 'completion',
                value: e.target.value
            }, '*');
        });

        // æ’åº
        document.getElementById('sortBy').addEventListener('change', (e) => {
            window.parent.postMessage({
                action: 'sort',
                sortBy: e.target.value
            }, '*');
        });

        // åˆ·æ–°æ•°æ®
        document.getElementById('refreshBtn').addEventListener('click', () => {
            window.parent.postMessage({
                action: 'refresh'
            }, '*');
        });

        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: bold;
                font-size: 14px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;

            if (type === 'success') {
                notification.style.background = '#d4edda';
                notification.style.color = '#28a745';
                notification.style.border = '2px solid #28a745';
            } else {
                notification.style.background = '#f8d7da';
                notification.style.color = '#dc3545';
                notification.style.border = '2px solid #dc3545';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</body>

</html>