<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»»åŠ¡åˆ†é…æ±‡æ€»</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: rgba(0, 0, 0, 0);
      color: #f2f2f2;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      background: rgba(42, 42, 42, 0.92);
      border: 1px solid #555;
      padding: 20px 24px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 800;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header .sub {
      color: #c7c7c7;
      font-size: 13px;
      line-height: 1.6;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: rgba(42, 42, 42, 0.92);
      border: 1px solid #555;
      padding: 18px;
    }

    .stat-label {
      color: #a5a5a5;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: #fff;
    }

    .stat-extra {
      color: #888;
      font-size: 12px;
      margin-top: 4px;
    }

    .table-wrap {
      background: rgba(42, 42, 42, 0.92);
      border: 1px solid #555;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #555;
      color: #fff;
    }

    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #444;
      text-align: left;
    }

    tbody tr:hover {
      background: #353535;
    }

    tbody tr.top-row {
      background: rgba(255, 215, 0, 0.08);
    }

    tbody tr.active-row {
      outline: 2px solid #FFA500;
      background: rgba(255, 165, 0, 0.12);
    }

    .work-id {
      font-weight: 800;
      color: #fff;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      background: #1f6feb;
      color: #fff;
    }

    .badge.muted {
      background: #666;
      color: #f7f7f7;
    }

    .title {
      color: #d6d6d6;
      max-width: 420px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .empty {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 14px;
      background: rgba(42, 42, 42, 0.92);
      border: 1px solid #555;
    }

    .state {
      padding: 60px 20px;
      text-align: center;
      background: rgba(42, 42, 42, 0.92);
      border: 1px solid #555;
      color: #d1d1d1;
      font-size: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #444;
      border-top: 4px solid #ccc;
      border-radius: 50%;
      margin: 0 auto 14px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 768px) {
      th, td {
        padding: 10px 8px;
        font-size: 12px;
      }

      .title {
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“¦ ä½œå“ä»»åŠ¡åˆ†é…æ±‡æ€»</h1>
      <div class="sub">æŒ‰ä½œå“ç»Ÿè®¡å½“å‰æœ‰å¤šå°‘ç”¨æˆ·åŒæ—¶æŒæœ‰è¯¥ä½œå“ä½œä¸ºä»»åŠ¡ï¼Œä¾¿äºå‘ç°è¢«é¢‘ç¹æ¨é€çš„ä½œå“ã€‚</div>
    </div>

    <div id="stats" class="stats" style="display:none;"></div>

    <div id="content">
      <div class="state">
        <div class="spinner"></div>
        æ­£åœ¨ç­‰å¾…æ•°æ®...
      </div>
    </div>
  </div>

  <script>
    let summaryData = null;
    let activeWorkNumber = null;

    window.addEventListener('message', (event) => {
      if (event.data.type === 'summary') {
        renderSummary(event.data.data);
      } else if (event.data.type === 'loading') {
        showLoading(event.data.message);
      } else if (event.data.type === 'error') {
        showError(event.data.message);
      }
    });

    window.onload = () => {
      window.parent.postMessage({ action: 'ready' }, '*');
    };

    function renderSummary(data) {
      summaryData = data;
      const items = (data && data.items) ? data.items : [];

      if (!items.length) {
        document.getElementById('stats').style.display = 'none';
        document.getElementById('content').innerHTML = '<div class="empty">å½“å‰æ²¡æœ‰ä½œå“è¢«åˆ†é…åˆ°ä»»åŠ¡</div>';
        return;
      }

      updateStats(data.totals || {}, items);
      renderTable(items);
    }

    function updateStats(totals, items) {
      const totalAssignments = totals.totalAssignments || 0;
      const uniqueWorks = totals.uniqueWorks || 0;
      const avg = uniqueWorks > 0 ? (totalAssignments / uniqueWorks).toFixed(1) : '0.0';
      const topItem = items[0] || null;

      const statsHtml = `
        <div class="stat-card">
          <div class="stat-label">æ€»æŒæœ‰äººæ¬¡</div>
          <div class="stat-value">${totalAssignments}</div>
          <div class="stat-extra">å½“å‰æ‰€æœ‰ä»»åŠ¡æ§½ä½çš„å ç”¨æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ¶‰åŠä½œå“æ•°</div>
          <div class="stat-value">${uniqueWorks}</div>
          <div class="stat-extra">è‡³å°‘è¢«ä¸€ä¸ªç”¨æˆ·æŒæœ‰çš„ä½œå“æ•°é‡</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å¹³å‡æ¯ä½œæŒæœ‰äºº</div>
          <div class="stat-value">${avg}</div>
          <div class="stat-extra">æ€»æŒæœ‰äººæ¬¡ / ä½œå“æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœ€é«˜å ç”¨ä½œå“</div>
          <div class="stat-value" style="font-size:22px;">
            ${topItem ? '#' + topItem.workNumber : '-'}
          </div>
          <div class="stat-extra">
            ${topItem ? escapeHtml(topItem.workTitle || 'æœªå‘½åä½œå“') + ' Â· ' + topItem.assignedCount + ' äººæŒæœ‰' : 'æš‚æ— æ•°æ®'}
          </div>
        </div>
      `;

      const statsEl = document.getElementById('stats');
      statsEl.innerHTML = statsHtml;
      statsEl.style.display = 'grid';
    }

    function renderTable(items) {
      const tbodyHtml = items.map((item, index) => {
        const highlight = index < 3 ? 'top-row' : '';
        const title = escapeHtml(item.workTitle || 'æœªå‘½åä½œå“');
        const ratings = item.currentRatings || 0;
        const baseWeight = item.baseWeight || 0;
        const days = item.daysSinceSubmission || 0;
        const isActive = activeWorkNumber === item.workNumber;

        return `
          <tr class="${highlight} ${isActive ? 'active-row' : ''}" data-work="${item.workNumber}">
            <td><span class="work-id">#${item.workNumber}</span></td>
            <td><span class="title" title="${title}">${title}</span></td>
            <td><span class="badge">${item.assignedCount} äºº</span></td>
            <td>${ratings}/15</td>
            <td>${days} å¤©</td>
            <td><span class="badge muted">${baseWeight}</span></td>
          </tr>
        `;
      }).join('');

      const tableHtml = `
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ä½œå“ID</th>
                <th>ä½œå“æ ‡é¢˜</th>
                <th>å½“å‰æŒæœ‰äººæ•°</th>
                <th>å½“å‰è¯„åˆ†</th>
                <th>æäº¤å¤©æ•°</th>
                <th>åŸºç¡€å†·é—¨æƒé‡</th>
              </tr>
            </thead>
            <tbody>
              ${tbodyHtml}
            </tbody>
          </table>
        </div>
      `;

      const contentEl = document.getElementById('content');
      contentEl.innerHTML = tableHtml;

      // ç»‘å®šè¡Œç‚¹å‡»äº‹ä»¶ -> å‘é€ç­›é€‰è¯·æ±‚
      const rows = contentEl.querySelectorAll('tr[data-work]');
      rows.forEach((row) => {
        row.addEventListener('click', () => {
          const workNumber = Number(row.getAttribute('data-work'));
          const target = activeWorkNumber === workNumber ? null : workNumber;
          activeWorkNumber = target;
          window.parent.postMessage(
            {
              action: 'filterByWork',
              workNumber: target,
            },
            '*'
          );
          // ç«‹å³æœ¬åœ°é«˜äº®
          rows.forEach((r) => r.classList.remove('active-row'));
          if (target !== null) {
            row.classList.add('active-row');
          }
        });
      });
    }

    // æ¥æ”¶æ¥è‡ªçˆ¶çº§çš„æ¿€æ´»ä½œå“é€šçŸ¥ï¼ˆä¿æŒé«˜äº®åŒæ­¥ï¼‰
    window.addEventListener('message', (event) => {
      if (event.data.type === 'activeWork') {
        activeWorkNumber = event.data.workNumber || null;
        // é‡æ–°é«˜äº®
        const rows = document.querySelectorAll('tr[data-work]');
        rows.forEach((row) => {
          const num = Number(row.getAttribute('data-work'));
          if (activeWorkNumber !== null && num === activeWorkNumber) {
            row.classList.add('active-row');
          } else {
            row.classList.remove('active-row');
          }
        });
      }
    });

    function showLoading(message) {
      document.getElementById('content').innerHTML = `
        <div class="state">
          <div class="spinner"></div>
          ${message || 'æ­£åœ¨åŠ è½½...'}
        </div>
      `;
    }

    function showError(message) {
      document.getElementById('content').innerHTML = `
        <div class="state" style="color:#f87171;">
          âŒ ${message || 'åŠ è½½å¤±è´¥'}
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
  </script>
</body>
</html>
