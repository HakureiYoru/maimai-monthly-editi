<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯„è®ºç³»ç»Ÿ</title>
  <!-- Markdownè§£æåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      padding: 20px;
      min-height: 100vh;
      background: transparent;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* æ¯›ç»ç’ƒå¡ç‰‡ */
    .glass-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }

    /* è¯„è®ºè¾“å…¥åŒºåŸŸ */
    .comment-input-section {
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 20px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .input-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-label {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
    }

    .input-field {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      transition: all 0.3s;
    }

    .input-field:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .input-field::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .input-field:disabled {
      background: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
    }

    select.input-field {
      cursor: pointer;
    }

    select.input-field option {
      background: #333;
      color: #fff;
    }

    textarea.input-field {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .submit-button {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.9) 0%, rgba(255, 165, 0, 0.9) 100%);
      color: #fff;
      border: none;
      padding: 14px 32px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 4px 20px rgba(255, 165, 0, 0.3);
      transition: all 0.3s ease;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .submit-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(255, 165, 0, 0.4);
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    }

    .submit-button:active:not(:disabled) {
      transform: translateY(0);
    }

    .submit-button:disabled {
      background: rgba(255, 255, 255, 0.3);
      color: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
      box-shadow: none;
    }

    .work-status-info {
      margin-top: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      font-size: 14px;
      color: #fff;
      text-align: center;
      font-weight: 600;
      line-height: 1.6;
    }

    .work-status-info.task {
      background: linear-gradient(135deg, rgba(0, 102, 255, 0.4) 0%, rgba(0, 82, 204, 0.4) 100%);
      border: 1px solid rgba(0, 102, 255, 0.6);
    }

    .work-status-info.cold-work {
      background: linear-gradient(135deg, rgba(255, 165, 0, 0.4) 0%, rgba(255, 140, 0, 0.4) 100%);
      border: 1px solid rgba(255, 165, 0, 0.6);
    }

    .work-status-info.completed-task {
      background: linear-gradient(135deg, rgba(34, 139, 34, 0.4) 0%, rgba(46, 125, 50, 0.4) 100%);
      border: 1px solid rgba(34, 139, 34, 0.6);
    }

    .work-status-info.author {
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.4) 0%, rgba(123, 31, 162, 0.4) 100%);
      border: 1px solid rgba(138, 43, 226, 0.6);
    }

    .submit-status {
      margin-top: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      font-size: 14px;
      color: #fff;
      text-align: center;
      display: none;
      font-weight: 600;
      line-height: 1.6;
    }

    .submit-status.show {
      display: block;
    }

    /* ç­›é€‰åŒºåŸŸ */
    .filter-section {
      margin-bottom: 20px;
    }

    .filter-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-tab:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    .filter-tab.active {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.6) 0%, rgba(255, 165, 0, 0.6) 100%);
      border-color: rgba(255, 215, 0, 0.8);
    }

    /* åˆ†é¡µå™¨ */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }

    .page-button {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .page-button:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.4);
    }

    .page-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-info {
      color: #fff;
      font-size: 14px;
      font-weight: 600;
    }

    /* è¯„è®ºåˆ—è¡¨ */
    .comment-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .comment-item {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      transition: all 0.3s;
    }

    .comment-item:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .comment-score-badge {
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      min-width: 60px;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .comment-work-title {
      font-size: 15px;
      color: #fff;
      font-weight: 600;
      flex: 1;
      min-width: 200px;
    }

    .comment-rating-info {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 10px;
    }

    .comment-content {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 12px;
      color: #fff;
      font-size: 14px;
      line-height: 1.6;
      max-height: 120px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .comment-content:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .comment-content.expanded {
      max-height: none;
      overflow-y: auto;
    }

    .comment-content.has-overflow::after {
      content: 'ç‚¹å‡»å±•å¼€';
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.8), transparent);
      padding: 8px;
      text-align: center;
      font-size: 12px;
      color: rgba(0, 0, 0, 0.7);
      font-weight: 600;
    }

    .comment-content.expanded::after {
      content: 'ç‚¹å‡»æ”¶èµ·';
      position: relative;
      background: rgba(255, 255, 255, 0.3);
      margin-top: 10px;
      display: block;
    }

    .comment-content.short {
      cursor: default;
    }

    .comment-content.short::after {
      display: none;
    }
    .comment-content::-webkit-scrollbar {
      width: 6px;
    }

    .comment-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .comment-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    /* Markdownå†…å®¹æ ·å¼ */
    .comment-content h1,
    .comment-content h2,
    .comment-content h3,
    .comment-content h4,
    .comment-content h5,
    .comment-content h6 {
      margin: 12px 0 8px 0;
      font-weight: 700;
      color: #fff;
    }

    .comment-content h1 { font-size: 20px; }
    .comment-content h2 { font-size: 18px; }
    .comment-content h3 { font-size: 16px; }
    .comment-content h4 { font-size: 15px; }
    .comment-content h5 { font-size: 14px; }
    .comment-content h6 { font-size: 13px; }

    .comment-content p {
      margin: 8px 0;
    }

    .comment-content a {
      color: #FFD700;
      text-decoration: underline;
      font-weight: 600;
    }

    .comment-content a:hover {
      color: #FFA500;
    }

    .comment-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: block;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .comment-content img:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    /* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„æ ·å¼ */
    .comment-content img[alt]::before {
      content: 'ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥';
      display: block;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
    }

    .comment-content blockquote {
      border-left: 3px solid rgba(255, 215, 0, 0.6);
      padding-left: 12px;
      margin: 10px 0;
      color: rgba(255, 255, 255, 0.9);
      font-style: italic;
    }

    .comment-content code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #FFD700;
    }

    .comment-content pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .comment-content pre code {
      background: none;
      padding: 0;
      color: #fff;
    }

    .comment-content ul,
    .comment-content ol {
      margin: 8px 0;
      padding-left: 24px;
    }

    .comment-content li {
      margin: 4px 0;
    }

    .comment-content hr {
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      margin: 12px 0;
    }

    .comment-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    .comment-content th,
    .comment-content td {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px;
      text-align: left;
    }

    .comment-content th {
      background: rgba(255, 255, 255, 0.2);
      font-weight: 700;
    }

    .comment-content strong {
      font-weight: 700;
      color: #FFD700;
    }

    .comment-content em {
      font-style: italic;
      color: rgba(255, 255, 255, 0.95);
    }

    .comment-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 10px;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: translateY(-1px);
    }

    .action-btn.delete {
      background: rgba(211, 47, 47, 0.4);
      border-color: rgba(244, 67, 54, 0.6);
    }

    .action-btn.delete:hover {
      background: rgba(244, 67, 54, 0.6);
    }

    .reply-count {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 10px;
      border-radius: 8px;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #fff;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 500;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .no-comments {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .glass-card {
        padding: 20px;
      }

      .input-row, .filter-row {
        grid-template-columns: 1fr;
      }

      .comment-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- è¯„è®ºè¾“å…¥åŒºåŸŸ -->
    <div class="glass-card comment-input-section">
      <div class="section-title">æäº¤è¯„è®º</div>
      
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">é€‰æ‹©ä½œå“</label>
          <select class="input-field" id="inputNumber">
            <option value="">è¯·é€‰æ‹©ä½œå“ç¼–å·</option>
          </select>
        </div>
        <div class="input-group">
          <label class="input-label">è¯„åˆ† (100-1000)</label>
          <input type="number" class="input-field" id="inputScore" 
                 placeholder="è¾“å…¥è¯„åˆ†" min="100" max="1000" step="1" required>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">è¯„è®ºå†…å®¹ <span style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: normal;">ï¼ˆæ”¯æŒMarkdownæ ¼å¼å’Œå›¾ç‰‡é“¾æ¥ï¼‰</span></label>
        <textarea class="input-field" id="Comment" 
                  placeholder="è¾“å…¥æ‚¨çš„è¯„è®º... æ”¯æŒMarkdownæ ¼å¼&#10;&#10;ç¤ºä¾‹ï¼š&#10;**ç²—ä½“** *æ–œä½“*&#10;![å›¾ç‰‡](https://example.com/image.jpg)&#10;[é“¾æ¥](https://example.com)"></textarea>
      </div>

      <div style="margin-top: 20px;">
        <button class="submit-button" id="submitBtn">æäº¤è¯„è®º</button>
      </div>

      <!-- ä½œå“é€‰æ‹©åçš„çŠ¶æ€æç¤º -->
      <div class="work-status-info" id="workStatusInfo" style="display: none;"></div>

      <!-- æäº¤çŠ¶æ€æç¤º -->
      <div class="submit-status" id="submitStatus"></div>
    </div>

    <!-- è¯„è®ºç­›é€‰å’Œåˆ—è¡¨åŒºåŸŸ -->
    <div class="glass-card">
      <div class="section-title">è¯„è®ºåˆ—è¡¨</div>

      <!-- ç­›é€‰å™¨ -->
      <div class="filter-section">
        <div class="filter-row">
          <div class="input-group">
            <label class="input-label">ç­›é€‰ä½œå“</label>
            <select class="input-field" id="dropdownFilter">
              <option value="">æ˜¾ç¤ºæ‰€æœ‰è¯„è®º</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label class="input-label">è¯„è®ºç±»å‹</label>
          <div class="filter-tabs">
            <div class="filter-tab active" data-filter="default">æ‰€æœ‰è¯„è®º</div>
            <div class="filter-tab" data-filter="ScoreOnly">ä»…è¯„åˆ†</div>
            <div class="filter-tab" data-filter="YourComment">ä»…ä½ çš„è¯„è®º</div>
          </div>
        </div>
      </div>

      <!-- åˆ†é¡µå™¨ï¼ˆé¡¶éƒ¨ï¼‰ -->
      <div class="pagination" id="paginationTop">
        <button class="page-button" id="prevBtnTop">ä¸Šä¸€é¡µ</button>
        <span class="page-info" id="pageInfoTop">ç¬¬ 1 / 1 é¡µ</span>
        <button class="page-button" id="nextBtnTop">ä¸‹ä¸€é¡µ</button>
      </div>

      <!-- åŠ è½½çŠ¶æ€ -->
      <div class="loading" id="loadingState" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">åŠ è½½è¯„è®ºä¸­...</div>
      </div>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div class="comment-list" id="commentList"></div>

      <!-- æ— è¯„è®ºæç¤º -->
      <div class="no-comments" id="noComments" style="display: none;">
        æš‚æ— è¯„è®º
      </div>

      <!-- åˆ†é¡µå™¨ï¼ˆåº•éƒ¨ï¼‰ -->
      <div class="pagination" id="paginationBottom">
        <button class="page-button" id="prevBtnBottom">ä¸Šä¸€é¡µ</button>
        <span class="page-info" id="pageInfoBottom">ç¬¬ 1 / 1 é¡µ</span>
        <button class="page-button" id="nextBtnBottom">ä¸‹ä¸€é¡µ</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== çŠ¶æ€ç®¡ç† ====================
    let currentUserId = null;
    let isUserVerified = false;
    let allWorkOptions = [];
    let allCommentsData = [];
    let currentPage = 1;
    let totalPages = 1;
    const commentsPerPage = 20;
    let currentFilter = 'default';
    let currentWorkFilter = '';
    let isSubmitting = false;

    // ==================== åˆå§‹åŒ– ====================
    window.addEventListener('message', async (event) => {
      if (!event.data || typeof event.data !== 'object') return;

      const { type, data } = event.data;

      switch (type) {
        case 'INIT_COMMENT_SYSTEM':
          await handleInit(data);
          break;
        case 'UPDATE_COMMENTS':
          await handleCommentsUpdate(data);
          break;
        case 'SUBMIT_RESULT':
          handleSubmitResult(data);
          break;
        case 'WORK_OPTIONS':
          handleWorkOptions(data);
          break;
        case 'WORK_STATUS_UPDATE':
          handleWorkStatusUpdate(data);
          break;
        case 'SUBMIT_PROGRESS':
          handleSubmitProgress(data);
          break;
        case 'WORK_SELECTION_STATE':
          handleWorkSelectionState(data);
          break;
        default:
          console.log('[è¯„è®ºç³»ç»Ÿ] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', type);
      }
    });

    async function handleInit(data) {
      console.log('[è¯„è®ºç³»ç»Ÿ] åˆå§‹åŒ–...', data);
      currentUserId = data.currentUserId;
      isUserVerified = data.isUserVerified;
      
      // æ˜¾ç¤ºåˆå§‹åŒ–åŠ è½½çŠ¶æ€
      showLoading('æ­£åœ¨åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ...');
      
      // æ›´æ–°è¾“å…¥åŒºåŸŸçŠ¶æ€
      updateInputState();
      
      // è¯·æ±‚ä½œå“é€‰é¡¹å’Œè¯„è®ºæ•°æ®
      requestWorkOptions();
      requestCommentsData();
    }

    function handleWorkOptions(data) {
      console.log('[è¯„è®ºç³»ç»Ÿ] æ”¶åˆ°ä½œå“é€‰é¡¹:', data.options?.length);
      allWorkOptions = data.options || [];
      updateWorkDropdowns();
    }

    async function handleCommentsUpdate(data) {
      console.log('[è¯„è®ºç³»ç»Ÿ] æ›´æ–°è¯„è®ºæ•°æ®:', data.comments?.length);
      allCommentsData = data.comments || [];
      currentWorkFilter = data.workFilter || '';
      currentFilter = data.filterMode || 'default';
      currentPage = data.currentPage || 1;
      
      applyFilters();
    }

    function handleWorkStatusUpdate(data) {
      const workStatusInfo = document.getElementById('workStatusInfo');
      
      if (!data || !data.message) {
        workStatusInfo.style.display = 'none';
        return;
      }
      
      workStatusInfo.textContent = data.message;
      workStatusInfo.className = 'work-status-info';
      
      // æ ¹æ®çŠ¶æ€ç±»å‹æ·»åŠ ä¸åŒçš„æ ·å¼
      if (data.statusType === 'task') {
        workStatusInfo.classList.add('task');
      } else if (data.statusType === 'coldWork') {
        workStatusInfo.classList.add('cold-work');
      } else if (data.statusType === 'completedTask') {
        workStatusInfo.classList.add('completed-task');
      } else if (data.statusType === 'author') {
        workStatusInfo.classList.add('author');
      }
      
      workStatusInfo.style.display = 'block';
      console.log('[è¯„è®ºç³»ç»Ÿ] ä½œå“çŠ¶æ€æ›´æ–°:', data.message);
    }

    function handleSubmitProgress(data) {
      const statusEl = document.getElementById('submitStatus');
      
      statusEl.textContent = data.message || 'å¤„ç†ä¸­...';
      statusEl.className = 'submit-status show';
      
      // æ ¹æ®è¿›åº¦çŠ¶æ€è®¾ç½®ä¸åŒçš„èƒŒæ™¯è‰²
      if (data.stage === 'validating') {
        statusEl.style.background = 'rgba(255, 193, 7, 0.4)'; // é»„è‰² - éªŒè¯ä¸­
      } else if (data.stage === 'saving') {
        statusEl.style.background = 'rgba(33, 150, 243, 0.4)'; // è“è‰² - ä¿å­˜ä¸­
      } else if (data.stage === 'updating') {
        statusEl.style.background = 'rgba(156, 39, 176, 0.4)'; // ç´«è‰² - æ›´æ–°ä¸­
      } else {
        statusEl.style.background = 'rgba(255, 255, 255, 0.3)'; // é»˜è®¤
      }
      
      console.log('[è¯„è®ºç³»ç»Ÿ] æäº¤è¿›åº¦:', data.message);
    }

    function handleWorkSelectionState(data) {
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const submitBtn = document.getElementById('submitBtn');
      
      console.log('[è¯„è®ºç³»ç»Ÿ] å¤„ç†ä½œå“é€‰æ‹©çŠ¶æ€:', data);
      
      // æ ¹æ®çŠ¶æ€æ›´æ–°UI
      if (data.isAlreadyCommented && data.existingComment) {
        // å·²è¯„è®ºï¼šå›å¡«æ•°æ®å¹¶ç¦ç”¨è¾“å…¥
        commentField.value = data.existingComment.comment || '';
        inputScore.value = data.existingComment.score || '';
        commentField.disabled = true;
        inputScore.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'å·²è¯„è®º';
        console.log('[è¯„è®ºç³»ç»Ÿ] å·²è¯„è®ºï¼Œå›å¡«æ•°æ®å¹¶ç¦ç”¨è¾“å…¥');
      } else if (data.isAuthor) {
        // ä½œè€…è‡ªè¯„ï¼šæ¸…ç©ºå¹¶å¯ç”¨è¾“å…¥
        commentField.value = '';
        inputScore.value = '';
        commentField.disabled = false;
        inputScore.disabled = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'è‡ªè¯„';
        console.log('[è¯„è®ºç³»ç»Ÿ] ä½œè€…è‡ªè¯„æ¨¡å¼');
      } else if (data.isWorkDQ) {
        // æ·˜æ±°ä½œå“ï¼šæ¸…ç©ºå¹¶ç¦ç”¨æ‰€æœ‰
        commentField.value = '';
        inputScore.value = '';
        commentField.disabled = true;
        inputScore.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'ä½œå“å·²æ·˜æ±°';
        console.log('[è¯„è®ºç³»ç»Ÿ] ä½œå“å·²æ·˜æ±°');
      } else {
        // æ­£å¸¸æœªè¯„è®ºï¼šæ¸…ç©ºå¹¶å¯ç”¨è¾“å…¥
        commentField.value = '';
        inputScore.value = '';
        commentField.disabled = false;
        inputScore.disabled = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤è¯„è®º';
        console.log('[è¯„è®ºç³»ç»Ÿ] æ­£å¸¸çŠ¶æ€ï¼Œå¯ä»¥è¯„è®º');
      }
    }

    function resetWorkSelection() {
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const submitBtn = document.getElementById('submitBtn');
      const workStatusInfo = document.getElementById('workStatusInfo');
      
      // æ¸…ç©ºè¾“å…¥
      commentField.value = '';
      inputScore.value = '';
      
      // éšè—ä½œå“çŠ¶æ€ä¿¡æ¯
      workStatusInfo.style.display = 'none';
      
      // æ ¹æ®ç™»å½•å’ŒéªŒè¯çŠ¶æ€æ¢å¤é»˜è®¤çŠ¶æ€
      if (!currentUserId) {
        commentField.disabled = true;
        inputScore.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æœªç™»å½•';
      } else if (!isUserVerified) {
        commentField.disabled = true;
        inputScore.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æœªæŠ¥å';
      } else {
        commentField.disabled = false;
        inputScore.disabled = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤è¯„è®º';
      }
      
      console.log('[è¯„è®ºç³»ç»Ÿ] å·²é‡ç½®ä½œå“é€‰æ‹©çŠ¶æ€');
    }

    function handleSubmitResult(data) {
      isSubmitting = false;
      const statusEl = document.getElementById('submitStatus');
      const submitBtn = document.getElementById('submitBtn');
      const inputNumber = document.getElementById('inputNumber');
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const workStatusInfo = document.getElementById('workStatusInfo');
      
      if (data.success) {
        showStatus(data.message || 'âœ… æäº¤æˆåŠŸï¼', 'success');
        
        // æ¸…ç©ºæ‰€æœ‰è¾“å…¥
        inputNumber.value = '';
        inputScore.value = '';
        commentField.value = '';
        
        // éšè—ä½œå“çŠ¶æ€ä¿¡æ¯
        workStatusInfo.style.display = 'none';
        
        // å®Œæ•´é‡ç½®çŠ¶æ€ï¼šæ ¹æ®ç”¨æˆ·ç™»å½•å’ŒéªŒè¯çŠ¶æ€æ¢å¤é»˜è®¤çŠ¶æ€
        if (!currentUserId) {
          inputNumber.disabled = true;
          inputScore.disabled = true;
          commentField.disabled = true;
          submitBtn.disabled = true;
          submitBtn.textContent = 'æœªç™»å½•';
        } else if (!isUserVerified) {
          inputNumber.disabled = true;
          inputScore.disabled = true;
          commentField.disabled = true;
          submitBtn.disabled = true;
          submitBtn.textContent = 'æœªæŠ¥å';
        } else {
          inputNumber.disabled = false;
          inputScore.disabled = false;
          commentField.disabled = false;
          submitBtn.disabled = false;
          submitBtn.textContent = 'æäº¤è¯„è®º';
        }
        
        // ç«‹å³åˆ·æ–°è¯„è®ºåˆ—è¡¨ï¼ˆç¡®ä¿æ–°è¯„è®ºç«‹å³æ˜¾ç¤ºï¼‰
        requestCommentsData();
      } else {
        // æäº¤å¤±è´¥æ—¶é‡æ–°å¯ç”¨æŒ‰é’®
        submitBtn.disabled = false;
        showStatus(data.message || 'âŒ æäº¤å¤±è´¥', 'error');
      }
    }

    // ==================== è¾“å…¥åŒºåŸŸ ====================
    function updateInputState() {
      const inputNumber = document.getElementById('inputNumber');
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const submitBtn = document.getElementById('submitBtn');

      if (!currentUserId) {
        inputNumber.disabled = true;
        inputScore.disabled = true;
        commentField.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æœªç™»å½•';
        return;
      }

      if (!isUserVerified) {
        inputNumber.disabled = true;
        inputScore.disabled = true;
        commentField.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æœªæŠ¥å';
        return;
      }

      inputNumber.disabled = false;
      inputScore.disabled = false;
      commentField.disabled = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'æäº¤è¯„è®º';
    }

    function updateWorkDropdowns() {
      const inputNumber = document.getElementById('inputNumber');
      const dropdownFilter = document.getElementById('dropdownFilter');
      
      // æ›´æ–°æäº¤ä½œå“é€‰æ‹©å™¨
      inputNumber.innerHTML = '<option value="">è¯·é€‰æ‹©ä½œå“ç¼–å·</option>' +
        allWorkOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
      
      // æ›´æ–°ç­›é€‰ä½œå“é€‰æ‹©å™¨
      dropdownFilter.innerHTML = '<option value="">æ˜¾ç¤ºæ‰€æœ‰è¯„è®º</option>' +
        allWorkOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
    }

    function showStatus(message, type = '') {
      const statusEl = document.getElementById('submitStatus');
      statusEl.textContent = message;
      statusEl.className = 'submit-status show';
      statusEl.style.background = type === 'success' 
        ? 'rgba(76, 175, 80, 0.4)' 
        : type === 'error' 
        ? 'rgba(244, 67, 54, 0.4)' 
        : 'rgba(255, 255, 255, 0.3)';
      
      setTimeout(() => {
        statusEl.classList.remove('show');
      }, 3000);
    }

    // ==================== äº‹ä»¶ç›‘å¬ ====================
    // æäº¤æŒ‰é’®
    document.getElementById('submitBtn').addEventListener('click', () => {
      if (isSubmitting) return;
      
      const workNumber = document.getElementById('inputNumber').value;
      const score = document.getElementById('inputScore').value;
      const comment = document.getElementById('Comment').value;

      // éªŒè¯è¾“å…¥å®Œæ•´æ€§
      if (!workNumber || !score || !comment) {
        showStatus('âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
        return;
      }

      // éªŒè¯ä½œå“ç¼–å·èŒƒå›´
      const workNum = parseInt(workNumber);
      if (isNaN(workNum) || workNum < 1 || workNum > 500) {
        showStatus('âŒ ä½œå“ç¼–å·å¿…é¡»åœ¨1-500ä¹‹é—´', 'error');
        return;
      }

      // éªŒè¯è¯„åˆ†èŒƒå›´
      const scoreNum = parseInt(score);
      if (isNaN(scoreNum) || scoreNum < 100 || scoreNum > 1000) {
        showStatus('âŒ è¯„åˆ†å¿…é¡»åœ¨100-1000ä¹‹é—´', 'error');
        return;
      }

      // éªŒè¯è¯„è®ºå†…å®¹ä¸ä¸ºç©º
      if (comment.trim().length === 0) {
        showStatus('âŒ è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
        return;
      }

      isSubmitting = true;
      document.getElementById('submitBtn').disabled = true;
      showStatus('æ­£åœ¨æäº¤...', '');

      // å‘é€æäº¤è¯·æ±‚åˆ°Wixé¡µé¢
      window.parent.postMessage({
        type: 'SUBMIT_COMMENT',
        data: {
          workNumber: workNum,
          score: scoreNum,
          comment: comment.trim()
        }
      }, '*');
    });

    // ä½œå“ç¼–å·é€‰æ‹© - å®Œæ•´çš„çŠ¶æ€å¤„ç†
    document.getElementById('inputNumber').addEventListener('change', async (e) => {
      const workNumber = e.target.value;
      
      if (workNumber) {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoading('æ­£åœ¨æ£€æŸ¥ä½œå“çŠ¶æ€...');
        
        // é€šçŸ¥Wixé¡µé¢ä½œå“ç¼–å·å˜åŒ–ï¼Œè·å–å®Œæ•´çš„ä½œå“çŠ¶æ€
        window.parent.postMessage({
          type: 'WORK_NUMBER_CHANGED',
          data: { workNumber: parseInt(workNumber) }
        }, '*');
        
        // åŒæ­¥æ›´æ–°ç­›é€‰å™¨å¹¶åŠ è½½è¯¥ä½œå“çš„è¯„è®º
        const dropdownFilter = document.getElementById('dropdownFilter');
        if (dropdownFilter.value !== workNumber) {
          dropdownFilter.value = workNumber;
          currentWorkFilter = workNumber;
          currentPage = 1;
          requestCommentsData();
        }
      } else {
        // æ¸…ç©ºé€‰æ‹©æ—¶é‡ç½®çŠ¶æ€
        resetWorkSelection();
        // é‡æ–°åŠ è½½æ‰€æœ‰è¯„è®º
        requestCommentsData();
      }
    });

    // ä½œå“ç­›é€‰
    document.getElementById('dropdownFilter').addEventListener('change', (e) => {
      currentWorkFilter = e.target.value;
      currentPage = 1;
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const message = currentWorkFilter 
        ? `æ­£åœ¨åŠ è½½ä½œå“ #${currentWorkFilter} çš„è¯„è®º...` 
        : 'æ­£åœ¨åŠ è½½æ‰€æœ‰è¯„è®º...';
      showLoading(message);
      
      requestCommentsData();
    });

    // è¯„è®ºç±»å‹ç­›é€‰
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if (tab.classList.contains('active')) return; // å·²é€‰ä¸­ï¼Œæ— éœ€é‡å¤åŠ è½½
        
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        currentPage = 1;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€å¹¶è¯·æ±‚æ•°æ®
        showLoading('æ­£åœ¨åˆ‡æ¢ç­›é€‰æ¨¡å¼...');
        requestCommentsData();
      });
    });

    // åˆ†é¡µæŒ‰é’®
    ['Top', 'Bottom'].forEach(suffix => {
      document.getElementById(`prevBtn${suffix}`).addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          applyFilters();
        }
      });

      document.getElementById(`nextBtn${suffix}`).addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          applyFilters();
        }
      });
    });

    // ==================== è¯„è®ºæ˜¾ç¤º ====================
    function applyFilters() {
      const commentList = document.getElementById('commentList');
      const loadingState = document.getElementById('loadingState');
      const noComments = document.getElementById('noComments');

      // è®¡ç®—åˆ†é¡µ
      totalPages = Math.max(1, Math.ceil(allCommentsData.length / commentsPerPage));
      currentPage = Math.min(currentPage, totalPages);

      const startIndex = (currentPage - 1) * commentsPerPage;
      const endIndex = startIndex + commentsPerPage;
      const pagedComments = allCommentsData.slice(startIndex, endIndex);

      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      updatePagination();

      // ç«‹å³æ¸²æŸ“ï¼ˆåŠ è½½çŠ¶æ€å·²åœ¨requestCommentsDataä¸­æ˜¾ç¤ºï¼‰
      loadingState.style.display = 'none';

      if (pagedComments.length === 0) {
        noComments.style.display = 'block';
        commentList.innerHTML = '';
      } else {
        noComments.style.display = 'none';
        renderComments(pagedComments);
      }
    }

    function updatePagination() {
      ['Top', 'Bottom'].forEach(suffix => {
        const prevBtn = document.getElementById(`prevBtn${suffix}`);
        const nextBtn = document.getElementById(`nextBtn${suffix}`);
        const pageInfo = document.getElementById(`pageInfo${suffix}`);

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
        pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
      });
    }

    function renderComments(comments) {
      const commentList = document.getElementById('commentList');
      commentList.innerHTML = '';

      comments.forEach(comment => {
        const commentEl = createCommentElement(comment);
        commentList.appendChild(commentEl);
      });
    }

    function createCommentElement(comment) {
      const div = document.createElement('div');
      div.className = 'comment-item';

      // æ„å»ºè¯„åˆ†å¾½ç« 
      const scoreBadgeHTML = createScoreBadge(comment);

      // æ„å»ºæ“ä½œæŒ‰é’®
      const actionsHTML = createActionButtons(comment);

      // æ¸²æŸ“è¯„è®ºå†…å®¹ï¼ˆæ”¯æŒMarkdownï¼‰
      const commentContentHTML = renderMarkdown(comment.commentText || 'æ— å†…å®¹');
      
      div.innerHTML = `
        <div class="comment-header">
          ${scoreBadgeHTML}
          <div class="comment-work-title">${escapeHtml(comment.workTitle || `#${comment.workNumber}`)}</div>
          ${comment.ratingInfo ? `<div class="comment-rating-info">${escapeHtml(comment.ratingInfo)}</div>` : ''}
        </div>
        <div class="comment-content" data-full-text="${escapeHtml(comment.commentText || 'æ— å†…å®¹')}">${commentContentHTML}</div>
        <div class="comment-actions">
          ${actionsHTML}
          ${comment.replyCount > 0 ? `<span class="reply-count">${comment.replyCount}æ¡å›å¤</span>` : ''}
        </div>
      `;

      // ç»‘å®šäº‹ä»¶
      bindCommentActions(div, comment);
      
      // æ£€æŸ¥è¯„è®ºå†…å®¹æ˜¯å¦éœ€è¦å±•å¼€åŠŸèƒ½
      setTimeout(() => {
        const commentContent = div.querySelector('.comment-content');
        if (commentContent) {
          // æ£€æŸ¥å†…å®¹æ˜¯å¦æº¢å‡ºï¼ˆè¶…è¿‡120pxé«˜åº¦ï¼‰
          if (commentContent.scrollHeight > commentContent.clientHeight) {
            commentContent.classList.add('has-overflow');
          } else {
            commentContent.classList.add('short');
          }
        }
      }, 0);

      return div;
    }

    function createScoreBadge(comment) {
      let badgeClass = 'comment-score-badge';
      let badgeText = '';
      let badgeStyle = '';

      if (comment.isReply) {
        badgeText = 'Re';
        badgeStyle = 'background: #1E3A8A;';
      } else if (comment.isAuthorComment) {
        badgeText = 'Sc';
        badgeStyle = 'background: #8A2BE2;';
      } else if (comment.showScore) {
        badgeText = comment.score;
        const redAmount = Math.floor((comment.score / 1000) * 255);
        badgeStyle = `background: rgb(${redAmount}, 0, 0);`;
      } else {
        badgeText = '?';
        badgeStyle = 'background: #A9A9A9;';
      }

      return `<div class="${badgeClass}" style="${badgeStyle}">${badgeText}</div>`;
    }

    function createActionButtons(comment) {
      let buttons = [];

      // è·³è½¬åˆ°ä½œå“æŒ‰é’®ï¼ˆä»…ä¸»è¯„è®ºï¼‰
      if (!comment.isReply) {
        buttons.push(`<button class="action-btn goto-work-btn">è·³è½¬åˆ°ä½œå“</button>`);
      }

      // æŸ¥çœ‹å›å¤æŒ‰é’®
      buttons.push(`<button class="action-btn view-replies-btn">${comment.isReply ? 'æŸ¥çœ‹ä¸»è¯„è®º' : 'æŸ¥çœ‹å›å¤'}</button>`);

      // åˆ é™¤æŒ‰é’®
      if (comment.canDelete) {
        buttons.push(`<button class="action-btn delete delete-btn">åˆ é™¤</button>`);
      }

      return buttons.join('');
    }

    function bindCommentActions(element, comment) {
      // è¯„è®ºå†…å®¹ç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼ˆä»…é•¿è¯„è®ºï¼‰
      const commentContent = element.querySelector('.comment-content');
      if (commentContent) {
        commentContent.addEventListener('click', (e) => {
          // é˜²æ­¢ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘å±•å¼€
          if (e.target.tagName === 'BUTTON') return;
          
          // ç‚¹å‡»å›¾ç‰‡æ—¶åœ¨æ–°æ ‡ç­¾æ‰“å¼€
          if (e.target.tagName === 'IMG') {
            e.stopPropagation();
            const imgSrc = e.target.src;
            if (imgSrc) {
              window.open(imgSrc, '_blank', 'noopener,noreferrer');
              console.log('[è¯„è®ºç³»ç»Ÿ] åœ¨æ–°æ ‡ç­¾æ‰“å¼€å›¾ç‰‡:', imgSrc);
            }
            return;
          }
          
          // ç‚¹å‡»é“¾æ¥æ—¶ä¸è§¦å‘å±•å¼€
          if (e.target.tagName === 'A') {
            e.stopPropagation();
            return;
          }
          
          // åªæœ‰æº¢å‡ºçš„è¯„è®ºæ‰èƒ½å±•å¼€
          if (commentContent.classList.contains('has-overflow') || commentContent.classList.contains('expanded')) {
            commentContent.classList.toggle('expanded');
            console.log('[è¯„è®ºç³»ç»Ÿ] è¯„è®ºå†…å®¹å·²' + (commentContent.classList.contains('expanded') ? 'å±•å¼€' : 'æ”¶èµ·'));
          }
        });
      }

      // è·³è½¬åˆ°ä½œå“
      const gotoWorkBtn = element.querySelector('.goto-work-btn');
      if (gotoWorkBtn) {
        gotoWorkBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // é˜²æ­¢è§¦å‘è¯„è®ºå±•å¼€
          
          window.parent.postMessage({
            type: 'GOTO_WORK',
            data: { workNumber: comment.workNumber }
          }, '*');
          
          console.log('[è¯„è®ºç³»ç»Ÿ] è¯·æ±‚è·³è½¬åˆ°ä½œå“ #' + comment.workNumber);
        });
      }

      // æŸ¥çœ‹å›å¤
      const viewRepliesBtn = element.querySelector('.view-replies-btn');
      if (viewRepliesBtn) {
        viewRepliesBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // é˜²æ­¢è§¦å‘è¯„è®ºå±•å¼€
          
          window.parent.postMessage({
            type: 'VIEW_REPLIES',
            data: {
              commentId: comment.commentId,
              workNumber: comment.workNumber,
              originalComment: comment.commentText,
              isReply: comment.isReply,
              replyTo: comment.replyTo
            }
          }, '*');
          
          console.log('[è¯„è®ºç³»ç»Ÿ] è¯·æ±‚æŸ¥çœ‹å›å¤');
        });
      }

      // åˆ é™¤è¯„è®º
      const deleteBtn = element.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // é˜²æ­¢è§¦å‘è¯„è®ºå±•å¼€
          
          window.parent.postMessage({
            type: 'DELETE_COMMENT',
            data: {
              commentId: comment.commentId,
              workNumber: comment.workNumber,
              score: comment.score,
              comment: comment.commentText,
              isSelfScComment: comment.isSelfScComment,
              _owner: comment._owner
            }
          }, '*');
        });
      }
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderMarkdown(text) {
      if (!text) return '';
      
      // å¦‚æœmarkedåº“å¯ç”¨ï¼Œä½¿ç”¨Markdownæ¸²æŸ“
      if (typeof marked !== 'undefined') {
        try {
          // ä½¿ç”¨markedè§£æMarkdown
          let html = marked.parse(text);
          
          // å®‰å…¨å¤„ç†ï¼šç¡®ä¿å¤–éƒ¨é“¾æ¥åœ¨æ–°æ ‡ç­¾æ‰“å¼€ï¼Œæ·»åŠ å®‰å…¨å±æ€§
          html = html.replace(/<a /g, '<a target="_blank" rel="noopener noreferrer" ');
          
          return html;
        } catch (error) {
          console.error('[è¯„è®ºç³»ç»Ÿ] Markdownè§£æå¤±è´¥:', error);
          // é™çº§ä¸ºçº¯æ–‡æœ¬æ˜¾ç¤º
          return escapeHtml(text).replace(/\n/g, '<br>');
        }
      } else {
        // markedæœªåŠ è½½ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º
        return escapeHtml(text).replace(/\n/g, '<br>');
      }
    }

    function showLoading(message = 'åŠ è½½ä¸­...') {
      const loadingState = document.getElementById('loadingState');
      const loadingText = loadingState.querySelector('.loading-text');
      if (loadingText) {
        loadingText.textContent = message;
      }
      loadingState.style.display = 'block';
      document.getElementById('commentList').innerHTML = '';
      document.getElementById('noComments').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }

    function requestWorkOptions() {
      console.log('[è¯„è®ºç³»ç»Ÿ] è¯·æ±‚ä½œå“é€‰é¡¹...');
      window.parent.postMessage({
        type: 'REQUEST_WORK_OPTIONS'
      }, '*');
    }

    function requestCommentsData() {
      console.log('[è¯„è®ºç³»ç»Ÿ] è¯·æ±‚è¯„è®ºæ•°æ®...');
      showLoading('åŠ è½½è¯„è®ºä¸­...');
      
      window.parent.postMessage({
        type: 'REQUEST_COMMENTS',
        data: {
          workFilter: currentWorkFilter,
          filterMode: currentFilter,
          currentPage: currentPage
        }
      }, '*');
    }

    // ==================== Markdowné…ç½® ====================
    // é…ç½®markedé€‰é¡¹
    if (typeof marked !== 'undefined') {
      marked.setOptions({
        breaks: true, // æ”¯æŒGFMæ¢è¡Œ
        gfm: true, // å¯ç”¨GitHub Flavored Markdown
        headerIds: false, // ç¦ç”¨æ ‡é¢˜IDï¼ˆé¿å…å†²çªï¼‰
        mangle: false // ç¦ç”¨é‚®ç®±æ··æ·†
      });
      console.log('[è¯„è®ºç³»ç»Ÿ] Markdownè§£æå™¨å·²é…ç½®');
    } else {
      console.warn('[è¯„è®ºç³»ç»Ÿ] Markdownè§£æå™¨æœªåŠ è½½ï¼Œå°†ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º');
    }

    // ==================== é¡µé¢åŠ è½½ ====================
    // æ˜¾ç¤ºåˆå§‹åŠ è½½çŠ¶æ€
    showLoading('æ­£åœ¨è¿æ¥è¯„è®ºç³»ç»Ÿ...');
    
    console.log('[è¯„è®ºç³»ç»Ÿ] HTMLå·²åŠ è½½');
    window.parent.postMessage({
      type: 'COMMENT_SYSTEM_READY'
    }, '*');
  </script>
</body>
</html>

