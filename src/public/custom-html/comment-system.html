<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯„è®ºç³»ç»Ÿ</title>
  <!-- Markdownè§£æåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      padding: 20px;
      min-height: 100vh;
      background: transparent;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* æ¯›ç»ç’ƒå¡ç‰‡ */
    .glass-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }

    /* è¯„è®ºè¾“å…¥åŒºåŸŸ */
    .comment-input-section {
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 20px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .input-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-label {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
    }

    .input-field {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      transition: all 0.3s;
    }

    .input-field:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .input-field::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .input-field:disabled {
      background: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
    }

    select.input-field {
      cursor: pointer;
    }

    select.input-field option {
      background: #333;
      color: #fff;
    }

    textarea.input-field {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .submit-button {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.9) 0%, rgba(255, 165, 0, 0.9) 100%);
      color: #fff;
      border: none;
      padding: 14px 32px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 4px 20px rgba(255, 165, 0, 0.3);
      transition: all 0.3s ease;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .submit-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(255, 165, 0, 0.4);
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    }

    .submit-button:active:not(:disabled) {
      transform: translateY(0);
    }

    .submit-button:disabled {
      background: rgba(255, 255, 255, 0.3);
      color: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
      box-shadow: none;
    }

    .work-status-info {
      margin-top: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      font-size: 14px;
      color: #fff;
      text-align: center;
      font-weight: 600;
      line-height: 1.6;
    }

    .work-status-info.task {
      background: linear-gradient(135deg, rgba(0, 102, 255, 0.4) 0%, rgba(0, 82, 204, 0.4) 100%);
      border: 1px solid rgba(0, 102, 255, 0.6);
    }

    .work-status-info.cold-work {
      background: linear-gradient(135deg, rgba(255, 165, 0, 0.4) 0%, rgba(255, 140, 0, 0.4) 100%);
      border: 1px solid rgba(255, 165, 0, 0.6);
    }

    .work-status-info.completed-task {
      background: linear-gradient(135deg, rgba(34, 139, 34, 0.4) 0%, rgba(46, 125, 50, 0.4) 100%);
      border: 1px solid rgba(34, 139, 34, 0.6);
    }

    .work-status-info.author {
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.4) 0%, rgba(123, 31, 162, 0.4) 100%);
      border: 1px solid rgba(138, 43, 226, 0.6);
    }

    .work-status-info.loading {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.4) 0%, rgba(25, 118, 210, 0.4) 100%);
      border: 1px solid rgba(33, 150, 243, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .inline-spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    .submit-status {
      margin-top: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      font-size: 14px;
      color: #fff;
      text-align: center;
      display: none;
      font-weight: 600;
      line-height: 1.6;
    }

    .submit-status.show {
      display: block;
    }

    /* ç­›é€‰åŒºåŸŸ */
    .filter-section {
      margin-bottom: 20px;
    }

    .filter-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-tab:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    .filter-tab.active {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.6) 0%, rgba(255, 165, 0, 0.6) 100%);
      border-color: rgba(255, 215, 0, 0.8);
    }

    /* è¯„è®ºåˆ—è¡¨å®¹å™¨ï¼ˆé€æ˜èƒŒæ™¯ï¼‰ */
    .comments-display-container {
      background: transparent;
      margin-bottom: 20px;
    }

    /* åˆ†é¡µå™¨ */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }

    .page-button {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .page-button:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.4);
    }

    .page-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-info {
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      transition: all 0.3s;
      user-select: none;
    }

    .page-info:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: translateY(-1px);
    }

    /* è¯„è®ºåˆ—è¡¨ */
    .comment-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .comment-item {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      transition: all 0.3s;
    }

    .comment-item:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .comment-score-badge {
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      min-width: 60px;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .comment-work-title {
      font-size: 15px;
      color: #fff;
      font-weight: 600;
      flex: 1;
      min-width: 200px;
    }

    .comment-rating-info {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 10px;
    }

    .comment-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.15);
      padding: 4px 10px;
      border-radius: 8px;
      white-space: nowrap;
    }

    .comment-content {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 12px;
      color: #fff;
      font-size: 14px;
      line-height: 1.6;
      max-height: 120px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .comment-content:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .comment-content.expanded {
      max-height: none;
      overflow-y: auto;
    }

    .comment-content.has-overflow::after {
      content: 'â–¼ ç‚¹å‡»å±•å¼€';
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.6) 60%, rgba(255, 255, 255, 0.4) 80%, transparent);
      padding: 20px 8px 8px;
      text-align: center;
      font-size: 13px;
      color: rgba(0, 0, 0, 0.85);
      font-weight: 700;
      cursor: pointer;
      z-index: 10;
      border-radius: 0 0 12px 12px;
      pointer-events: auto;
    }

    .comment-content.has-overflow:hover::after {
      background: linear-gradient(to top, rgba(255, 255, 255, 0.75) 60%, rgba(255, 255, 255, 0.5) 80%, transparent);
      color: rgba(0, 0, 0, 1);
    }

    .comment-content.expanded::after {
      content: 'â–² ç‚¹å‡»æ”¶èµ·';
      position: relative;
      background: rgba(255, 255, 255, 0.3);
      margin-top: 10px;
      display: block;
      padding: 8px;
      border-radius: 8px;
    }

    .comment-content.short {
      cursor: default;
    }

    .comment-content.short::after {
      display: none;
    }
    .comment-content::-webkit-scrollbar {
      width: 6px;
    }

    .comment-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .comment-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    /* Markdownå†…å®¹æ ·å¼ */
    .comment-content h1,
    .comment-content h2,
    .comment-content h3,
    .comment-content h4,
    .comment-content h5,
    .comment-content h6 {
      margin: 12px 0 8px 0;
      font-weight: 700;
      color: #fff;
    }

    .comment-content h1 { font-size: 20px; }
    .comment-content h2 { font-size: 18px; }
    .comment-content h3 { font-size: 16px; }
    .comment-content h4 { font-size: 15px; }
    .comment-content h5 { font-size: 14px; }
    .comment-content h6 { font-size: 13px; }

    .comment-content p {
      margin: 8px 0;
    }

    .comment-content a {
      color: #4A90E2; /* è“è‰² */
      text-decoration: underline;
      font-weight: 600;
    }

    .comment-content a:hover {
      color: #357ABD; /* æ·±è“è‰²æ‚¬åœæ•ˆæœ */
    }

    .comment-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: block;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .comment-content img:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    /* å›¾ç‰‡å°ºå¯¸æ§åˆ¶ */
    .comment-content img.img-small {
      max-width: 200px;
    }

    .comment-content img.img-medium {
      max-width: 400px;
    }

    .comment-content img.img-large {
      max-width: 600px;
    }

    .comment-content img.img-full {
      max-width: 100%;
    }

    /* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„æ ·å¼ */
    .comment-content img[alt]::before {
      content: 'ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥';
      display: block;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
    }

    .comment-content blockquote {
      border-left: 3px solid rgba(255, 215, 0, 0.6);
      padding-left: 12px;
      margin: 10px 0;
      color: rgba(255, 255, 255, 0.9);
      font-style: italic;
    }

    .comment-content code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #FFD700;
    }

    .comment-content pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .comment-content pre code {
      background: none;
      padding: 0;
      color: #fff;
    }

    .comment-content ul,
    .comment-content ol {
      margin: 8px 0;
      padding-left: 24px;
    }

    .comment-content li {
      margin: 4px 0;
    }

    .comment-content hr {
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      margin: 12px 0;
    }

    .comment-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .comment-content th,
    .comment-content td {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 12px 16px;
      text-align: left;
    }

    .comment-content th {
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      font-size: 15px;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(255, 215, 0, 0.5);
    }

    .comment-content tr:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    .comment-content td {
      color: #fff;
      font-size: 14px;
      line-height: 1.5;
    }

    .comment-content td:first-child {
      font-weight: 600;
      color: #fff;
    }

    /* è¡¨æ ¼å†…ä»£ç æ ·å¼ */
    .comment-content td code,
    .comment-content th code {
      background: rgba(0, 0, 0, 0.4);
      padding: 3px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #FFD700;
    }

    .comment-content strong {
      font-weight: 700;
      color: #ffffff; /* æµ…è“è‰² */
      text-shadow: 0 0 3px #92e9ff, 0 0 6px #c0feff; /* æ·»åŠ è§å…‰æ•ˆæœ */
    }

    .comment-content em {
      font-style: italic;
      color: rgba(255, 255, 255, 0.95);
    }

    .comment-content del,
    .comment-content s,
    .comment-content strike {
      text-decoration: line-through;
      color: rgba(255, 255, 255, 0.7);
    }

    /* æœºåˆ¶è¯´æ˜åŒºåŸŸ */
    .info-section {
      margin-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding-top: 15px;
    }

    .info-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.9);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
      padding: 8px 0;
    }

    .info-toggle:hover {
      color: #fff;
    }

    .info-toggle-icon {
      font-size: 16px;
      transition: transform 0.3s;
    }

    .info-toggle-icon.expanded {
      transform: rotate(90deg);
    }

    .info-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      font-size: 12px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.85);
    }

    .info-content.show {
      max-height: 1000px;
      margin-top: 10px;
    }

    .info-content h4 {
      font-size: 13px;
      font-weight: 700;
      color: #FFD700;
      margin: 12px 0 6px 0;
    }

    .info-content h4:first-child {
      margin-top: 0;
    }

    .info-content ul {
      margin: 6px 0;
      padding-left: 20px;
    }

    .info-content li {
      margin: 4px 0;
    }

    .info-content code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #FFD700;
    }

    .info-content strong {
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 0 3px #92e9ff, 0 0 6px #c0feff;
    }

    .info-content a {
      color: #4A90E2; /* è“è‰² */
      text-decoration: underline;
      font-weight: 600;
    }

    .info-content a:hover {
      color: #357ABD; /* æ·±è“è‰²æ‚¬åœæ•ˆæœ */
    }

    .badge-demo {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
      margin: 0 4px;
    }

    .badge-demo.score { background: rgb(128, 0, 0); }
    .badge-demo.sc { background: #8A2BE2; }
    .badge-demo.re { background: #1E3A8A; }
    .badge-demo.hidden { background: #A9A9A9; }

    /* Markdowné¢„è§ˆåŒºåŸŸ */
    .markdown-preview {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 20px;
      min-height: 200px;
      color: #fff;
      font-size: 14px;
      line-height: 1.6;
      overflow-y: auto;
      max-height: 400px;
    }

    /* é¢„è§ˆåŒºåŸŸè¡¨æ ¼æ ·å¼ - ä¸è¯„è®ºå†…å®¹è¡¨æ ¼æ ·å¼ä¿æŒä¸€è‡´ */
    .markdown-preview table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .markdown-preview th,
    .markdown-preview td {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 12px 16px;
      text-align: left;
    }

    .markdown-preview th {
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      font-size: 15px;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(255, 215, 0, 0.5);
    }

    .markdown-preview tr:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    .markdown-preview td {
      color: #fff;
      font-size: 14px;
      line-height: 1.5;
    }

    .markdown-preview td:first-child {
      font-weight: 600;
      color: #fff;
    }

    /* é¢„è§ˆåŒºåŸŸè¡¨æ ¼å†…ä»£ç æ ·å¼ */
    .markdown-preview td code,
    .markdown-preview th code {
      background: rgba(0, 0, 0, 0.4);
      padding: 3px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #FFD700;
    }

    .preview-placeholder {
      color: rgba(255, 255, 255, 0.7);
      font-style: italic;
      text-align: center;
      padding: 40px 20px;
    }

    .comment-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 10px;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.4);
      transform: translateY(-1px);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(255, 255, 255, 0.2);
    }

    .action-btn.delete {
      background: rgba(211, 47, 47, 0.4);
      border-color: rgba(244, 67, 54, 0.6);
    }

    .action-btn.delete:hover:not(:disabled) {
      background: rgba(244, 67, 54, 0.6);
    }

    .reply-count {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 10px;
      border-radius: 8px;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      margin: 20px 0;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 500;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .no-comments {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      margin: 20px 0;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .glass-card {
        padding: 20px;
      }

      .input-row, .filter-row {
        grid-template-columns: 1fr;
      }

      .comment-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .comment-time {
        align-self: flex-end;
        margin-top: -8px;
      }
    }

    /* é¢„è§ˆåŒºåŸŸå…¶ä»–Markdownæ ·å¼ - ä¸è¯„è®ºå†…å®¹æ ·å¼ä¿æŒä¸€è‡´ */
    .markdown-preview h1,
    .markdown-preview h2,
    .markdown-preview h3,
    .markdown-preview h4,
    .markdown-preview h5,
    .markdown-preview h6 {
      margin: 12px 0 8px 0;
      font-weight: 700;
      color: #fff;
    }

    .markdown-preview h1 { font-size: 20px; }
    .markdown-preview h2 { font-size: 18px; }
    .markdown-preview h3 { font-size: 16px; }
    .markdown-preview h4 { font-size: 15px; }
    .markdown-preview h5 { font-size: 14px; }
    .markdown-preview h6 { font-size: 13px; }

    .markdown-preview p {
      margin: 8px 0;
    }

    .markdown-preview a {
      color: #4A90E2;
      text-decoration: underline;
      font-weight: 600;
    }

    .markdown-preview a:hover {
      color: #357ABD;
    }

    .markdown-preview img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: block;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .markdown-preview img:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    /* é¢„è§ˆåŒºåŸŸå›¾ç‰‡å°ºå¯¸æ§åˆ¶ */
    .markdown-preview img.img-small {
      max-width: 100px;
    }

    .markdown-preview img.img-medium {
      max-width: 250px;
    }

    .markdown-preview img.img-large {
      max-width: 400px;
    }

    .markdown-preview img.img-full {
      max-width: 100%;
    }

    .markdown-preview blockquote {
      border-left: 3px solid rgba(255, 215, 0, 0.6);
      padding-left: 12px;
      margin: 10px 0;
      color: rgba(255, 255, 255, 0.9);
      font-style: italic;
    }

    .markdown-preview code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #FFD700;
    }

    .markdown-preview pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .markdown-preview pre code {
      background: none;
      padding: 0;
      color: #fff;
    }

    .markdown-preview ul,
    .markdown-preview ol {
      margin: 8px 0;
      padding-left: 24px;
    }

    .markdown-preview li {
      margin: 4px 0;
    }

    .markdown-preview hr {
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      margin: 12px 0;
    }

    .markdown-preview strong {
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 0 3px #92e9ff, 0 0 6px #c0feff;
    }

    .markdown-preview em {
      font-style: italic;
      color: rgba(255, 255, 255, 0.95);
    }

    .markdown-preview del,
    .markdown-preview s,
    .markdown-preview strike {
      text-decoration: line-through;
      color: rgba(255, 255, 255, 0.7);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- è¯„è®ºè¾“å…¥åŒºåŸŸ -->
    <div class="glass-card comment-input-section">
      <div class="section-title">æäº¤è¯„è®º <a href="https://docs.qq.com/document/DRUtoTlppUklBYllG" style="color: #fff;" target="_blank" >è¯„åˆ†å‚ç…§æ–‡ä»¶</a></div>
      
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">é€‰æ‹©ä½œå“</label>
          <select class="input-field" id="inputNumber">
            <option value="">è¯·é€‰æ‹©ä½œå“ç¼–å·</option>
          </select>
        </div>
        <div class="input-group">
          <label class="input-label">è¯„åˆ† (100-1000)</label>
          <input type="number" class="input-field" id="inputScore" 
                 placeholder="è¾“å…¥è¯„åˆ†" min="100" max="1000" step="1" required>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">è¯„è®ºå†…å®¹ <span style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: normal;">ï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰</span></label>
        <textarea class="input-field" id="Comment" 
                  placeholder="è¾“å…¥æ‚¨çš„è¯„è®ºï¼Œæ”¯æŒä¸°å¯Œçš„Markdownæ ¼å¼ï¼š&#10;&#10;**ç²—ä½“** *æ–œä½“* `ä»£ç ` ~~åˆ é™¤çº¿~~&#10;# æ ‡é¢˜ (æ”¯æŒ1-6çº§)&#10;![å›¾ç‰‡](https://example.com/image.jpg)&#10;[é“¾æ¥](https://example.com)&#10;> å¼•ç”¨æ–‡å­—&#10;- åˆ—è¡¨é¡¹&#10;| è¡¨æ ¼ | åˆ— |"></textarea>
      </div>

      <div style="margin-top: 20px;">
        <button class="submit-button" id="submitBtn">æäº¤è¯„è®º</button>
      </div>

      <!-- ä½œå“é€‰æ‹©åçš„çŠ¶æ€æç¤º -->
      <div class="work-status-info" id="workStatusInfo" style="display: none;"></div>

      <!-- æäº¤çŠ¶æ€æç¤º -->
      <div class="submit-status" id="submitStatus"></div>

      <!-- æ ¼å¼è¯´æ˜å’Œæœºåˆ¶è¯´æ˜ -->
      <div class="info-section">
        <!-- Markdownæ ¼å¼è¯´æ˜ -->
        <div class="info-toggle" id="formatToggle">
          <span class="info-toggle-icon">â–¶</span>
          <span>Markdownæ ¼å¼æ”¯æŒ</span>
        </div>
        <div class="info-content" id="formatContent">
          <h4>æ–‡æœ¬æ ¼å¼</h4>
          <ul>
            <li><code>**ç²—ä½“**</code> â†’ <strong>ç²—ä½“</strong></li>
            <li><code>*æ–œä½“*</code> â†’ <em>æ–œä½“</em></li>
            <li><code>`è¡Œå†…ä»£ç `</code> â†’ é‡‘è‰²é«˜äº®ä»£ç </li>
            <li><code>~~åˆ é™¤çº¿~~</code> â†’ <del>åˆ é™¤çº¿</del></li>
          </ul>

          <h4>æ ‡é¢˜</h4>
          <ul>
            <li><code># ä¸€çº§æ ‡é¢˜</code> åˆ° <code>###### å…­çº§æ ‡é¢˜</code></li>
          </ul>

          <h4>å›¾ç‰‡å’Œé“¾æ¥</h4>
          <ul>
            <li><code>![æè¿°](å›¾ç‰‡URL)</code> â†’ æ˜¾ç¤ºå›¾ç‰‡ï¼ˆç‚¹å‡»æ–°çª—å£æ‰“å¼€ï¼‰</li>
            <li><code>![æè¿°|small](å›¾ç‰‡URL)</code> â†’ å°å°ºå¯¸å›¾ç‰‡ï¼ˆ200pxå®½ï¼‰</li>
            <li><code>![æè¿°|medium](å›¾ç‰‡URL)</code> â†’ ä¸­ç­‰å°ºå¯¸å›¾ç‰‡ï¼ˆ400pxå®½ï¼‰</li>
            <li><code>![æè¿°|large](å›¾ç‰‡URL)</code> â†’ å¤§å°ºå¯¸å›¾ç‰‡ï¼ˆ600pxå®½ï¼‰</li>
            <li><code>![æè¿°|full](å›¾ç‰‡URL)</code> â†’ å…¨å°ºå¯¸å›¾ç‰‡ï¼ˆ100%å®½ï¼‰</li>
            <li><code>[é“¾æ¥æ–‡å­—](URL)</code> â†’ å¯ç‚¹å‡»é“¾æ¥ï¼ˆè‡ªåŠ¨æ–°çª—å£æ‰“å¼€ï¼‰</li>
          </ul>

          <h4>åˆ—è¡¨å’Œå¼•ç”¨</h4>
          <ul>
            <li><code>- æ— åºåˆ—è¡¨</code> æˆ– <code>1. æœ‰åºåˆ—è¡¨</code></li>
            <li><code>> å¼•ç”¨æ–‡å­—</code> â†’ å·¦ä¾§é‡‘è‰²è¾¹æ¡†</li>
            <li><code>---</code> â†’ åˆ†éš”çº¿</li>
          </ul>

          <h4>ä»£ç å—</h4>
          <ul>
            <li>ä¸‰ä¸ªåå¼•å·åŒ…è£¹å¤šè¡Œä»£ç </li>
            <li>æ”¯æŒè¯­æ³•æ ‡æ³¨ï¼ˆå¦‚ <code>```javascript</code>ï¼‰</li>
          </ul>

          <h4>è¡¨æ ¼</h4>
          <ul>
            <li><code>| åˆ—1 | åˆ—2 |</code></li>
            <li><code>|-----|-----|</code></li>
            <li><code>| å†…å®¹ | å†…å®¹ |</code></li>
          </ul>
        </div>

        <!-- è¯„è®ºæœºåˆ¶è¯´æ˜ -->
        <div class="info-toggle" id="mechanismToggle">
          <span class="info-toggle-icon">â–¶</span>
          <span>è¯„è®ºæœºåˆ¶è¯´æ˜</span>
        </div>
        <div class="info-content" id="mechanismContent">
          <h4>è¯„åˆ†æ˜¾ç¤ºè§„åˆ™</h4>
          <ul>
            <li><span class="badge-demo score">500</span> <strong>æ­£å¼è¯„åˆ†ï¼š</strong>å½“ä½ å·²å¯¹è¯¥ä½œå“æäº¤æ­£å¼è¯„åˆ†æ—¶æ˜¾ç¤ºï¼ˆ100-1000ï¼Œçº¢è‰²æ¸å˜ï¼‰</li>
            <li><span class="badge-demo sc">Sc</span> <strong>ä½œè€…è‡ªè¯„ï¼š</strong>ä½œè€…å¯¹è‡ªå·±ä½œå“çš„è¯„è®ºï¼ˆç´«è‰²ï¼‰</li>
            <li><span class="badge-demo re">Re</span> <strong>æ¥¼ä¸­æ¥¼å›å¤ï¼š</strong>å¯¹å…¶ä»–è¯„è®ºçš„å›å¤ï¼ˆè“è‰²ï¼‰</li>
            <li><span class="badge-demo hidden">?</span> <strong>è¯„åˆ†éšè—ï¼š</strong>æœªå¯¹è¯¥ä½œå“è¯„åˆ†æ—¶ï¼ˆç°è‰²ï¼‰</li>
          </ul>

          <h4>Tierä¿¡æ¯æ˜¾ç¤ºæ¡ä»¶</h4>
          <ul>
            <li><strong>æ˜¾ç¤ºç­‰çº§ï¼ˆS/A/B/C/Dï¼‰ï¼š</strong>ä½œå“è‡³å°‘æœ‰ <strong>5 äººæ­£å¼è¯„åˆ†</strong> + ä½ å·²è¯„åˆ† + éè‡ªè¯„</li>
            <li><strong>è¯„åˆ†é‡ä¸è¶³ï¼š</strong>ä½œå“è¯„åˆ†äººæ•° < 5 äººæ—¶æ˜¾ç¤º"è¯„åˆ†é‡ä¸è¶³(Xäººè¯„åˆ†)"</li>
            <li><strong>ç­‰çº§è®¡ç®—ï¼š</strong>åŸºäºä½œå“åœ¨æ‰€æœ‰æœ‰æ•ˆä½œå“ä¸­çš„ç™¾åˆ†ä½æ’å</li>
          </ul>

          <h4>è¯„åˆ†å¯è§æ€§</h4>
          <ul>
            <li><strong>ä½ èƒ½çœ‹åˆ°è¯„åˆ†ï¼š</strong>ä»…é™ä½ å·²æäº¤æ­£å¼è¯„åˆ†çš„ä½œå“</li>
            <li><strong>é˜²æ­¢åè§ï¼š</strong>æœªè¯„åˆ†ä½œå“çš„åˆ†æ•°å¯¹ä½ éšè—ï¼Œä¿è¯ç‹¬ç«‹è¯„ä»·</li>
            <li><strong>è‡ªè¯„ä¸è®¡åˆ†ï¼š</strong>Sc è¯„è®ºä¸å‚ä¸ä½œå“è¯„åˆ†ç»Ÿè®¡</li>
          </ul>

          <h4>åˆ é™¤æƒé™</h4>
          <ul>
            <li><strong>Sc è¯„è®ºï¼š</strong>ä»…ä½œè€…æœ¬äººå¯åˆ é™¤</li>
            <li><strong>æ™®é€šè¯„è®ºï¼š</strong>ä½œè€…æœ¬äººæˆ–å®¡æ ¸å‘˜å¯åˆ é™¤</li>
            <li>åˆ é™¤è¯„è®ºä¼šæ’¤é”€ç›¸å…³ä»»åŠ¡å®ŒæˆçŠ¶æ€å’Œç§¯åˆ†</li>
          </ul>
        </div>

        <!-- Markdowné¢„è§ˆåŒºåŸŸ -->
        <div class="info-toggle" id="previewToggle">
          <span class="info-toggle-icon">â–¶</span>
          <span>Markdowné¢„è§ˆ</span>
        </div>
        <div class="info-content" id="previewContent">
          <div class="markdown-preview" id="markdownPreview">
            <div class="preview-placeholder">åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥Markdownå†…å®¹ï¼Œè¿™é‡Œå°†å®æ—¶æ˜¾ç¤ºæ¸²æŸ“æ•ˆæœ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- è¯„è®ºç­›é€‰åŒºåŸŸ -->
    <div class="glass-card">
      <div class="section-title">è¯„è®ºåˆ—è¡¨</div>

      <!-- ç­›é€‰å™¨ -->
      <div class="filter-section">
        <div class="filter-row">
          <div class="input-group">
            <label class="input-label">ç­›é€‰ä½œå“</label>
            <select class="input-field" id="dropdownFilter">
              <option value="">æ˜¾ç¤ºæ‰€æœ‰è¯„è®º</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label class="input-label">è¯„è®ºç±»å‹</label>
          <div class="filter-tabs">
            <div class="filter-tab active" data-filter="default">æ‰€æœ‰è¯„è®º</div>
            <div class="filter-tab" data-filter="ScoreOnly">ä»…è¯„åˆ†</div>
            <div class="filter-tab" data-filter="YourComment">ä»…ä½ çš„è¯„è®º</div>
          </div>
        </div>
      </div>
    </div>

    <!-- è¯„è®ºæ˜¾ç¤ºåŒºåŸŸï¼ˆé€æ˜èƒŒæ™¯ï¼‰ -->
    <div class="comments-display-container">
      <!-- åˆ†é¡µå™¨ï¼ˆé¡¶éƒ¨ï¼‰ -->
      <div class="pagination" id="paginationTop">
        <button class="page-button" id="prevBtnTop">ä¸Šä¸€é¡µ</button>
        <span class="page-info" id="pageInfoTop">ç¬¬ 1 / 1 é¡µ</span>
        <button class="page-button" id="nextBtnTop">ä¸‹ä¸€é¡µ</button>
      </div>

      <!-- åŠ è½½çŠ¶æ€ -->
      <div class="loading" id="loadingState" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">åŠ è½½è¯„è®ºä¸­...</div>
      </div>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div class="comment-list" id="commentList"></div>

      <!-- æ— è¯„è®ºæç¤º -->
      <div class="no-comments" id="noComments" style="display: none;">
        æš‚æ— è¯„è®º
      </div>

      <!-- åˆ†é¡µå™¨ï¼ˆåº•éƒ¨ï¼‰ -->
      <div class="pagination" id="paginationBottom">
        <button class="page-button" id="prevBtnBottom">ä¸Šä¸€é¡µ</button>
        <span class="page-info" id="pageInfoBottom">ç¬¬ 1 / 1 é¡µ</span>
        <button class="page-button" id="nextBtnBottom">ä¸‹ä¸€é¡µ</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== çŠ¶æ€ç®¡ç† ====================
    let currentUserId = null;
    let isUserVerified = false;
    let allWorkOptions = [];
    let allCommentsData = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentFilter = 'default';
    let currentWorkFilter = '';
    let isSubmitting = false;
    let loadingTimeout = null; // åŠ è½½è¶…æ—¶è®¡æ—¶å™¨

    // ==================== åˆå§‹åŒ– ====================
    window.addEventListener('message', async (event) => {
      if (!event.data || typeof event.data !== 'object') return;

      const { type, data } = event.data;

      switch (type) {
        case 'INIT_COMMENT_SYSTEM':
          await handleInit(data);
          break;
        case 'UPDATE_COMMENTS':
          await handleCommentsUpdate(data);
          break;
        case 'UPDATE_COMMENTS_ERROR':
          handleCommentsError(data);
          break;
        case 'SUBMIT_RESULT':
          handleSubmitResult(data);
          break;
        case 'WORK_OPTIONS':
          handleWorkOptions(data);
          break;
        case 'WORK_STATUS_UPDATE':
          handleWorkStatusUpdate(data);
          break;
        case 'SUBMIT_PROGRESS':
          handleSubmitProgress(data);
          break;
        case 'WORK_SELECTION_STATE':
          handleWorkSelectionState(data);
          break;
        case 'SET_WORK_FILTER':
          handleSetWorkFilter(data);
          break;
        default:
          console.log('[è¯„è®ºç³»ç»Ÿ] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', type);
      }
    });

    async function handleInit(data) {
      console.log('[è¯„è®ºç³»ç»Ÿ] åˆå§‹åŒ–...', data);
      currentUserId = data.currentUserId;
      isUserVerified = data.isUserVerified;
      
      // ã€ä¿®å¤ã€‘é‡ç½®æ‰€æœ‰ç­›é€‰å™¨çŠ¶æ€åˆ°é»˜è®¤å€¼
      currentWorkFilter = '';
      currentFilter = 'default';
      currentPage = 1;
      
      // ç¡®ä¿UIç»„ä»¶çŠ¶æ€åŒæ­¥
      const dropdownFilter = document.getElementById('dropdownFilter');
      if (dropdownFilter) {
        dropdownFilter.value = '';
      }
      
      document.querySelectorAll('.filter-tab').forEach(tab => {
        if (tab.dataset.filter === 'default') {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      console.log('[è¯„è®ºç³»ç»Ÿ] ç­›é€‰å™¨çŠ¶æ€å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
      
      // æ˜¾ç¤ºåˆå§‹åŒ–åŠ è½½çŠ¶æ€
      showLoading('æ­£åœ¨åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ...');
      
      // æ›´æ–°è¾“å…¥åŒºåŸŸçŠ¶æ€
      updateInputState();
      
      // è¯·æ±‚ä½œå“é€‰é¡¹å’Œè¯„è®ºæ•°æ®
      requestWorkOptions();
      requestCommentsData();
    }

    function handleWorkOptions(data) {
      console.log('[è¯„è®ºç³»ç»Ÿ] æ”¶åˆ°ä½œå“é€‰é¡¹:', data.options?.length);
      allWorkOptions = data.options || [];
      
      // ã€ä¿®å¤ã€‘æ›´æ–°ä¸‹æ‹‰é€‰é¡¹å‰ï¼Œä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
      const dropdownFilter = document.getElementById('dropdownFilter');
      const currentDropdownValue = dropdownFilter ? dropdownFilter.value : '';
      
      updateWorkDropdowns();
      
      // ã€ä¿®å¤ã€‘æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼ï¼ˆå¦‚æœè¯¥é€‰é¡¹ä»ç„¶å­˜åœ¨ï¼‰
      if (currentDropdownValue && dropdownFilter) {
        const optionExists = allWorkOptions.some(opt => opt.value === currentDropdownValue);
        if (optionExists) {
          dropdownFilter.value = currentDropdownValue;
          console.log('[è¯„è®ºç³»ç»Ÿ] å·²æ¢å¤ç­›é€‰å™¨é€‰ä¸­çŠ¶æ€:', currentDropdownValue);
        }
      }
    }

    async function handleCommentsUpdate(data) {
      // console.log('[è¯„è®ºç³»ç»Ÿ] æ›´æ–°è¯„è®ºæ•°æ®:', data.comments?.length);
      allCommentsData = data.comments || [];
      
      // ã€ä¿®å¤ã€‘æ›´æ–°ç­›é€‰çŠ¶æ€æ—¶ï¼ŒåŒæ­¥æ›´æ–°UIç»„ä»¶ï¼Œé¿å…çŠ¶æ€ä¸ä¸€è‡´
      const newWorkFilter = data.workFilter || '';
      const newFilterMode = data.filterMode || 'default';
      
      // åªæœ‰å½“ç­›é€‰çŠ¶æ€çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°UIï¼ˆé¿å…ä¸å¿…è¦çš„é‡ç½®ï¼‰
      if (currentWorkFilter !== newWorkFilter) {
        currentWorkFilter = newWorkFilter;
        // åŒæ­¥æ›´æ–°ä¸‹æ‹‰ç­›é€‰å™¨UI
        const dropdownFilter = document.getElementById('dropdownFilter');
        if (dropdownFilter && dropdownFilter.value !== currentWorkFilter) {
          dropdownFilter.value = currentWorkFilter;
          console.log('[è¯„è®ºç³»ç»Ÿ] å·²åŒæ­¥ä½œå“ç­›é€‰å™¨UI:', currentWorkFilter);
        }
      }
      
      if (currentFilter !== newFilterMode) {
        currentFilter = newFilterMode;
        // åŒæ­¥æ›´æ–°è¯„è®ºç±»å‹ç­›é€‰å™¨UI
        document.querySelectorAll('.filter-tab').forEach(tab => {
          if (tab.dataset.filter === currentFilter) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
        console.log('[è¯„è®ºç³»ç»Ÿ] å·²åŒæ­¥è¯„è®ºç±»å‹ç­›é€‰å™¨UI:', currentFilter);
      }
      
      currentPage = data.currentPage ? Number(data.currentPage) : 1;
      totalPages = Math.max(1, Number(data.totalPages) || 1);
      
      renderCurrentPage();
    }

    function handleCommentsError(data) {
      const message = data?.message || 'åŠ è½½è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      const loadingState = document.getElementById('loadingState');
      const loadingText = loadingState.querySelector('.loading-text');
      
      if (loadingText) {
        loadingText.textContent = message;
      }
      
      loadingState.style.display = 'block';
      document.getElementById('commentList').innerHTML = '';
      document.getElementById('noComments').style.display = 'none';
      
      // ã€ä¿®å¤ã€‘é”™è¯¯æ—¶ä¹Ÿè¦è§£é”è¯·æ±‚
      isRequestingComments = false;
      
      setTimeout(() => {
        loadingState.style.display = 'none';
      }, 2000);
    }

    function handleWorkStatusUpdate(data) {
      const workStatusInfo = document.getElementById('workStatusInfo');
      
      if (!data || !data.message) {
        workStatusInfo.style.display = 'none';
        return;
      }
      
      workStatusInfo.textContent = data.message;
      workStatusInfo.className = 'work-status-info';
      
      // æ ¹æ®çŠ¶æ€ç±»å‹æ·»åŠ ä¸åŒçš„æ ·å¼
      if (data.statusType === 'task') {
        workStatusInfo.classList.add('task');
      } else if (data.statusType === 'coldWork') {
        workStatusInfo.classList.add('cold-work');
      } else if (data.statusType === 'completedTask') {
        workStatusInfo.classList.add('completed-task');
      } else if (data.statusType === 'author') {
        workStatusInfo.classList.add('author');
      }
      
      workStatusInfo.style.display = 'block';
      console.log('[è¯„è®ºç³»ç»Ÿ] ä½œå“çŠ¶æ€æ›´æ–°:', data.message);
    }

    function handleSubmitProgress(data) {
      const statusEl = document.getElementById('submitStatus');
      
      statusEl.textContent = data.message || 'å¤„ç†ä¸­...';
      statusEl.className = 'submit-status show';
      
      // æ ¹æ®è¿›åº¦çŠ¶æ€è®¾ç½®ä¸åŒçš„èƒŒæ™¯è‰²
      if (data.stage === 'validating') {
        statusEl.style.background = 'rgba(255, 193, 7, 0.4)'; // é»„è‰² - éªŒè¯ä¸­
      } else if (data.stage === 'saving') {
        statusEl.style.background = 'rgba(33, 150, 243, 0.4)'; // è“è‰² - ä¿å­˜ä¸­
      } else if (data.stage === 'updating') {
        statusEl.style.background = 'rgba(156, 39, 176, 0.4)'; // ç´«è‰² - æ›´æ–°ä¸­
      } else {
        statusEl.style.background = 'rgba(255, 255, 255, 0.3)'; // é»˜è®¤
      }
      
      console.log('[è¯„è®ºç³»ç»Ÿ] æäº¤è¿›åº¦:', data.message);
    }

    function handleWorkSelectionState(data) {
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const submitBtn = document.getElementById('submitBtn');
      
      console.log('[è¯„è®ºç³»ç»Ÿ] å¤„ç†ä½œå“é€‰æ‹©çŠ¶æ€:', data);
      
      // ã€æ–°å¢ã€‘å–æ¶ˆåŠ è½½çŠ¶æ€
      setInputLoadingState(false);
      
      // æ ¹æ®çŠ¶æ€æ›´æ–°UI
      if (data.isAlreadyCommented && data.existingComment) {
        // å·²è¯„è®ºï¼šå›å¡«æ•°æ®å¹¶ç¦ç”¨è¾“å…¥
        commentField.value = data.existingComment.comment || '';
        inputScore.value = data.existingComment.score || '';
        commentField.disabled = true;
        inputScore.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'å·²è¯„è®º';
        console.log('[è¯„è®ºç³»ç»Ÿ] å·²è¯„è®ºï¼Œå›å¡«æ•°æ®å¹¶ç¦ç”¨è¾“å…¥');
      } else if (data.isAuthor) {
        // ä½œè€…è‡ªè¯„ï¼šæ¸…ç©ºå¹¶å¯ç”¨è¾“å…¥
        commentField.value = '';
        inputScore.value = '';
        commentField.disabled = false;
        inputScore.disabled = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'è‡ªè¯„';
        console.log('[è¯„è®ºç³»ç»Ÿ] ä½œè€…è‡ªè¯„æ¨¡å¼');
      } else if (data.isWorkDQ) {
        // æ·˜æ±°ä½œå“ï¼šæ¸…ç©ºå¹¶ç¦ç”¨æ‰€æœ‰
        commentField.value = '';
        inputScore.value = '';
        commentField.disabled = true;
        inputScore.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'ä½œå“å·²æ·˜æ±°';
        console.log('[è¯„è®ºç³»ç»Ÿ] ä½œå“å·²æ·˜æ±°');
      } else {
        // æ­£å¸¸æœªè¯„è®ºï¼šæ¸…ç©ºå¹¶å¯ç”¨è¾“å…¥
        commentField.value = '';
        inputScore.value = '';
        commentField.disabled = false;
        inputScore.disabled = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤è¯„è®º';
        console.log('[è¯„è®ºç³»ç»Ÿ] æ­£å¸¸çŠ¶æ€ï¼Œå¯ä»¥è¯„è®º');
      }
    }

    // ã€æ–°å¢ã€‘å¤„ç†è®¾ç½®ä½œå“ç­›é€‰å™¨çš„è¯·æ±‚ï¼ˆæ¥è‡ª"è·³è½¬åˆ°ä½œå“"æŒ‰é’®ï¼‰
    function handleSetWorkFilter(data) {
      const workNumber = data.workNumber;
      
      if (!workNumber) {
        console.warn('[è¯„è®ºç³»ç»Ÿ] è®¾ç½®ç­›é€‰å™¨å¤±è´¥ï¼šä½œå“ç¼–å·ä¸ºç©º');
        return;
      }
      
     // console.log(`[è¯„è®ºç³»ç»Ÿ] è®¾ç½®ç­›é€‰å™¨åˆ°ä½œå“ #${workNumber}`);
      
      // æ›´æ–°ç­›é€‰çŠ¶æ€
      currentWorkFilter = workNumber;
      currentPage = 1;
      
      // åŒæ­¥æ›´æ–°UIï¼ˆä½¿ç”¨ç¨‹åºè§¦å‘æ ‡è®°é¿å…é‡å¤åŠ è½½ï¼‰
      const dropdownFilter = document.getElementById('dropdownFilter');
      if (dropdownFilter) {
        dropdownFilter.dataset.programmaticChange = 'true';
        dropdownFilter.value = workNumber;
      }
      
      // åŠ è½½è¯¥ä½œå“çš„è¯„è®º
      showLoading(`æ­£åœ¨åŠ è½½ä½œå“ #${workNumber} çš„è¯„è®º...`);
      requestCommentsData();
    }

    function resetWorkSelection() {
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const submitBtn = document.getElementById('submitBtn');
      const workStatusInfo = document.getElementById('workStatusInfo');
      
      // ã€ä¿®å¤ã€‘æ¸…é™¤åŠ è½½è®¡æ—¶å™¨ï¼Œé˜²æ­¢è¶…æ—¶è­¦å‘Šåœ¨é‡ç½®åè§¦å‘
      if (loadingTimeout) {
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
        console.log('[è¯„è®ºç³»ç»Ÿ] å·²æ¸…é™¤åŠ è½½è®¡æ—¶å™¨');
      }
      
      // æ¸…ç©ºè¾“å…¥
      commentField.value = '';
      inputScore.value = '';
      
      // éšè—ä½œå“çŠ¶æ€ä¿¡æ¯
      workStatusInfo.style.display = 'none';
      
      // æ ¹æ®ç™»å½•å’ŒéªŒè¯çŠ¶æ€æ¢å¤é»˜è®¤çŠ¶æ€
      if (!currentUserId) {
        commentField.disabled = true;
        inputScore.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æœªç™»å½•';
      } else if (!isUserVerified) {
        commentField.disabled = true;
        inputScore.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æœªæŠ¥å';
      } else {
        commentField.disabled = false;
        inputScore.disabled = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤è¯„è®º';
      }
      
      console.log('[è¯„è®ºç³»ç»Ÿ] å·²é‡ç½®ä½œå“é€‰æ‹©çŠ¶æ€');
    }

    function handleSubmitResult(data) {
      isSubmitting = false;
      const statusEl = document.getElementById('submitStatus');
      const submitBtn = document.getElementById('submitBtn');
      const inputNumber = document.getElementById('inputNumber');
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const workStatusInfo = document.getElementById('workStatusInfo');
      
      // ã€ä¿®å¤ã€‘æ¸…é™¤å¯èƒ½å­˜åœ¨çš„åŠ è½½è®¡æ—¶å™¨
      if (loadingTimeout) {
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
        console.log('[è¯„è®ºç³»ç»Ÿ] æäº¤å®Œæˆï¼Œå·²æ¸…é™¤åŠ è½½è®¡æ—¶å™¨');
      }
      
      if (data.success) {
        showStatus(data.message || 'âœ… æäº¤æˆåŠŸï¼', 'success');
        
        // æ¸…ç©ºæ‰€æœ‰è¾“å…¥
        inputNumber.value = '';
        inputScore.value = '';
        commentField.value = '';
        
        // éšè—ä½œå“çŠ¶æ€ä¿¡æ¯
        workStatusInfo.style.display = 'none';
        
        // å®Œæ•´é‡ç½®çŠ¶æ€ï¼šæ ¹æ®ç”¨æˆ·ç™»å½•å’ŒéªŒè¯çŠ¶æ€æ¢å¤é»˜è®¤çŠ¶æ€
        if (!currentUserId) {
          inputNumber.disabled = true;
          inputScore.disabled = true;
          commentField.disabled = true;
          submitBtn.disabled = true;
          submitBtn.textContent = 'æœªç™»å½•';
        } else if (!isUserVerified) {
          inputNumber.disabled = true;
          inputScore.disabled = true;
          commentField.disabled = true;
          submitBtn.disabled = true;
          submitBtn.textContent = 'æœªæŠ¥å';
        } else {
          inputNumber.disabled = false;
          inputScore.disabled = false;
          commentField.disabled = false;
          submitBtn.disabled = false;
          submitBtn.textContent = 'æäº¤è¯„è®º';
        }
        
        // ç«‹å³åˆ·æ–°è¯„è®ºåˆ—è¡¨ï¼ˆç¡®ä¿æ–°è¯„è®ºç«‹å³æ˜¾ç¤ºï¼‰
        requestCommentsData();
      } else {
        // æäº¤å¤±è´¥æ—¶é‡æ–°å¯ç”¨æŒ‰é’®
        submitBtn.disabled = false;
        showStatus(data.message || 'âŒ æäº¤å¤±è´¥', 'error');
      }
    }

    // ==================== è¾“å…¥åŒºåŸŸ ====================
    function updateInputState() {
      const inputNumber = document.getElementById('inputNumber');
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const submitBtn = document.getElementById('submitBtn');

      if (!currentUserId) {
        inputNumber.disabled = true;
        inputScore.disabled = true;
        commentField.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æœªç™»å½•';
        return;
      }

      if (!isUserVerified) {
        inputNumber.disabled = true;
        inputScore.disabled = true;
        commentField.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æœªæŠ¥å';
        return;
      }

      inputNumber.disabled = false;
      inputScore.disabled = false;
      commentField.disabled = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'æäº¤è¯„è®º';
    }

    function updateWorkDropdowns() {
      const inputNumber = document.getElementById('inputNumber');
      const dropdownFilter = document.getElementById('dropdownFilter');
      
      // æ›´æ–°æäº¤ä½œå“é€‰æ‹©å™¨
      inputNumber.innerHTML = '<option value="">è¯·é€‰æ‹©ä½œå“ç¼–å·</option>' +
        allWorkOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
      
      // æ›´æ–°ç­›é€‰ä½œå“é€‰æ‹©å™¨
      dropdownFilter.innerHTML = '<option value="">æ˜¾ç¤ºæ‰€æœ‰è¯„è®º</option>' +
        allWorkOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
    }

    function showStatus(message, type = '') {
      const statusEl = document.getElementById('submitStatus');
      statusEl.textContent = message;
      statusEl.className = 'submit-status show';
      statusEl.style.background = type === 'success' 
        ? 'rgba(76, 175, 80, 0.4)' 
        : type === 'error' 
        ? 'rgba(244, 67, 54, 0.4)' 
        : 'rgba(255, 255, 255, 0.3)';
      
      setTimeout(() => {
        statusEl.classList.remove('show');
      }, 3000);
    }

    // ==================== äº‹ä»¶ç›‘å¬ ====================
    // å®æ—¶Markdowné¢„è§ˆ
    document.getElementById('Comment').addEventListener('input', updateMarkdownPreview);

    // æäº¤æŒ‰é’®
    document.getElementById('submitBtn').addEventListener('click', () => {
      if (isSubmitting) return;
      
      const workNumber = document.getElementById('inputNumber').value;
      const score = document.getElementById('inputScore').value;
      const comment = document.getElementById('Comment').value;

      // éªŒè¯è¾“å…¥å®Œæ•´æ€§
      if (!workNumber || !score || !comment) {
        showStatus('âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
        return;
      }

      // éªŒè¯ä½œå“ç¼–å·èŒƒå›´
      const workNum = parseInt(workNumber);
      if (isNaN(workNum) || workNum < 1 || workNum > 500) {
        showStatus('âŒ ä½œå“ç¼–å·å¿…é¡»åœ¨1-500ä¹‹é—´', 'error');
        return;
      }

      // éªŒè¯è¯„åˆ†èŒƒå›´
      const scoreNum = parseInt(score);
      if (isNaN(scoreNum) || scoreNum < 100 || scoreNum > 1000) {
        showStatus('âŒ è¯„åˆ†å¿…é¡»åœ¨100-1000ä¹‹é—´', 'error');
        return;
      }

      // éªŒè¯è¯„è®ºå†…å®¹ä¸ä¸ºç©º
      if (comment.trim().length === 0) {
        showStatus('âŒ è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
        return;
      }

      isSubmitting = true;
      document.getElementById('submitBtn').disabled = true;
      showStatus('æ­£åœ¨æäº¤...', '');

      // å‘é€æäº¤è¯·æ±‚åˆ°Wixé¡µé¢
      window.parent.postMessage({
        type: 'SUBMIT_COMMENT',
        data: {
          workNumber: workNum,
          score: scoreNum,
          comment: comment.trim()
        }
      }, '*');
    });

    // ä½œå“ç¼–å·é€‰æ‹© - å®Œæ•´çš„çŠ¶æ€å¤„ç†
    document.getElementById('inputNumber').addEventListener('change', async (e) => {
      const workNumber = e.target.value;
      
      if (workNumber) {
        // ã€æ–°å¢ã€‘ç«‹å³ç¦ç”¨è¾“å…¥ç»„ä»¶å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        setInputLoadingState(true, 'æ­£åœ¨æ£€æŸ¥ä½œå“çŠ¶æ€...');
        
        // é€šçŸ¥Wixé¡µé¢ä½œå“ç¼–å·å˜åŒ–ï¼Œè·å–å®Œæ•´çš„ä½œå“çŠ¶æ€
        window.parent.postMessage({
          type: 'WORK_NUMBER_CHANGED',
          data: { workNumber: parseInt(workNumber) }
        }, '*');
        
        // ã€ä¿®å¤ã€‘åŒæ­¥æ›´æ–°ç­›é€‰å™¨ï¼Œä½†é¿å…è§¦å‘å…¶changeäº‹ä»¶ï¼ˆé˜²æ­¢å¾ªç¯ï¼‰
        const dropdownFilter = document.getElementById('dropdownFilter');
        if (dropdownFilter.value !== workNumber) {
          // æ ‡è®°ä¸ºç¨‹åºè§¦å‘ï¼Œé¿å…é‡å¤åŠ è½½
          dropdownFilter.dataset.programmaticChange = 'true';
          dropdownFilter.value = workNumber;
          currentWorkFilter = workNumber;
          currentPage = 1;
          requestCommentsData();
        }
      } else {
        // æ¸…ç©ºé€‰æ‹©æ—¶é‡ç½®çŠ¶æ€
        resetWorkSelection();
        
        // ã€ä¿®å¤ã€‘åŒæ­¥æ¸…ç©ºç­›é€‰å™¨
        const dropdownFilter = document.getElementById('dropdownFilter');
        if (dropdownFilter.value !== '') {
          dropdownFilter.dataset.programmaticChange = 'true';
          dropdownFilter.value = '';
          currentWorkFilter = '';
        }
        
        // é‡æ–°åŠ è½½æ‰€æœ‰è¯„è®º
        currentPage = 1;
        requestCommentsData();
      }
    });

    // ä½œå“ç­›é€‰
    document.getElementById('dropdownFilter').addEventListener('change', (e) => {
      // ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºç¨‹åºè§¦å‘ï¼ˆæ¥è‡ªinputNumberçš„åŒæ­¥ï¼‰ï¼Œé¿å…é‡å¤åŠ è½½
      if (e.target.dataset.programmaticChange === 'true') {
        delete e.target.dataset.programmaticChange;
        console.log('[è¯„è®ºç³»ç»Ÿ] è·³è¿‡ç¨‹åºè§¦å‘çš„ç­›é€‰å™¨å˜åŒ–');
        return;
      }
      
      currentWorkFilter = e.target.value;
      currentPage = 1;
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const message = currentWorkFilter 
        ? `æ­£åœ¨åŠ è½½ä½œå“ #${currentWorkFilter} çš„è¯„è®º...` 
        : 'æ­£åœ¨åŠ è½½æ‰€æœ‰è¯„è®º...';
      showLoading(message);
      
      requestCommentsData();
    });

    // è¯„è®ºç±»å‹ç­›é€‰
    let isFilterChanging = false; // ã€æ–°å¢ã€‘é˜²æ­¢å¿«é€Ÿé‡å¤ç‚¹å‡»
    
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', async () => {
        // ã€ä¿®å¤ã€‘å·²é€‰ä¸­æˆ–æ­£åœ¨åˆ‡æ¢ï¼Œæ— éœ€é‡å¤æ“ä½œ
        if (tab.classList.contains('active') || isFilterChanging) {
          console.log('[è¯„è®ºç³»ç»Ÿ] è·³è¿‡é‡å¤çš„ç­›é€‰æ“ä½œ');
          return;
        }
        
        isFilterChanging = true;
        
        // æ›´æ–°UIçŠ¶æ€
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const newFilter = tab.dataset.filter;
        
        // ã€ä¿®å¤ã€‘åªæœ‰çœŸæ­£æ”¹å˜ç­›é€‰æ¨¡å¼æ—¶æ‰é‡æ–°åŠ è½½
        if (currentFilter !== newFilter) {
          currentFilter = newFilter;
          currentPage = 1;
          
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€å¹¶è¯·æ±‚æ•°æ®
          showLoading('æ­£åœ¨åˆ‡æ¢ç­›é€‰æ¨¡å¼...');
          requestCommentsData();
          
          // å»¶è¿Ÿè§£é”ï¼Œé˜²æ­¢å¿«é€Ÿé‡å¤ç‚¹å‡»
          setTimeout(() => {
            isFilterChanging = false;
          }, 500);
        } else {
          isFilterChanging = false;
        }
      });
    });

    // åˆ†é¡µæŒ‰é’®
    ['Top', 'Bottom'].forEach(suffix => {
      document.getElementById(`prevBtn${suffix}`).addEventListener('click', () => {
        // ã€ä¿®å¤ã€‘æ·»åŠ é˜²é‡å¤ç‚¹å‡»ä¿æŠ¤
        if (currentPage > 1 && !isRequestingComments) {
          currentPage--;
          showLoading('æ­£åœ¨åŠ è½½ä¸Šä¸€é¡µè¯„è®º...');
          requestCommentsData();
        }
      });

      document.getElementById(`nextBtn${suffix}`).addEventListener('click', () => {
        // ã€ä¿®å¤ã€‘æ·»åŠ é˜²é‡å¤ç‚¹å‡»ä¿æŠ¤
        if (currentPage < totalPages && !isRequestingComments) {
          currentPage++;
          showLoading('æ­£åœ¨åŠ è½½æ›´å¤šè¯„è®º...');
          requestCommentsData();
        }
      });

      // ã€æ–°å¢ã€‘é¡µç ç‚¹å‡»è·³è½¬åŠŸèƒ½
      document.getElementById(`pageInfo${suffix}`).addEventListener('click', () => {
        if (isRequestingComments || totalPages <= 1) {
          return; // æ­£åœ¨åŠ è½½æˆ–åªæœ‰ä¸€é¡µæ—¶ä¸å“åº”
        }

        const inputPage = prompt(`è¯·è¾“å…¥é¡µç ï¼ˆ1-${totalPages}ï¼‰:`, currentPage.toString());
        
        if (inputPage === null) {
          return; // ç”¨æˆ·å–æ¶ˆ
        }

        const targetPage = parseInt(inputPage.trim());
        
        // éªŒè¯è¾“å…¥
        if (isNaN(targetPage)) {
          alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
          return;
        }
        
        if (targetPage < 1 || targetPage > totalPages) {
          alert(`âŒ é¡µç å¿…é¡»åœ¨ 1-${totalPages} ä¹‹é—´`);
          return;
        }

        if (targetPage === currentPage) {
          return; // å·²ç»åœ¨å½“å‰é¡µï¼Œæ— éœ€è·³è½¬
        }

        // è·³è½¬åˆ°ç›®æ ‡é¡µ
        currentPage = targetPage;
        showLoading(`æ­£åœ¨åŠ è½½ç¬¬ ${targetPage} é¡µ...`);
        requestCommentsData();
        
        console.log(`[è¯„è®ºç³»ç»Ÿ] è·³è½¬åˆ°ç¬¬ ${targetPage} é¡µ`);
      });
    });

    // ==================== è¯„è®ºæ˜¾ç¤º ====================
    function renderCurrentPage() {
      const commentList = document.getElementById('commentList');
      const loadingState = document.getElementById('loadingState');
      const noComments = document.getElementById('noComments');

      currentPage = Math.min(currentPage, totalPages);

      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      updatePagination();

      // ç«‹å³æ¸²æŸ“ï¼ˆåŠ è½½çŠ¶æ€å·²åœ¨requestCommentsDataä¸­æ˜¾ç¤ºï¼‰
      loadingState.style.display = 'none';

      if (!allCommentsData || allCommentsData.length === 0) {
        noComments.style.display = 'block';
        commentList.innerHTML = '';
      } else {
        noComments.style.display = 'none';
        renderComments(allCommentsData);
      }
      
      // ã€ä¿®å¤ã€‘æ¸²æŸ“å®Œæˆåè§£é”è¯·æ±‚é”
      isRequestingComments = false;
      // console.log('[è¯„è®ºç³»ç»Ÿ] è¯„è®ºæ¸²æŸ“å®Œæˆï¼Œå·²è§£é”è¯·æ±‚');
    }

    function updatePagination() {
      ['Top', 'Bottom'].forEach(suffix => {
        const prevBtn = document.getElementById(`prevBtn${suffix}`);
        const nextBtn = document.getElementById(`nextBtn${suffix}`);
        const pageInfo = document.getElementById(`pageInfo${suffix}`);

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
        pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
      });
    }

    function renderComments(comments) {
      const commentList = document.getElementById('commentList');
      commentList.innerHTML = '';

      comments.forEach(comment => {
        const commentEl = createCommentElement(comment);
        commentList.appendChild(commentEl);
      });
    }

    function createCommentElement(comment) {
      const div = document.createElement('div');
      div.className = 'comment-item';

      // æ„å»ºè¯„åˆ†å¾½ç« 
      const scoreBadgeHTML = createScoreBadge(comment);

      // æ„å»ºæ“ä½œæŒ‰é’®
      const actionsHTML = createActionButtons(comment);

      // æ¸²æŸ“è¯„è®ºå†…å®¹ï¼ˆæ”¯æŒMarkdownï¼‰
      const commentContentHTML = renderMarkdown(comment.commentText || 'æ— å†…å®¹');
      
      // æ ¼å¼åŒ–æ—¶é—´
      const formattedTime = formatCommentTime(comment.createdDate);
      
      div.innerHTML = `
        <div class="comment-header">
          ${scoreBadgeHTML}
          <div class="comment-work-title">${escapeHtml(comment.workTitle || `#${comment.workNumber}`)}</div>
          ${comment.ratingInfo ? `<div class="comment-rating-info">${escapeHtml(comment.ratingInfo)}</div>` : ''}
          <div class="comment-time">${formattedTime}</div>
        </div>
        <div class="comment-content" data-full-text="${escapeHtml(comment.commentText || 'æ— å†…å®¹')}">${commentContentHTML}</div>
        <div class="comment-actions">
          ${actionsHTML}
          ${comment.replyCount > 0 ? `<span class="reply-count">${comment.replyCount}æ¡å›å¤</span>` : ''}
        </div>
      `;

      // ç»‘å®šäº‹ä»¶
      bindCommentActions(div, comment);
      
      // æ£€æŸ¥è¯„è®ºå†…å®¹æ˜¯å¦éœ€è¦å±•å¼€åŠŸèƒ½
      const commentContent = div.querySelector('.comment-content');
      if (commentContent) {
        // ã€æ–°å¢ã€‘è®¾ç½® ResizeObserver ç›‘æ§å†…å®¹é«˜åº¦å˜åŒ–
        setupResizeObserver(commentContent);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡ï¼Œå¦‚æœæœ‰åˆ™ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåå†æ£€æŸ¥é«˜åº¦
        const images = commentContent.querySelectorAll('img');
        if (images.length > 0) {
          let loadedImages = 0;
          const totalImages = images.length;
          let hasChecked = false; // é˜²æ­¢é‡å¤æ£€æŸ¥
          
          const performCheck = () => {
            if (!hasChecked) {
              hasChecked = true;
              checkContentOverflow(commentContent);
            }
          };
          
          // ä¸ºæ¯ä¸ªå›¾ç‰‡æ·»åŠ åŠ è½½äº‹ä»¶ç›‘å¬
          images.forEach(img => {
            // å¦‚æœå›¾ç‰‡å·²ç»åŠ è½½å®Œæˆ
            if (img.complete) {
              loadedImages++;
              if (loadedImages === totalImages) {
                performCheck();
              }
            } else {
              // ç›‘å¬å›¾ç‰‡åŠ è½½å®Œæˆäº‹ä»¶
              img.addEventListener('load', () => {
                loadedImages++;
                if (loadedImages === totalImages) {
                  performCheck();
                }
              });
              
              // ç›‘å¬å›¾ç‰‡åŠ è½½å¤±è´¥äº‹ä»¶
              img.addEventListener('error', () => {
                loadedImages++;
                if (loadedImages === totalImages) {
                  performCheck();
                }
              });
            }
          });
          
          // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼Œé˜²æ­¢å›¾ç‰‡åŠ è½½å¡ä½ï¼ˆå‡å°‘åˆ°2ç§’ï¼‰
          setTimeout(() => {
            if (!hasChecked) {
              console.warn('[è¯„è®ºç³»ç»Ÿ] å›¾ç‰‡åŠ è½½è¶…æ—¶ï¼Œå¼ºåˆ¶æ£€æŸ¥å†…å®¹é«˜åº¦');
              performCheck();
            }
          }, 2000);
          
          // ã€æ–°å¢ã€‘é¢å¤–çš„å»¶è¿Ÿæ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿åœ¨å¤æ‚æƒ…å†µä¸‹ä¹Ÿèƒ½æ­£ç¡®æ£€æµ‹
          setTimeout(() => {
            checkContentOverflow(commentContent);
          }, 2500);
        } else {
          // æ²¡æœ‰å›¾ç‰‡ï¼Œç«‹å³æ£€æŸ¥é«˜åº¦
          checkContentOverflow(commentContent);
          
          // ã€æ–°å¢ã€‘å»¶è¿Ÿå†æ¬¡æ£€æŸ¥ï¼Œç¡®ä¿å¤æ‚Markdownæ¸²æŸ“å®Œæˆ
          setTimeout(() => {
            checkContentOverflow(commentContent);
          }, 100);
        }
      }

      return div;
    }

    function createScoreBadge(comment) {
      let badgeClass = 'comment-score-badge';
      let badgeText = '';
      let badgeStyle = '';

      if (comment.isReply) {
        badgeText = 'Re';
        badgeStyle = 'background: #1E3A8A;';
      } else if (comment.isAuthorComment) {
        badgeText = 'Sc';
        badgeStyle = 'background: #8A2BE2;';
      } else if (comment.showScore) {
        badgeText = comment.score;
        const redAmount = Math.floor((comment.score / 1000) * 255);
        badgeStyle = `background: rgb(${redAmount}, 0, 0);`;
      } else {
        badgeText = '?';
        badgeStyle = 'background: #A9A9A9;';
      }

      return `<div class="${badgeClass}" style="${badgeStyle}">${badgeText}</div>`;
    }

    function createActionButtons(comment) {
      let buttons = [];

      // è·³è½¬åˆ°ä½œå“æŒ‰é’®ï¼ˆä»…ä¸»è¯„è®ºï¼‰
      if (!comment.isReply) {
        // æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»åœ¨è¯¥ä½œå“çš„ç­›é€‰ä¸‹
        const isCurrentlyFiltered = currentWorkFilter === comment.workNumber.toString();
        const disabledAttr = isCurrentlyFiltered ? ' disabled title="å·²åœ¨è¯¥ä½œå“ç­›é€‰ä¸‹"' : '';
        buttons.push(`<button class="action-btn goto-work-btn"${disabledAttr}>è·³è½¬åˆ°ä½œå“</button>`);
      }

      // æŸ¥çœ‹å›å¤æŒ‰é’®
      buttons.push(`<button class="action-btn view-replies-btn">${comment.isReply ? 'æŸ¥çœ‹ä¸»è¯„è®º' : 'æŸ¥çœ‹å›å¤'}</button>`);

      // åˆ é™¤æŒ‰é’®
      if (comment.canDelete) {
        buttons.push(`<button class="action-btn delete delete-btn">åˆ é™¤</button>`);
      }

      return buttons.join('');
    }

    function bindCommentActions(element, comment) {
      // è¯„è®ºå†…å®¹ç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼ˆä»…é•¿è¯„è®ºï¼‰
      const commentContent = element.querySelector('.comment-content');
      if (commentContent) {
        commentContent.addEventListener('click', (e) => {
          // é˜²æ­¢ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘å±•å¼€
          if (e.target.tagName === 'BUTTON') return;
          
          // ç‚¹å‡»å›¾ç‰‡æ—¶åœ¨æ–°æ ‡ç­¾æ‰“å¼€
          if (e.target.tagName === 'IMG') {
            e.stopPropagation();
            const imgSrc = e.target.src;
            if (imgSrc) {
              window.open(imgSrc, '_blank', 'noopener,noreferrer');
              console.log('[è¯„è®ºç³»ç»Ÿ] åœ¨æ–°æ ‡ç­¾æ‰“å¼€å›¾ç‰‡:', imgSrc);
            }
            return;
          }
          
          // ç‚¹å‡»é“¾æ¥æ—¶ä¸è§¦å‘å±•å¼€
          if (e.target.tagName === 'A') {
            e.stopPropagation();
            return;
          }
          
          // å¦‚æœæ˜¯çŸ­å†…å®¹ï¼ˆæ— éœ€å±•å¼€ï¼‰ï¼Œç›´æ¥è¿”å›
          if (commentContent.classList.contains('short')) {
            return;
          }
          
          // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å±•å¼€/æ”¶èµ·æŒ‰é’®åŒºåŸŸï¼ˆ::after ä¼ªå…ƒç´ åŒºåŸŸï¼‰
          const rect = commentContent.getBoundingClientRect();
          const clickY = e.clientY;
          const bottomThreshold = rect.bottom - 40; // åº•éƒ¨40pxåŒºåŸŸè§†ä¸ºå±•å¼€æŒ‰é’®åŒºåŸŸ
          
          // åªæœ‰æœ‰æº¢å‡ºçš„è¯„è®ºæ‰èƒ½å±•å¼€/æ”¶èµ·
          if (commentContent.classList.contains('has-overflow') || commentContent.classList.contains('expanded')) {
            commentContent.classList.toggle('expanded');
            //console.log('[è¯„è®ºç³»ç»Ÿ] è¯„è®ºå†…å®¹å·²' + (commentContent.classList.contains('expanded') ? 'å±•å¼€' : 'æ”¶èµ·'));
            
            // å¦‚æœæ˜¯å±•å¼€æ“ä½œï¼Œæ»šåŠ¨åˆ°è¯„è®ºä½ç½®ä»¥ä¾¿æŸ¥çœ‹å®Œæ•´å†…å®¹
            if (commentContent.classList.contains('expanded')) {
              setTimeout(() => {
                commentContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }, 100);
            }
          }
        });
      }

      // è·³è½¬åˆ°ä½œå“
      const gotoWorkBtn = element.querySelector('.goto-work-btn');
      if (gotoWorkBtn && !gotoWorkBtn.disabled) {
        gotoWorkBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // é˜²æ­¢è§¦å‘è¯„è®ºå±•å¼€
          
          window.parent.postMessage({
            type: 'GOTO_WORK',
            data: { workNumber: comment.workNumber }
          }, '*');
          
          console.log('[è¯„è®ºç³»ç»Ÿ] è¯·æ±‚è·³è½¬åˆ°ä½œå“ #' + comment.workNumber);
        });
      }

      // æŸ¥çœ‹å›å¤
      const viewRepliesBtn = element.querySelector('.view-replies-btn');
      if (viewRepliesBtn) {
        viewRepliesBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // é˜²æ­¢è§¦å‘è¯„è®ºå±•å¼€
          
          window.parent.postMessage({
            type: 'VIEW_REPLIES',
            data: {
              commentId: comment.commentId,
              workNumber: comment.workNumber,
              originalComment: comment.commentText,
              isReply: comment.isReply,
              replyTo: comment.replyTo
            }
          }, '*');
          
          console.log('[è¯„è®ºç³»ç»Ÿ] è¯·æ±‚æŸ¥çœ‹å›å¤');
        });
      }

      // åˆ é™¤è¯„è®º
      const deleteBtn = element.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // é˜²æ­¢è§¦å‘è¯„è®ºå±•å¼€
          
          window.parent.postMessage({
            type: 'DELETE_COMMENT',
            data: {
              commentId: comment.commentId,
              workNumber: comment.workNumber,
              score: comment.score,
              comment: comment.commentText,
              isSelfScComment: comment.isSelfScComment,
              _owner: comment._owner
            }
          }, '*');
        });
      }
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    /**
     * æ ¼å¼åŒ–è¯„è®ºæ—¶é—´ä¸ºå‹å¥½çš„æ˜¾ç¤ºæ ¼å¼
     * @param {string|Date} dateInput - æ—¥æœŸå¯¹è±¡æˆ–ISOæ—¥æœŸå­—ç¬¦ä¸²
     * @returns {string} æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
     */
    function formatCommentTime(dateInput) {
      if (!dateInput) {
        return 'æœªçŸ¥æ—¶é—´';
      }
      
      try {
        const date = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;
        
        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        if (isNaN(date.getTime())) {
          return 'æ— æ•ˆæ—¥æœŸ';
        }
        
        const now = new Date();
        const diffMs = now - date;
        const diffSeconds = Math.floor(diffMs / 1000);
        const diffMinutes = Math.floor(diffSeconds / 60);
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        // ç›¸å¯¹æ—¶é—´æ˜¾ç¤ºï¼ˆ1å‘¨å†…ï¼‰
        if (diffSeconds < 60) {
          return 'åˆšåˆš';
        } else if (diffMinutes < 60) {
          return `${diffMinutes}åˆ†é’Ÿå‰`;
        } else if (diffHours < 24) {
          return `${diffHours}å°æ—¶å‰`;
        } else if (diffDays === 1) {
          return 'æ˜¨å¤©';
        } else if (diffDays === 2) {
          return 'å‰å¤©';
        } else if (diffDays < 7) {
          return `${diffDays}å¤©å‰`;
        }
        
        // ç»å¯¹æ—¶é—´æ˜¾ç¤ºï¼ˆ1å‘¨ä»¥ä¸Šï¼‰
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        // å¦‚æœæ˜¯ä»Šå¹´ï¼Œä¸æ˜¾ç¤ºå¹´ä»½
        const currentYear = now.getFullYear();
        if (year === currentYear) {
          return `${month}-${day} ${hours}:${minutes}`;
        } else {
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
      } catch (error) {
        console.error('[è¯„è®ºç³»ç»Ÿ] æ—¶é—´æ ¼å¼åŒ–å¤±è´¥:', error);
        return 'æ—¶é—´é”™è¯¯';
      }
    }
    
    /**
     * æ£€æŸ¥è¯„è®ºå†…å®¹æ˜¯å¦æº¢å‡ºå¹¶æ·»åŠ ç›¸åº”çš„æ ·å¼ç±»
     * @param {HTMLElement} commentContent - è¯„è®ºå†…å®¹å…ƒç´ 
     */
    function checkContentOverflow(commentContent) {
      // å¦‚æœå·²ç»å±•å¼€ï¼Œä¸é‡æ–°æ£€æŸ¥
      if (commentContent.classList.contains('expanded')) {
        return;
      }
      
      // ç§»é™¤ä¹‹å‰çš„ç±»ï¼ˆé˜²æ­¢é‡å¤æ£€æŸ¥æ—¶çš„çŠ¶æ€å†²çªï¼‰
      commentContent.classList.remove('has-overflow', 'short');
      
      // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM å®Œå…¨æ¸²æŸ“åå†æ£€æŸ¥
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          // æ£€æŸ¥å†…å®¹æ˜¯å¦æº¢å‡ºï¼ˆè¶…è¿‡120pxé«˜åº¦ï¼Œæ·»åŠ 5pxå®¹å·®ï¼‰
          const hasOverflow = commentContent.scrollHeight > (commentContent.clientHeight + 5);
          
          if (hasOverflow) {
            commentContent.classList.add('has-overflow');
            // console.log('[è¯„è®ºç³»ç»Ÿ] æ£€æµ‹åˆ°å†…å®¹æº¢å‡ºï¼Œæ·»åŠ å±•å¼€åŠŸèƒ½', {
            //   scrollHeight: commentContent.scrollHeight,
            //   clientHeight: commentContent.clientHeight
            // });
          } else {
            commentContent.classList.add('short');
            // console.log('[è¯„è®ºç³»ç»Ÿ] å†…å®¹è¾ƒçŸ­ï¼Œæ— éœ€å±•å¼€', {
            //   scrollHeight: commentContent.scrollHeight,
            //   clientHeight: commentContent.clientHeight
            // });
          }
        });
      });
    }
    
    /**
     * ä½¿ç”¨ ResizeObserver ç›‘æ§è¯„è®ºå†…å®¹é«˜åº¦å˜åŒ–
     * @param {HTMLElement} commentContent - è¯„è®ºå†…å®¹å…ƒç´ 
     */
    function setupResizeObserver(commentContent) {
      // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ ResizeObserver
      if (!window.ResizeObserver) {
        return;
      }
      
      // åˆ›å»º ResizeObserver å®ä¾‹
      const resizeObserver = new ResizeObserver((entries) => {
        for (const entry of entries) {
          // å†…å®¹å°ºå¯¸å˜åŒ–æ—¶é‡æ–°æ£€æŸ¥æº¢å‡ºçŠ¶æ€
          checkContentOverflow(entry.target);
        }
      });
      
      // å¼€å§‹è§‚å¯Ÿ
      resizeObserver.observe(commentContent);
    }

    /**
     * è®¾ç½®è¾“å…¥åŒºåŸŸçš„åŠ è½½çŠ¶æ€
     * @param {boolean} isLoading - æ˜¯å¦æ­£åœ¨åŠ è½½
     * @param {string} message - åŠ è½½æç¤ºä¿¡æ¯
     */
    function setInputLoadingState(isLoading, message = '') {
      const inputScore = document.getElementById('inputScore');
      const commentField = document.getElementById('Comment');
      const submitBtn = document.getElementById('submitBtn');
      const workStatusInfo = document.getElementById('workStatusInfo');
      
      // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶è®¡æ—¶å™¨
      if (loadingTimeout) {
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
      }
      
      if (isLoading) {
        // ç¦ç”¨æ‰€æœ‰è¾“å…¥ç»„ä»¶
        inputScore.disabled = true;
        commentField.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'åŠ è½½ä¸­...';
        
        // æ¸…ç©ºè¾“å…¥æ¡†å†…å®¹ï¼ˆé¿å…æ˜¾ç¤ºæ—§æ•°æ®ï¼‰
        inputScore.value = '';
        commentField.value = '';
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€æç¤ºï¼ˆå¸¦spinneråŠ¨ç”»ï¼‰
        if (message) {
          workStatusInfo.innerHTML = `<div class="inline-spinner"></div><span>${message}</span>`;
          workStatusInfo.className = 'work-status-info loading';
          workStatusInfo.style.display = 'block';
        }
        
        // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼ˆ10ç§’åè‡ªåŠ¨æ¢å¤ï¼Œé˜²æ­¢å¡æ­»ï¼‰
        loadingTimeout = setTimeout(() => {
          console.warn('[è¯„è®ºç³»ç»Ÿ] åŠ è½½è¶…æ—¶ï¼Œè‡ªåŠ¨æ¢å¤è¾“å…¥çŠ¶æ€');
          workStatusInfo.innerHTML = 'âš ï¸ åŠ è½½è¶…æ—¶ï¼Œè¯·é‡æ–°é€‰æ‹©ä½œå“æˆ–åˆ·æ–°é¡µé¢';
          workStatusInfo.className = 'work-status-info';
          workStatusInfo.style.background = 'rgba(255, 152, 0, 0.4)';
          workStatusInfo.style.border = '1px solid rgba(255, 152, 0, 0.6)';
          
          // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆä½†ä¿æŒè¾“å…¥æ¡†ç¦ç”¨ï¼Œç›´åˆ°é‡æ–°é€‰æ‹©ï¼‰
          if (currentUserId && isUserVerified) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'æäº¤è¯„è®º';
          }
          
          loadingTimeout = null;
        }, 10000); // 10ç§’è¶…æ—¶
        
        console.log('[è¯„è®ºç³»ç»Ÿ] å·²è®¾ç½®åŠ è½½çŠ¶æ€:', message);
      } else {
        // å–æ¶ˆåŠ è½½çŠ¶æ€ï¼ˆå…·ä½“çŠ¶æ€ç”±handleWorkSelectionStateæ§åˆ¶ï¼‰
        // è¿™é‡Œåªæ˜¯ç§»é™¤åŠ è½½æç¤ºï¼Œä¸æ”¹å˜è¾“å…¥æ¡†çŠ¶æ€
        console.log('[è¯„è®ºç³»ç»Ÿ] å·²å–æ¶ˆåŠ è½½çŠ¶æ€');
      }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function isSafeUrl(url) {
      if (!url) return false;
      const value = url.trim().toLowerCase();
      if (value.startsWith('javascript:') || value.startsWith('vbscript:')) {
        return false;
      }
      if (value.startsWith('data:') && !value.startsWith('data:image/')) {
        return false;
      }
      return true;
    }

    function sanitizeMarkdownHtml(html) {
      const template = document.createElement('template');
      template.innerHTML = html;

      const forbiddenTags = new Set(['script', 'style', 'link', 'iframe', 'object', 'embed', 'base', 'meta']);
      const nodesToRemove = [];
      const walker = document.createTreeWalker(template.content, NodeFilter.SHOW_ELEMENT, null);

      while (walker.nextNode()) {
        const element = walker.currentNode;
        const tagName = element.tagName.toLowerCase();
        if (forbiddenTags.has(tagName)) {
          nodesToRemove.push(element);
          continue;
        }

        for (const attr of Array.from(element.attributes)) {
          const name = attr.name.toLowerCase();
          if (name === 'style' || name.startsWith('on')) {
            element.removeAttribute(attr.name);
            continue;
          }
          if ((name === 'href' || name === 'src') && !isSafeUrl(attr.value)) {
            element.removeAttribute(attr.name);
          }
        }
      }

      for (const node of nodesToRemove) {
        node.remove();
      }

      return template.innerHTML;
    }

    function renderMarkdown(text) {
      if (!text) return '';
      
      // å¦‚æœmarkedåº“å¯ç”¨ï¼Œä½¿ç”¨Markdownæ¸²æŸ“
      if (typeof marked !== 'undefined') {
        try {
          // ä½¿ç”¨markedè§£æMarkdown
          let html = marked.parse(text);
          
          // å®‰å…¨å¤„ç†ï¼šç¡®ä¿å¤–éƒ¨é“¾æ¥åœ¨æ–°æ ‡ç­¾æ‰“å¼€ï¼Œæ·»åŠ å®‰å…¨å±æ€§
          html = html.replace(/<a /g, '<a target="_blank" rel="noopener noreferrer" ');
          
          // å›¾ç‰‡å°ºå¯¸æ§åˆ¶ï¼šæ”¯æŒ ![alt|size](url) è¯­æ³•
          // ä¾‹å¦‚ï¼š![å›¾ç‰‡|small](url)ã€![å›¾ç‰‡|medium](url)ã€![å›¾ç‰‡|large](url)
          html = html.replace(/<img([^>]*?)alt="([^"]*?)\|?(small|medium|large|full)?"([^>]*?)>/gi, function(match, before, alt, size, after) {
            const sizeClass = size ? ` class="img-${size}"` : '';
            // æ¸…ç†altæ–‡æœ¬ï¼Œç§»é™¤å°ºå¯¸æ ‡è®°
            const cleanAlt = alt.replace(/\|(small|medium|large|full)$/i, '').trim();
            return `<img${before}alt="${cleanAlt}"${sizeClass}${after}>`;
          });
          
          return sanitizeMarkdownHtml(html);
        } catch (error) {
          console.error('[è¯„è®ºç³»ç»Ÿ] Markdownè§£æå¤±è´¥:', error);
          // é™çº§ä¸ºçº¯æ–‡æœ¬æ˜¾ç¤º
          return escapeHtml(text).replace(/\n/g, '<br>');
        }
      } else {
        // markedæœªåŠ è½½ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º
        return escapeHtml(text).replace(/\n/g, '<br>');
      }
    }

    function showLoading(message = 'åŠ è½½ä¸­...') {
      const loadingState = document.getElementById('loadingState');
      const loadingText = loadingState.querySelector('.loading-text');
      if (loadingText) {
        loadingText.textContent = message;
      }
      loadingState.style.display = 'block';
      document.getElementById('commentList').innerHTML = '';
      document.getElementById('noComments').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }

    function requestWorkOptions() {
      console.log('[è¯„è®ºç³»ç»Ÿ] è¯·æ±‚ä½œå“é€‰é¡¹...');
      window.parent.postMessage({
        type: 'REQUEST_WORK_OPTIONS'
      }, '*');
    }

    // ã€æ–°å¢ã€‘é˜²æ­¢å¹¶å‘è¯·æ±‚çš„é”
    let isRequestingComments = false;
    let pendingRequest = null;
    
    function requestCommentsData() {
      // ã€ä¿®å¤ã€‘å¦‚æœæ­£åœ¨è¯·æ±‚ä¸­ï¼Œè®°å½•å¾…å¤„ç†è¯·æ±‚å¹¶å»¶è¿Ÿæ‰§è¡Œ
      if (isRequestingComments) {
        console.log('[è¯„è®ºç³»ç»Ÿ] å·²æœ‰è¯·æ±‚è¿›è¡Œä¸­ï¼Œå»¶è¿Ÿå½“å‰è¯·æ±‚...');
        
        // æ¸…é™¤ä¹‹å‰çš„å¾…å¤„ç†è¯·æ±‚
        if (pendingRequest) {
          clearTimeout(pendingRequest);
        }
        
        // è®¾ç½®æ–°çš„å¾…å¤„ç†è¯·æ±‚ï¼ˆ300msåæ‰§è¡Œï¼‰
        pendingRequest = setTimeout(() => {
          pendingRequest = null;
          requestCommentsData();
        }, 300);
        return;
      }
      
      isRequestingComments = true;
      // console.log('[è¯„è®ºç³»ç»Ÿ] è¯·æ±‚è¯„è®ºæ•°æ®...', {
      //   workFilter: currentWorkFilter,
      //   filterMode: currentFilter,
      //   currentPage: currentPage
      // });
      showLoading('åŠ è½½è¯„è®ºä¸­...');
      
      window.parent.postMessage({
        type: 'REQUEST_COMMENTS',
        data: {
          workFilter: currentWorkFilter,
          filterMode: currentFilter,
          currentPage: currentPage
        }
      }, '*');
      
      // ã€æ–°å¢ã€‘2ç§’åè‡ªåŠ¨è§£é”ï¼Œé˜²æ­¢å¡æ­»
      setTimeout(() => {
        isRequestingComments = false;
      }, 2000);
    }

    // ==================== å®æ—¶Markdowné¢„è§ˆ ====================
    function updateMarkdownPreview() {
      const commentField = document.getElementById('Comment');
      const markdownPreview = document.getElementById('markdownPreview');
      const previewContent = markdownPreview.querySelector('.preview-placeholder');

      if (previewContent) {
        previewContent.textContent = 'æ­£åœ¨åŠ è½½Markdowné¢„è§ˆ...';
      }

      const markdownText = commentField.value;
      const renderedHtml = renderMarkdown(markdownText);

      if (markdownPreview) {
        markdownPreview.innerHTML = renderedHtml;
      }
    }

    // ==================== ä¿¡æ¯åŒºåŸŸå±•å¼€/æ”¶èµ· ====================
    function initInfoToggles() {
      // Markdownæ ¼å¼è¯´æ˜
      const formatToggle = document.getElementById('formatToggle');
      const formatContent = document.getElementById('formatContent');
      const formatIcon = formatToggle.querySelector('.info-toggle-icon');

      formatToggle.addEventListener('click', () => {
        formatContent.classList.toggle('show');
        formatIcon.classList.toggle('expanded');
      });

      // è¯„è®ºæœºåˆ¶è¯´æ˜
      const mechanismToggle = document.getElementById('mechanismToggle');
      const mechanismContent = document.getElementById('mechanismContent');
      const mechanismIcon = mechanismToggle.querySelector('.info-toggle-icon');

      mechanismToggle.addEventListener('click', () => {
        mechanismContent.classList.toggle('show');
        mechanismIcon.classList.toggle('expanded');
      });

      // Markdowné¢„è§ˆ
      const previewToggle = document.getElementById('previewToggle');
      const previewContent = document.getElementById('previewContent');
      const previewIcon = previewToggle.querySelector('.info-toggle-icon');

      previewToggle.addEventListener('click', () => {
        previewContent.classList.toggle('show');
        previewIcon.classList.toggle('expanded');
      });
    }

    // ==================== Markdowné…ç½® ====================
    // é…ç½®markedé€‰é¡¹
    if (typeof marked !== 'undefined') {
      marked.setOptions({
        breaks: true, // æ”¯æŒGFMæ¢è¡Œ
        gfm: true, // å¯ç”¨GitHub Flavored Markdown
        headerIds: false, // ç¦ç”¨æ ‡é¢˜IDï¼ˆé¿å…å†²çªï¼‰
        mangle: false // ç¦ç”¨é‚®ç®±æ··æ·†
      });
      console.log('[è¯„è®ºç³»ç»Ÿ] Markdownè§£æå™¨å·²é…ç½®');
    } else {
      console.warn('[è¯„è®ºç³»ç»Ÿ] Markdownè§£æå™¨æœªåŠ è½½ï¼Œå°†ä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º');
    }

    // ==================== é¡µé¢åŠ è½½ ====================
    // åˆå§‹åŒ–ä¿¡æ¯åŒºåŸŸå±•å¼€/æ”¶èµ·åŠŸèƒ½
    initInfoToggles();
    
    // æ˜¾ç¤ºåˆå§‹åŠ è½½çŠ¶æ€
    showLoading('æ­£åœ¨è¿æ¥è¯„è®ºç³»ç»Ÿ...');
    
    console.log('[è¯„è®ºç³»ç»Ÿ] HTMLå·²åŠ è½½');
    window.parent.postMessage({
      type: 'COMMENT_SYSTEM_READY'
    }, '*');
  </script>
</body>
</html>

