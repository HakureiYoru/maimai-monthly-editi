/**
 * Majnet ä¸Šä¼ æ¨¡å—
 * è‡ªåŠ¨å°†wixæ•°æ®é›†ä¸­çš„è°±é¢ä¸Šä¼ åˆ°majnetå¹³å°
 */

import { fetch } from "wix-fetch";
import { mediaManager } from "wix-media-backend";
import { getFileDownloadUrlAndContent } from "backend/mediaManagement.jsw";
import {
  logInfo,
  logError,
  safeExecute,
} from "backend/errorHandler";

// Majnet APIé…ç½®
const MAJNET_CONFIG = {
  LOGIN_URL: "https://majdata.net/api3/api/account/Login",
  UPLOAD_URL: "https://majdata.net/api3/api/maichart/upload",
  USERNAME: "mmfc_bot",
  FALLBACK_DESIGNER: "mmfc",
  UPLOAD_DELAY: 2000, // ä¸Šä¼ é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  BASE_TIMEOUT: 30000, // åŸºç¡€è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
  MAX_TIMEOUT: 120000, // æœ€å¤§è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
  USER_AGENT: "MajdataPlay/0.1.0-upload (Windows NT 10.0; Win64; x64)",
};

// å…¨å±€ä¼šè¯çŠ¶æ€
let sessionCookies = null;
let lastLoginTime = null;
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30åˆ†é’Ÿ

// ========== è¯·æ±‚é˜Ÿåˆ—ç®¡ç† ==========
class UploadQueue {
  constructor() {
    this.queue = []; // å¾…å¤„ç†çš„ä»»åŠ¡é˜Ÿåˆ—
    this.isProcessing = false; // æ˜¯å¦æ­£åœ¨å¤„ç†ä»»åŠ¡
    this.currentTask = null; // å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
    this.lastUploadTime = 0; // ä¸Šæ¬¡ä¸Šä¼ å®Œæˆæ—¶é—´
  }

  /**
   * æ·»åŠ ä¸Šä¼ ä»»åŠ¡åˆ°é˜Ÿåˆ—
   * @param {Function} uploadTask - ä¸Šä¼ ä»»åŠ¡å‡½æ•°
   * @param {string} taskId - ä»»åŠ¡IDï¼ˆç”¨äºæ—¥å¿—ï¼‰
   * @returns {Promise} è¿”å›ä¸Šä¼ ç»“æœçš„Promise
   */
  async enqueue(uploadTask, taskId) {
    return new Promise((resolve, reject) => {
      const task = {
        id: taskId,
        execute: uploadTask,
        resolve,
        reject,
        addedAt: Date.now(),
      };

      this.queue.push(task);
      logInfo(
        "UploadQueue",
        `ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—: ${taskId} | é˜Ÿåˆ—é•¿åº¦: ${this.queue.length}`
      );

      // å¦‚æœæ²¡æœ‰æ­£åœ¨å¤„ç†ï¼Œç«‹å³å¼€å§‹å¤„ç†
      if (!this.isProcessing) {
        this.processQueue();
      }
    });
  }

  /**
   * å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
   */
  async processQueue() {
    if (this.isProcessing || this.queue.length === 0) {
      return;
    }

    this.isProcessing = true;

    while (this.queue.length > 0) {
      const task = this.queue.shift();
      this.currentTask = task;

      try {
        // ç¡®ä¿ä¸¤æ¬¡ä¸Šä¼ ä¹‹é—´æœ‰è¶³å¤Ÿçš„é—´éš”
        const timeSinceLastUpload = Date.now() - this.lastUploadTime;
        if (timeSinceLastUpload < MAJNET_CONFIG.UPLOAD_DELAY) {
          const waitTime = MAJNET_CONFIG.UPLOAD_DELAY - timeSinceLastUpload;
          logInfo(
            "UploadQueue",
            `ç­‰å¾… ${waitTime}ms åæ‰§è¡Œä»»åŠ¡: ${task.id}`
          );
          await new Promise((resolve) => setTimeout(resolve, waitTime));
        }

        const waitTime = Date.now() - task.addedAt;
        logInfo(
          "UploadQueue",
          `å¼€å§‹æ‰§è¡Œä»»åŠ¡: ${task.id} | ç­‰å¾…æ—¶é•¿: ${(waitTime / 1000).toFixed(1)}ç§’ | å‰©ä½™é˜Ÿåˆ—: ${this.queue.length}`
        );

        // æ‰§è¡Œä¸Šä¼ ä»»åŠ¡
        const result = await task.execute();
        this.lastUploadTime = Date.now();

        // è¿”å›ç»“æœç»™è°ƒç”¨è€…
        task.resolve(result);

        logInfo(
          "UploadQueue",
          `ä»»åŠ¡å®Œæˆ: ${task.id} | æˆåŠŸ: ${result.success}`
        );
      } catch (error) {
        logError("UploadQueue", `ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${task.id} - ${error.message}`);
        task.reject(error);
      } finally {
        this.currentTask = null;
      }
    }

    this.isProcessing = false;
    logInfo("UploadQueue", "é˜Ÿåˆ—å¤„ç†å®Œæˆ");
  }

  /**
   * è·å–é˜Ÿåˆ—çŠ¶æ€
   */
  getStatus() {
    return {
      queueLength: this.queue.length,
      isProcessing: this.isProcessing,
      currentTask: this.currentTask ? this.currentTask.id : null,
      lastUploadTime: this.lastUploadTime,
    };
  }
}

// å…¨å±€ä¸Šä¼ é˜Ÿåˆ—å®ä¾‹
const uploadQueue = new UploadQueue();

/**
 * é¢„è®¡ç®—çš„å¯†ç MD5å€¼
 * "redwhite7687" çš„ MD5 = "0c95eabfbdfdb54a9fd6aac5dccdcc0f"
 */
const PASSWORD_MD5 = "0c95eabfbdfdb54a9fd6aac5dccdcc0f";

/**
 * è·å–é€šç”¨è¯·æ±‚å¤´ï¼ˆæ¨¡æ‹ŸçœŸå®æµè§ˆå™¨ï¼‰
 * é¿å…è§¦å‘ Cloudflare çš„æµè§ˆå™¨å®Œæ•´æ€§æ£€æŸ¥
 */
function getCommonHeaders() {
  return {
    'User-Agent': MAJNET_CONFIG.USER_AGENT,
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',
    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
    'Accept-Encoding': 'gzip, deflate, br',
    'Connection': 'keep-alive',
    'Cache-Control': 'max-age=0',
    'Referer': 'https://majdata.net/',
    'Sec-Fetch-Dest': 'document',
    'Sec-Fetch-Mode': 'navigate',
    'Sec-Fetch-Site': 'same-origin',
    'Sec-Fetch-User': '?1',
  };
}

/**
 * ç™»å½•Majnet
 */
async function loginToMajnet() {
  return safeExecute(
    async () => {
      // æ£€æŸ¥ä¼šè¯æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
      if (
        sessionCookies &&
        lastLoginTime &&
        Date.now() - lastLoginTime < SESSION_TIMEOUT
      ) {
        logInfo("loginToMajnet", "ä½¿ç”¨ç°æœ‰ä¼šè¯");
        return { success: true, message: "ä½¿ç”¨ç¼“å­˜ä¼šè¯" };
      }

      try {
        logInfo("loginToMajnet", "å¼€å§‹ç™»å½•");
        
        const response = await fetch(MAJNET_CONFIG.LOGIN_URL, {
          method: "POST",
          headers: {
            ...getCommonHeaders(),
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `username=${MAJNET_CONFIG.USERNAME}&password=${PASSWORD_MD5}`,
        });

        if (response.status === 200) {
          // ä¿å­˜ä¼šè¯cookies
          const cookies = response.headers.get("set-cookie");
          if (cookies) {
            sessionCookies = cookies;
            lastLoginTime = Date.now();
          }

          logInfo("loginToMajnet", "âœ… ç™»å½•æˆåŠŸ");
          return {
            success: true,
            message: "ç™»å½•æˆåŠŸ",
            statusCode: response.status,
          };
        }

        // æœåŠ¡å™¨æ‹’ç»
        sessionCookies = null;
        lastLoginTime = null;
        const errorText = await response.text();
        logError("loginToMajnet", `âŒ ç™»å½•å¤±è´¥: ${response.status} - ${errorText.substring(0, 200)}`);
        return {
          success: false,
          message: `ç™»å½•å¤±è´¥: ${response.status}`,
          statusCode: response.status,
          error: errorText,
        };
      } catch (error) {
        sessionCookies = null;
        lastLoginTime = null;
        logError("loginToMajnet", `âŒ ç™»å½•å¼‚å¸¸: ${error.message}`);
        
        return {
          success: false,
          message: "ç™»å½•å¼‚å¸¸",
          error: error.message,
        };
      }
    },
    "loginToMajnet",
    { success: false, message: "ç™»å½•å¼‚å¸¸" }
  );
}

/**
 * ç¡®ä¿maidata.txtä¸­æœ‰designerå­—æ®µ
 */
function ensureDesigner(maidataContent) {
  if (!maidataContent || typeof maidataContent !== "string") {
    logError("ensureDesigner", "maidataå†…å®¹æ— æ•ˆ");
    return `&des=${MAJNET_CONFIG.FALLBACK_DESIGNER}\n`;
  }

  const lines = maidataContent.split("\n");
  let hasDesigner = false;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (line.toLowerCase().startsWith("&des=")) {
      const value = line.split("=")[1]?.trim();
      if (!value) {
        lines[i] = `&des=${MAJNET_CONFIG.FALLBACK_DESIGNER}`;
        logInfo("ensureDesigner", "è¡¥å……äº†ç©ºçš„designerå­—æ®µ");
      }
      hasDesigner = true;
      break;
    }
  }

  if (!hasDesigner) {
    // åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ designerï¼ˆæ›´å®‰å…¨ï¼‰
    lines.unshift(`&des=${MAJNET_CONFIG.FALLBACK_DESIGNER}`);
    logInfo("ensureDesigner", "æ·»åŠ äº†ç¼ºå¤±çš„designerå­—æ®µ");
  }

  return lines.join("\n");
}

/**
 * è·å–æ–‡ä»¶çš„äºŒè¿›åˆ¶å†…å®¹
 */
async function getFileBinary(fileUrl) {
  return safeExecute(
    async () => {
      const downloadUrl = await mediaManager.getDownloadUrl(fileUrl);
      const response = await fetch(downloadUrl);

      if (!response.ok) {
        throw new Error(`è·å–æ–‡ä»¶å¤±è´¥: ${response.status}`);
      }

      // Wix Velo ä½¿ç”¨ buffer() è€Œä¸æ˜¯ arrayBuffer()
      const buffer = await response.buffer();
      return {
        buffer: buffer,
        contentType: response.headers.get("content-type"),
      };
    },
    "getFileBinary",
    null
  );
}

/**
 * æ ¹æ®æ–‡ä»¶å¤§å°è®¡ç®—åŠ¨æ€è¶…æ—¶æ—¶é—´
 * @param {number} totalSizeBytes - æ–‡ä»¶æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼‰
 * @returns {number} è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 */
function calculateDynamicTimeout(totalSizeBytes) {
  const sizeMB = totalSizeBytes / (1024 * 1024);
  // æ¯10MBå¢åŠ 15ç§’
  const extraTimeout = Math.floor(sizeMB / 10) * 15000;
  const calculatedTimeout = MAJNET_CONFIG.BASE_TIMEOUT + extraTimeout;
  
  // é™åˆ¶åœ¨æœ€å¤§è¶…æ—¶èŒƒå›´å†…
  const finalTimeout = Math.min(calculatedTimeout, MAJNET_CONFIG.MAX_TIMEOUT);
  
  logInfo(
    "calculateDynamicTimeout",
    `æ–‡ä»¶å¤§å°: ${sizeMB.toFixed(1)}MB, è¶…æ—¶: ${finalTimeout / 1000}ç§’`
  );
  
  return finalTimeout;
}

/**
 * æ„å»ºmultipart/form-dataè¯·æ±‚ä½“
 */
function buildMultipartFormData(files) {
  const boundary =
    "----WebKitFormBoundary" + Math.random().toString(36).substr(2);
  const parts = [];

  for (const file of files) {
    const { filename, content, contentType } = file;

    // æ„å»ºæ–‡ä»¶å¤´éƒ¨
    let header = "";
    header += `--${boundary}\r\n`;
    header += `Content-Disposition: form-data; name="formfiles"; filename="${filename}"\r\n`;
    header += `Content-Type: ${contentType}\r\n\r\n`;

    // æ·»åŠ å¤´éƒ¨ï¼ˆå­—ç¬¦ä¸²è½¬Bufferï¼‰
    parts.push(Buffer.from(header, "utf8"));

    // æ·»åŠ å†…å®¹ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–Bufferï¼‰
    if (typeof content === "string") {
      parts.push(Buffer.from(content, "utf8"));
    } else {
      parts.push(content); // å·²ç»æ˜¯Buffer
    }

    // æ·»åŠ åˆ†éš”ç¬¦
    parts.push(Buffer.from("\r\n", "utf8"));
  }

  // æ·»åŠ ç»“æŸè¾¹ç•Œ
  parts.push(Buffer.from(`--${boundary}--\r\n`, "utf8"));

  // åˆå¹¶æ‰€æœ‰Buffer
  const body = Buffer.concat(parts);

  return {
    body: body,
    boundary,
    totalSize: body.length,
  };
}

/**
 * ä¸Šä¼ è°±é¢åˆ°Majnetï¼ˆå¸¦é˜Ÿåˆ—ç®¡ç†ï¼‰
 * @param {Object} chartData - åŒ…å«æ–‡ä»¶URLçš„è°±é¢æ•°æ®
 * @param {boolean} skipQueue - æ˜¯å¦è·³è¿‡é˜Ÿåˆ—ï¼ˆæ‰¹é‡ä¸Šä¼ æ—¶ä½¿ç”¨ï¼‰
 * @returns {Promise<Object>} ä¸Šä¼ ç»“æœ
 */
export async function uploadChartToMajnet(chartData, skipQueue = false) {
  const chartTitle = chartData.chartTitle || "æœªå‘½å";
  const taskId = `${chartTitle}_${Date.now()}`;

  // å¦‚æœä¸è·³è¿‡é˜Ÿåˆ—ï¼Œåˆ™åŠ å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ
  if (!skipQueue) {
    logInfo("uploadChartToMajnet", `ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—: ${chartTitle}`);
    const queueStatus = uploadQueue.getStatus();
    logInfo(
      "uploadChartToMajnet",
      `å½“å‰é˜Ÿåˆ—çŠ¶æ€: é˜Ÿåˆ—é•¿åº¦=${queueStatus.queueLength}, æ­£åœ¨å¤„ç†=${queueStatus.isProcessing}`
    );

    return uploadQueue.enqueue(
      () => uploadChartToMajnetInternal(chartData),
      taskId
    );
  }

  // æ‰¹é‡ä¸Šä¼ æ—¶ç›´æ¥æ‰§è¡Œï¼ˆå·²åœ¨æ‰¹é‡å‡½æ•°ä¸­æ§åˆ¶å»¶è¿Ÿï¼‰
  return uploadChartToMajnetInternal(chartData);
}

/**
 * ä¸Šä¼ è°±é¢åˆ°Majnetçš„å†…éƒ¨å®ç°
 * @param {Object} chartData - åŒ…å«æ–‡ä»¶URLçš„è°±é¢æ•°æ®
 * @returns {Promise<Object>} ä¸Šä¼ ç»“æœ
 */
async function uploadChartToMajnetInternal(chartData) {
  return safeExecute(
    async () => {
      const {
        maidataUrl, // maidata.txtçš„wix URL
        trackUrl, // track.mp3çš„wix URL
        bgUrl, // bg.png/jpgçš„wix URL
        bgVideoUrl, // èƒŒæ™¯è§†é¢‘URLï¼ˆå¯é€‰ï¼‰
        chartTitle, // è°±é¢æ ‡é¢˜ï¼ˆç”¨äºæ—¥å¿—ï¼‰
      } = chartData;

      logInfo("uploadChartToMajnet", `å¼€å§‹ä¸Šä¼ è°±é¢: ${chartTitle || "æœªå‘½å"}`);

      // 1. ç¡®ä¿å·²ç™»å½•
      const loginResult = await loginToMajnet();
      if (!loginResult.success) {
        const majnetUploadMessage = `âŒ ç™»å½•Majnetå¤±è´¥\né”™è¯¯ä¿¡æ¯: ${loginResult.message}\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
        return {
          success: false,
          message: "ç™»å½•å¤±è´¥",
          error: loginResult.message,
          majnetUploadMessage: majnetUploadMessage,
        };
      }

      // 2. è·å–æ‰€æœ‰æ–‡ä»¶
      const files = [];

      try {
        // 2.1 è·å–maidata.txt
        if (!maidataUrl) {
          throw new Error("ç¼ºå°‘maidata.txtæ–‡ä»¶");
        }
        logInfo("uploadChartToMajnet", "æ­£åœ¨è·å–maidata.txt...");
        const maidataResult = await getFileDownloadUrlAndContent(maidataUrl);
        if (!maidataResult || !maidataResult.fileContent) {
          throw new Error("maidata.txtå†…å®¹ä¸ºç©º");
        }
        const maidataContent = ensureDesigner(maidataResult.fileContent);
        files.push({
          filename: "maidata.txt",
          content: maidataContent,
          contentType: "text/plain",
        });
        logInfo("uploadChartToMajnet", "maidata.txtå‡†å¤‡å®Œæˆ");

        // 2.2 è·å–èƒŒæ™¯å›¾
        if (!bgUrl) {
          throw new Error("ç¼ºå°‘èƒŒæ™¯å›¾æ–‡ä»¶");
        }
        logInfo("uploadChartToMajnet", "æ­£åœ¨è·å–èƒŒæ™¯å›¾...");
        const bgBinary = await getFileBinary(bgUrl);
        if (!bgBinary || !bgBinary.buffer) {
          throw new Error("èƒŒæ™¯å›¾è·å–å¤±è´¥");
        }
        const bgExtension = bgUrl.toLowerCase().includes(".jpg")
          ? "jpg"
          : "png";
        files.push({
          filename: `bg.${bgExtension}`,
          content: bgBinary.buffer,
          contentType: bgBinary.contentType || `image/${bgExtension}`,
        });
        logInfo("uploadChartToMajnet", `èƒŒæ™¯å›¾å‡†å¤‡å®Œæˆ (${bgExtension})`);

        // 2.3 è·å–éŸ³é¢‘æ–‡ä»¶
        if (!trackUrl) {
          throw new Error("ç¼ºå°‘éŸ³é¢‘æ–‡ä»¶");
        }
        logInfo("uploadChartToMajnet", "æ­£åœ¨è·å–éŸ³é¢‘æ–‡ä»¶...");
        const trackBinary = await getFileBinary(trackUrl);
        if (!trackBinary || !trackBinary.buffer) {
          throw new Error("éŸ³é¢‘æ–‡ä»¶è·å–å¤±è´¥");
        }
        files.push({
          filename: "track.mp3",
          content: trackBinary.buffer,
          contentType: trackBinary.contentType || "audio/mpeg",
        });
        logInfo("uploadChartToMajnet", "éŸ³é¢‘æ–‡ä»¶å‡†å¤‡å®Œæˆ");

        // 2.4 è·å–è§†é¢‘ï¼ˆå¦‚æœæœ‰ï¼‰
        if (bgVideoUrl) {
          const videoBinary = await getFileBinary(bgVideoUrl);
          const videoExtension = bgVideoUrl.toLowerCase().includes("pv.mp4")
            ? "pv.mp4"
            : "bg.mp4";
          files.push({
            filename: videoExtension,
            content: videoBinary.buffer,
            contentType: videoBinary.contentType || "video/mp4",
          });
        }
      } catch (error) {
        logError("uploadChartToMajnet", `æ–‡ä»¶å‡†å¤‡å¤±è´¥: ${error.message}`);
        const majnetUploadMessage = `âŒ æ–‡ä»¶å‡†å¤‡å¤±è´¥\né”™è¯¯ä¿¡æ¯: ${error.message}\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
        return {
          success: false,
          message: "æ–‡ä»¶å‡†å¤‡å¤±è´¥",
          error: error.message,
          majnetUploadMessage: majnetUploadMessage,
        };
      }

      // 3. æ„å»ºå¹¶å‘é€ä¸Šä¼ è¯·æ±‚
      return await uploadToMajnet(files, chartTitle);
    },
    "uploadChartToMajnet",
    {
      success: false,
      message: "ä¸Šä¼ å¼‚å¸¸",
      majnetUploadMessage: `âŒ ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`,
    }
  );
}

/**
 * ä¸Šä¼ æ–‡ä»¶åˆ°Majnet
 * @param {Array} files - æ–‡ä»¶æ•°ç»„
 * @param {string} chartTitle - è°±é¢æ ‡é¢˜
 * @returns {Promise<Object>} ä¸Šä¼ ç»“æœ
 */
async function uploadToMajnet(files, chartTitle) {
  return safeExecute(
    async () => {
      logInfo("uploadToMajnet", `å‡†å¤‡ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`);
      
      // æ„å»ºè¯·æ±‚ä½“
      const formData = buildMultipartFormData(files);
      const totalSizeMB = (formData.totalSize / (1024 * 1024)).toFixed(1);
      logInfo(
        "uploadToMajnet",
        `è¯·æ±‚ä½“æ„å»ºå®Œæˆï¼Œå¤§å°: ${totalSizeMB}MB`
      );

      // è®¡ç®—åŠ¨æ€è¶…æ—¶
      const currentTimeout = calculateDynamicTimeout(formData.totalSize);
      
      try {
        logInfo(
          "uploadToMajnet",
          `å¼€å§‹ä¸Šä¼ : ${chartTitle} (è¶…æ—¶: ${currentTimeout / 1000}ç§’)`
        );

        const headers = {
          ...getCommonHeaders(),
          "Content-Type": `multipart/form-data; boundary=${formData.boundary}`,
        };

        if (sessionCookies) {
          headers["Cookie"] = sessionCookies;
        }

        // å‘é€ä¸Šä¼ è¯·æ±‚
        const response = await fetch(MAJNET_CONFIG.UPLOAD_URL, {
          method: "POST",
          headers,
          body: formData.body,
        });

        const responseText = await response.text();
        logInfo("uploadToMajnet", `æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç : ${response.status}`);

        // æˆåŠŸ
        if (response.status === 200) {
          logInfo(
            "uploadToMajnet",
            `âœ… ä¸Šä¼ æˆåŠŸ: ${chartTitle} - å“åº”: ${responseText.substring(0, 200)}`
          );
          
          // æ„å»ºè¯¦ç»†çš„ä¸Šä¼ æ¶ˆæ¯
          let majnetUploadMessage = `âœ… ä¸Šä¼ æˆåŠŸ\n`;
          majnetUploadMessage += `æœåŠ¡å™¨å“åº”: ${responseText}\n`;
          majnetUploadMessage += `çŠ¶æ€ç : ${response.status}\n`;
          majnetUploadMessage += `ä¸Šä¼ æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
          
          return {
            success: true,
            message: "ä¸Šä¼ æˆåŠŸ",
            statusCode: response.status,
            response: responseText,
            majnetUploadMessage: majnetUploadMessage,
          };
        }

        // æœåŠ¡å™¨æ‹’ç»ï¼ˆ4xx/5xxï¼‰
        if (response.status >= 400 && response.status < 600) {
          const errorMsg = `çŠ¶æ€ç ${response.status} | å“åº”: ${responseText.substring(0, 300)} | ä½œå“: ${chartTitle} | æ–‡ä»¶æ•°: ${files.length}`;
          logError("uploadToMajnet", `âŒ æœåŠ¡å™¨æ‹’ç»: ${errorMsg}`);

          // æ„å»ºè¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯
          let majnetUploadMessage = `âŒ æœåŠ¡å™¨æ‹’ç»ä¸Šä¼ \n`;
          majnetUploadMessage += `çŠ¶æ€ç : ${response.status}\n`;
          majnetUploadMessage += `æœåŠ¡å™¨å“åº”: ${responseText.substring(0, 500)}\n`;
          
          // å¦‚æœæ˜¯400é”™è¯¯ï¼Œé¢å¤–è®°å½•è¯·æ±‚è¯¦æƒ…
          if (response.status === 400) {
            const fileList = files.map((f) => f.filename).join(", ");
            majnetUploadMessage += `æ–‡ä»¶åˆ—è¡¨: ${fileList}\n`;
            majnetUploadMessage += `æ€»å¤§å°: ${totalSizeMB}MB\n`;
            logError(
              "uploadToMajnet - 400è¯¦æƒ…",
              `æ–‡ä»¶åˆ—è¡¨: [${fileList}] | å¤§å°: ${totalSizeMB}MB`
            );
          }
          
          majnetUploadMessage += `å¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;

          return {
            success: false,
            message: `âŒ æœåŠ¡å™¨æ‹’ç»ï¼ŒçŠ¶æ€ç  ${response.status}`,
            statusCode: response.status,
            error: responseText,
            details: errorMsg,
            majnetUploadMessage: majnetUploadMessage,
          };
        }

        // å…¶ä»–çŠ¶æ€ç 
        const majnetUploadMessage = `âŒ ä¸Šä¼ å¤±è´¥\né”™è¯¯ä¿¡æ¯: çŠ¶æ€ç  ${response.status}\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
        return {
          success: false,
          message: `âŒ ä¸Šä¼ å¤±è´¥: çŠ¶æ€ç  ${response.status}`,
          error: `çŠ¶æ€ç  ${response.status}`,
          majnetUploadMessage: majnetUploadMessage,
        };
        
      } catch (error) {
        // åˆ¤æ–­é”™è¯¯ç±»å‹
        const errorMsg = error.message || String(error);
        
        if (errorMsg.includes("timeout") || errorMsg.includes("ETIMEDOUT")) {
          const majnetUploadMessage = `âŒ ç½‘ç»œè¶…æ—¶\né”™è¯¯ä¿¡æ¯: è¯·æ±‚è¶…è¿‡ ${currentTimeout / 1000} ç§’æœªå“åº”\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
          logError("uploadToMajnet", `â±ï¸ è¶…æ—¶: ${chartTitle}`);
          return {
            success: false,
            message: "âŒ ç½‘ç»œè¶…æ—¶",
            error: `è¯·æ±‚è¶…è¿‡ ${currentTimeout / 1000} ç§’æœªå“åº”`,
            majnetUploadMessage: majnetUploadMessage,
          };
        } else if (
          errorMsg.includes("ECONNREFUSED") ||
          errorMsg.includes("ENOTFOUND") ||
          errorMsg.includes("ECONNRESET") ||
          errorMsg.includes("connect")
        ) {
          const majnetUploadMessage = `âŒ è¿æ¥é”™è¯¯\né”™è¯¯ä¿¡æ¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
          logError("uploadToMajnet", `ğŸ”Œ è¿æ¥é”™è¯¯: ${chartTitle}`);
          return {
            success: false,
            message: "âŒ è¿æ¥é”™è¯¯",
            error: "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨",
            majnetUploadMessage: majnetUploadMessage,
          };
        } else {
          const majnetUploadMessage = `âŒ ä¸Šä¼ å¤±è´¥\né”™è¯¯ä¿¡æ¯: ${errorMsg}\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
          logError("uploadToMajnet", `âŒ æœªçŸ¥é”™è¯¯: ${errorMsg}`);
          return {
            success: false,
            message: "âŒ ä¸Šä¼ å¤±è´¥",
            error: errorMsg,
            majnetUploadMessage: majnetUploadMessage,
          };
        }
      }
    },
    "uploadToMajnet",
    {
      success: false,
      message: "ä¸Šä¼ å¼‚å¸¸",
      majnetUploadMessage: `âŒ ä¸Šä¼ è¯·æ±‚è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`,
    }
  );
}

/**
 * ä»wixæ•°æ®é›†é¡¹ä¸Šä¼ åˆ°Majnet
 * @param {Object} contestItem - enterContest034æ•°æ®é›†é¡¹
 * @param {boolean} skipQueue - æ˜¯å¦è·³è¿‡é˜Ÿåˆ—ï¼ˆæ‰¹é‡ä¸Šä¼ æ—¶ä½¿ç”¨ï¼‰
 * @returns {Promise<Object>} ä¸Šä¼ ç»“æœ
 */
export async function uploadContestItemToMajnet(contestItem, skipQueue = false) {
  return safeExecute(
    async () => {
      // æ˜ å°„å­—æ®µåï¼ˆæ ¹æ®http-functions.jsä¸­çš„å­—æ®µæ˜ å°„ï¼‰
      const chartData = {
        maidataUrl: contestItem.inVideoçš„è¤‡æœ¬, // maidata.txt
        trackUrl: contestItem.maidataçš„è¤‡æœ¬, // track.mp3
        bgUrl: contestItem.trackçš„è¤‡æœ¬, // bg.png/jpg
        bgVideoUrl: contestItem.ä¸Šå‚³æª”æ¡ˆæ¬„, // èƒŒæ™¯è§†é¢‘
        chartTitle: contestItem.firstName, // ä½œå“æ ‡é¢˜
      };

      // è®°å½•å­—æ®µæ˜ å°„æƒ…å†µ
      logInfo(
        "uploadContestItemToMajnet",
        `å­—æ®µæ˜ å°„: maidata=${!!chartData.maidataUrl}, track=${!!chartData.trackUrl}, bg=${!!chartData.bgUrl}, video=${!!chartData.bgVideoUrl}, title=${
          chartData.chartTitle
        }`
      );

      return await uploadChartToMajnet(chartData, skipQueue);
    },
    "uploadContestItemToMajnet",
    {
      success: false,
      message: "ä¸Šä¼ å¤±è´¥",
      majnetUploadMessage: `âŒ ä¸Šä¼ æ•°æ®é›†é¡¹ç›®æ—¶å‘ç”Ÿå¼‚å¸¸\nå¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`,
    }
  );
}

