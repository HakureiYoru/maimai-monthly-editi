import wixUsers from "wix-users";
import wixData from "wix-data";
import wixWindow from "wix-window";
import {
  getMediaDownloadUrls,
  getFileDownloadUrlAndContent,
  getBatchDownloadUrls,
} from "backend/mediaManagement.jsw";
import { updateUserPoints } from "backend/forumPoints.jsw";
import {
  deleteComment,
  checkIsSeaSelectionMember,
} from "backend/auditorManagement.jsw";
import { markTaskCompleted, checkIfWorkInTaskList, getUserTaskData, getWorkWeightedRatingData, getAllWorksWeightedRatingData } from "backend/ratingTaskManager.jsw";
import { sendReplyNotification } from "backend/emailNotifications.jsw";
import { QUERY_LIMITS, RATING_CONFIG } from "public/constants.js";

// 鍏ㄥ眬鐘舵€佺鐞?
let commentsCountByWorkNumber = {};
const itemsPerPage = QUERY_LIMITS.ITEMS_PER_PAGE;
const commentsPerPage = 20; // 璇勮鍒楄〃姣忛〉鏄剧ず鏁伴噺
let titleValue;
const currentUserId = wixUsers.currentUser.id;
let isUserVerified = false;
const commentDataCache = new Map(); // 缂撳瓨鍒嗛〉鏌ヨ缁撴灉
let selfScCommentIdCache = null; // 缂撳瓨浣滆€呰嚜璇勮瘎璁篒D闆嗗悎
let isLoadingSelfScComments = false; // 闃叉骞跺彂鍔犺浇浣滆€呰嚜璇勮瘎璁篒D

// 缂撳瓨鏁版嵁浠ュ噺灏慉PI璋冪敤锛堟€ц兘浼樺寲锛?
let userFormalRatingsCache = null; // 缂撳瓨鐢ㄦ埛姝ｅ紡璇勫垎鐘舵€?
let replyCountsCache = {}; // 缂撳瓨鍥炲鏁伴噺
let workOwnersCache = {}; // 缂撳瓨浣滃搧鎵€鏈夎€呬俊鎭?
let allWorksRankingCache = null; // 缂撳瓨鎵€鏈変綔鍝佺殑鎺掑悕淇℃伅
let workTitlesCache = {}; // 缂撳瓨浣滃搧鏍囬淇℃伅

// 銆愭柊澧炪€戝姞杞介攣锛岄槻姝㈠苟鍙戦噸澶嶅姞杞?
let isLoadingUserFormalRatings = false; // 闃叉骞跺彂鍔犺浇鐢ㄦ埛璇勫垎鐘舵€?
let isLoadingBatchData = false; // 闃叉骞跺彂鍔犺浇鎵归噺鏁版嵁
let isLoadingRanking = false; // 闃叉骞跺彂鍔犺浇鎺掑悕鏁版嵁

// 銆愭柊澧炪€戞壒閲忔暟鎹紦瀛?- 涓€娆℃€у姞杞芥墍鏈変綔鍝佽瘎鍒嗘暟鎹?
let batchDataCache = null; // { workRatings, userQualityMap, workOwnerMap, workDQMap, commentCountMap }

// 銆愭柊澧炪€戜换鍔℃暟鎹紦瀛?- 閬垮厤閲嶅璋冪敤
let userTaskDataCache = null; // 缂撳瓨鐢ㄦ埛浠诲姟鏁版嵁

// 鐢ㄦ埛楠岃瘉鍔熻兘
async function checkUserVerification() {
  if (!currentUserId) {
    isUserVerified = false;
    return false;
  }

  try {
    const results = await wixData
      .query("jobApplication089")
      .eq("_owner", currentUserId)
      .find();

    if (results.items.length > 0) {
      isUserVerified = true;
      return true;
    } else {
      isUserVerified = false;
      return false;
    }
  } catch (error) {
    console.error("妫€鏌ョ敤鎴烽獙璇佺姸鎬佸け璐ワ細", error);
    isUserVerified = false;
    return false;
  }
}

// 銆愬凡绉婚櫎銆憉pdateCommentControlsVerificationStatus() - 鍙敤浜庢棫鐨勫師鐢熺粍浠?
/*
function updateCommentControlsVerificationStatus() {
  if (!currentUserId) {
    $w("#submit").disable();
    $w("#submit").label = "鏈櫥褰?;
    $w("#Comment").disable();
    $w("#inputScore").disable();
    return;
  }

  if (!isUserVerified) {
    $w("#submit").disable();
    $w("#submit").label = "鏈姤鍚?;
    $w("#Comment").disable();
    $w("#inputScore").disable();
  } else {
    const workNumber = parseInt($w("#inputNumber").value);
    if (workNumber) {
      $w("#inputNumber").fireEvent("change");
    } else {
      $w("#submit").enable();
      $w("#submit").label = "鎻愪氦璇勮";
      $w("#Comment").enable();
      $w("#inputScore").enable();
    }
  }
}
*/

// 銆愭柊澧炪€戞壒閲忓姞杞芥墍鏈夋暟鎹紙鎬ц兘浼樺寲鏍稿績鍑芥暟锛?
async function loadBatchData() {
   // 濡傛灉宸叉湁缂撳瓨锛岀洿鎺ヨ繑鍥?
  if (batchDataCache) {
    return batchDataCache;
  }

  // 銆愬叧閿€戝鏋滄鍦ㄥ姞杞斤紝绛夊緟鍔犺浇瀹屾垚
  if (isLoadingBatchData) {
    console.log("[鎬ц兘浼樺寲] 鎵归噺鏁版嵁姝ｅ湪鍔犺浇涓紝绛夊緟瀹屾垚...");
    let waitCount = 0;
    while (isLoadingBatchData && waitCount < 600) {
      await new Promise(resolve => setTimeout(resolve, 100));
      waitCount++;
    }
    return batchDataCache;
  }

  // 璁剧疆鍔犺浇閿?
  isLoadingBatchData = true;

  try {
    console.log("[鎬ц兘浼樺寲] 寮€濮嬫壒閲忓姞杞芥墍鏈変綔鍝佹暟鎹?..");
    const startTime = Date.now();
    
    batchDataCache = await getAllWorksWeightedRatingData();
    
    // 浠庢壒閲忔暟鎹腑鎻愬彇璇勮璁℃暟
    commentsCountByWorkNumber = batchDataCache.commentCountMap || {};
    
    // 浠庢壒閲忔暟鎹腑鎻愬彇浣滃搧鎵€鏈夎€呬俊鎭?
    workOwnersCache = batchDataCache.workOwnerMap || {};
    
    const endTime = Date.now();
    console.log(`[鎬ц兘浼樺寲] 鎵归噺鏁版嵁鍔犺浇瀹屾垚锛岃€楁椂: ${endTime - startTime}ms`);
    console.log(`[鎬ц兘浼樺寲] 鍔犺浇浜?${Object.keys(batchDataCache.workRatings || {}).length} 涓綔鍝佺殑璇勫垎鏁版嵁`);
    console.log(`[鎬ц兘浼樺寲] 鍔犺浇浜?${Object.keys(commentsCountByWorkNumber).length} 涓綔鍝佺殑璇勮璁℃暟`);
    
    return batchDataCache;
  } catch (error) {
    console.error("[鎬ц兘浼樺寲] 鎵归噺鏁版嵁鍔犺浇澶辫触:", error);
    batchDataCache = {
      workRatings: {},
      userQualityMap: {},
      workOwnerMap: {},
      workDQMap: {},
      commentCountMap: {}
    };
    return batchDataCache;
  } finally {
    // 閲婃斁鍔犺浇閿?
    isLoadingBatchData = false;
  }
}

// 椤甸潰鍒濆鍖?
$w.onReady(async function () {
  // 鍒濆鍖栧垹闄ゆ彁绀烘枃瀛楀厓浠讹紙闅愯棌锛?

  await checkUserVerification();
  // updateCommentControlsVerificationStatus(); // 銆愬凡绉婚櫎銆戞棫绯荤粺鍑芥暟

  // 銆愪紭鍖栥€戦鍏堟壒閲忓姞杞芥墍鏈夋暟鎹紙涓€娆PI璋冪敤鏇夸唬鏁扮櫨娆★級
  await loadBatchData();

  // 銆愪紭鍖栥€戞鏌ュ苟鍒锋柊浠诲姟锛堜粎璋冪敤涓€娆″苟缂撳瓨锛?
  if (currentUserId && isUserVerified) {
    try {
      userTaskDataCache = await getUserTaskData(currentUserId);
      console.log("[涓讳細鍦篯 浠诲姟鍚屾妫€鏌ュ畬鎴愶紝宸茬紦瀛?);
    } catch (error) {
      console.error("[涓讳細鍦篯 浠诲姟鍚屾妫€鏌ュけ璐?", error);
      userTaskDataCache = { hasCompletedTarget: false, taskList: [] };
    }
  }

  // 鍒濆鍖栬嚜瀹氫箟HTML妤间腑妤煎洖澶嶉潰鏉?
  initCommentRepliesPanel();
  
  // 鍒濆鍖栧垹闄ょ‘璁ら潰鏉?
  initDeleteConfirmationPanel();

  // 銆愭柊澧炪€戝垵濮嬪寲璇勮绯荤粺HTML鍏冧欢
  initCommentSystemPanel();

  // Repeater2: 浣滃搧鏄剧ず
  $w("#repeater2").onItemReady(async ($item, itemData, index) => {
    const maidataUrl = itemData.inVideo鐨勮鏈?
    const trackUrl = itemData.maidata鐨勮鏈?
    const bgUrl = itemData.track鐨勮鏈?
    const bgVideoUrl = itemData.涓婂偝妾旀娆?
    const submitTime = itemData.submissionTime;
    const formattedSubmitTime = formatDate(submitTime);

    const downloadUrl = await getMediaDownloadUrls(
      maidataUrl,
      trackUrl,
      bgUrl,
      bgVideoUrl
    );

    $item("#button3").label = "Download";

    // 瑙嗛鏄剧ず鎺у埗
    if (bgVideoUrl) {
      $item("#movie").show();
    } else {
      $item("#movie").hide();
    }

    $item("#submitTime").text = formattedSubmitTime;
    await parseDifficultyLevels($item, maidataUrl);
    await updateItemEvaluationDisplay($item, itemData);
    await updateButtonStatus($item, itemData._id);
    await updateCommentStatus($item, itemData);

    // 娣樻卑浣滃搧瑙嗚鏁堟灉
    if (itemData.isDq === true) {
      $item("#container2").style.opacity = "0.5";
      $item("#container2").style.filter = "grayscale(100%)";
      $item("#container2").style.backgroundColor = "rgba(128, 128, 128, 0.2)";
    }

    setupItemEventListeners($item, itemData, downloadUrl);
  });

  // 銆愬凡绉婚櫎銆慠epeater1璇勮鏄剧ず鍔熻兘宸茶縼绉诲埌鏂扮殑HTML鍏冧欢锛坈ommentSystemPanel锛?

  // 鏁版嵁鍒濆鍖?
  await updateRepeaterData(1, "", "");
  
  // 銆愪紭鍖栥€戦鍔犺浇鐢ㄦ埛璇勫垎鐘舵€侊紙浣跨敤鎵归噺鏁版嵁锛?
  if (currentUserId && isUserVerified) {
    await batchLoadUserFormalRatings();
  }
  
  // 銆愪紭鍖栥€戦鍔犺浇浣滃搧鎺掑悕鏁版嵁锛堜娇鐢ㄦ壒閲忔暟鎹級
  await calculateAllWorksRanking();
  
  // 銆愬凡绉婚櫎銆憀oadAllFormalComments() - 鏃epeater1鍒濆鍖栵紝鏂扮郴缁熼€氳繃HTML鍏冧欢鍒濆鍖?
  
  // 棰勫姞杞藉綋鍓嶆樉绀鸿瘎璁虹殑鍥炲鏁伴噺锛堟柊绯荤粺浼氳嚜鍔ㄥ鐞嗭級
  // 銆愭敞閲娿€戞棫repeater1鐨勫洖澶嶆暟閲忛鍔犺浇宸蹭笉闇€瑕?

  // 銆愪繚鐣欍€戜綔鍝佸垪琛紙Repeater2锛夌殑浜嬩欢鐩戝惉鍣?
  setupSearchAndPaginationEvents(); // 浣滃搧鎼滅储銆佸垎椤点€佹帓搴?

  // 銆愬凡杩佺Щ鍒版柊HTML鍏冧欢銆戣瘎璁虹郴缁熺殑浜嬩欢鐩戝惉鍣ㄥ凡绉婚櫎
  // 鎵€鏈夎瘎璁虹浉鍏冲姛鑳界幇鍦ㄧ敱 commentSystemPanel HTML鍏冧欢澶勭悊
});

// 鏍稿績鍔熻兘鍑芥暟

// 璇勮鐘舵€佹鏌?- 浼樺厛绾э細娣樻卑 > 鏈櫥褰?> 鏈獙璇?> 璇勮鐘舵€侊紙浠诲姟/鍐烽棬楂樹寒鎻愮ず锛?
// 鈿狅笍 姝ゅ嚱鏁拌 Repeater2锛堜綔鍝佸垪琛級浣跨敤锛岀敤浜庢樉绀轰綔鍝佺殑璇勮鐘舵€侊紙#ifComment锛?
async function updateCommentStatus($item, itemData) {
  if (itemData.isDq === true) {
    $item("#ifComment").text = "宸叉窐姹?;
    $item("#ifComment").style.color = "#808080";
    return;
  }

  if (!currentUserId) {
    $item("#ifComment").text = "鏈櫥褰?;
    $item("#ifComment").style.color = "#A9A9A9";
    return;
  }

  if (!isUserVerified) {
    $item("#ifComment").text = "鏈姤鍚?;
    $item("#ifComment").style.color = "#FF0000";
    return;
  }

  try {
    const results = await wixData
      .query("BOFcomment")
      .eq("workNumber", itemData.sequenceId)
      .eq("_owner", currentUserId)
      .isEmpty("replyTo")
      .find();

    // 銆愪紭鍖栥€戞鏌ユ槸鍚︿负浠诲姟浣滃搧鎴栧喎闂ㄤ綔鍝?- 浣跨敤缂撳瓨閬垮厤閲嶅璋冪敤
    const taskCheck = await checkIfWorkInTaskList(currentUserId, itemData.sequenceId);
    const hasCompletedTarget = userTaskDataCache ? (userTaskDataCache.hasCompletedTarget || false) : false;
    
    const isTask = taskCheck.inTaskList && !taskCheck.alreadyCompleted && !hasCompletedTarget;
    const isColdWork = taskCheck.inTaskList && !taskCheck.alreadyCompleted && hasCompletedTarget;

    if (results.items.length > 0) {
      $item("#ifComment").text = "宸茶瘎璁?;
      $item("#ifComment").style.color = "#228B22";
    } else {
      // 鏈瘎璁虹姸鎬?- 鍖哄垎浠诲姟鍜屽喎闂ㄤ綔鍝?
      if (isTask) {
        $item("#ifComment").text = "鏈瘎璁猴紙浠诲姟锛侊紒锛?;
        $item("#ifComment").style.color = "#0066FF"; // 钃濊壊楂樹寒
        $item("#ifComment").style.fontWeight = "bold";
      } else if (isColdWork) {
        $item("#ifComment").text = "鏈瘎璁猴紙鍐烽棬锛?;
        $item("#ifComment").style.color = "#FFA500"; // 姗欒壊
        $item("#ifComment").style.fontWeight = "bold";
      } else {
        $item("#ifComment").text = "鏈瘎璁?;
        $item("#ifComment").style.color = "#FF4500";
      }
    }
  } catch (err) {
    console.error("妫€鏌ヨ瘎璁虹姸鎬佸け璐?, err);
    $item("#ifComment").text = "妫€鏌ュけ璐?;
    $item("#ifComment").style.color = "#A9A9A9";
  }
}

// 銆愬凡绉婚櫎 - 鏃х郴缁熴€戜互涓嬪嚱鏁板凡搴熷純锛屽姛鑳藉凡杩佺Щ鍒版柊鐨凥TML鍏冧欢
// - setupWorkSelectionEvent()
// - setupSubmitButtonEvent()
// - setupScoreCheckboxEvent()
// - setupDropdownFilterEvent()
// - setupCommentsPaginationEvents()
// - setupSearchAndPaginationEvents()
// - updateCommentControlsVerificationStatus()
// - getCommentFilterMode()
// - loadAllFormalComments()
// - setDropdownValue()

/* 銆愬凡绉婚櫎 - 鏃х郴缁熴€憇etupWorkSelectionEvent() 宸插簾寮冿紝鍔熻兘宸茶縼绉诲埌HTML鍏冧欢
function setupWorkSelectionEvent() {
  $w("#inputNumber").onChange(async () => {
    const workNumber = parseInt($w("#inputNumber").value);
    // ... 绾?50琛屼唬鐮?...
  });
}
*/

// Lightbox寮圭獥绠＄悊
function showTextPopup(content) {
  wixWindow.openLightbox("TextPopup", { content: content });
}

// 鏄剧ず鍒犻櫎纭闈㈡澘锛堟浛浠ｅ師鏉ョ殑 lightbox锛?
async function handleDeleteComment(itemData, isSelfScComment = false) {
  try {
    // 鏄剧ず鍒犻櫎纭闈㈡澘
    $w("#deleteConfirmation").show();
    
    // 鍙戦€佸垵濮嬪寲鏁版嵁鍒癏TML鍏冧欢
    $w("#deleteConfirmation").postMessage({
      action: 'init',
      commentData: {
        commentId: itemData._id,
        workNumber: itemData.workNumber,
        score: itemData.score,
        comment: itemData.comment,
        isSelfScComment: isSelfScComment,
        _owner: itemData._owner
      }
    });
    
  } catch (error) {
    console.error("鏄剧ず鍒犻櫎纭闈㈡澘澶辫触:", error);
  }
}

// 鍏抽棴鍒犻櫎纭闈㈡澘
function closeDeleteConfirmation() {
  try {
    $w("#deleteConfirmation").hide();
  } catch (error) {
    console.error("鍏抽棴鍒犻櫎纭闈㈡澘澶辫触:", error);
  }
}

// 鎵ц鍒犻櫎鎿嶄綔
async function executeDelete(commentData, deleteReason) {
  try {
    // 鎵ц鍒犻櫎
    const deleteResult = await deleteComment(
      commentData.commentId,
      currentUserId,
      deleteReason,
      commentData.isSelfScComment
    );
    
    if (deleteResult.success) {
      resetCommentDataCache();

      // 妫€鏌ユ槸鍚︿负浣滆€呰嚜璇?      let isAuthorComment = false;
      if (batchDataCache && batchDataCache.workOwnerMap) {
        const workOwner = batchDataCache.workOwnerMap[commentData.workNumber];
        isAuthorComment = commentData._owner === workOwner;
      }
      
      // 鍙戦€佸垹闄ゆ垚鍔熺粨鏋滃埌HTML鍏冧欢
      $w("#deleteConfirmation").postMessage({
        action: 'deleteResult',
        result: {
          success: true,
          deleteReason: deleteReason,
          isAuthorComment: isAuthorComment
        }
      });
      
    } else {
      // 鍙戦€佸垹闄ゅけ璐ョ粨鏋滃埌HTML鍏冧欢
      $w("#deleteConfirmation").postMessage({
        action: 'deleteResult',
        result: {
          success: false,
          message: deleteResult.message || '鍒犻櫎澶辫触'
        }
      });
    }
    
  } catch (error) {
    console.error("鎵ц鍒犻櫎鎿嶄綔澶辫触:", error);
    
    // 鍙戦€侀敊璇粨鏋滃埌HTML鍏冧欢
    $w("#deleteConfirmation").postMessage({
      action: 'deleteResult',
      result: {
        success: false,
        message: error.message || '鍒犻櫎鏃跺彂鐢熷紓甯?
      }
    });
  }
}

// 鍒濆鍖栧垹闄ょ‘璁ら潰鏉?
function initDeleteConfirmationPanel() {
  try {
    // 鍒濆鏃堕殣钘忛潰鏉?
    $w("#deleteConfirmation").hide();
    
    // 鐩戝惉鏉ヨ嚜HTML鍏冧欢鐨勬秷鎭?
    $w("#deleteConfirmation").onMessage(async (event) => {
      const action = event.data.action;
      
      if (action === 'confirmDelete') {
        // 鎵ц鍒犻櫎鎿嶄綔
        await executeDelete(event.data.commentData, event.data.deleteReason);
      } else if (action === 'cancelDelete') {
        // 鍙栨秷鍒犻櫎
        closeDeleteConfirmation();
      } else if (action === 'closeDeleteConfirmation') {
        // 鍏抽棴闈㈡澘骞跺埛鏂版暟鎹?
        closeDeleteConfirmation();
        await refreshRepeaters();
        
        // 銆愭柊澧炪€戝悓鏃跺埛鏂拌瘎璁虹郴缁烪TML鍏冧欢鐨勮瘎璁哄垪琛?
        if ($w("#commentSystemPanel")) {
          try {
            await sendCommentsData({
              workFilter: '',
              filterMode: 'default',
              currentPage: 1
            });
            console.log("[璇勮绯荤粺] 鍒犻櫎鍚庡凡鍒锋柊璇勮鍒楄〃");
          } catch (error) {
            console.error("[璇勮绯荤粺] 鍒锋柊璇勮鍒楄〃澶辫触:", error);
          }
        }
      }
    });
  } catch (error) {
    console.error("鍒濆鍖栧垹闄ょ‘璁ら潰鏉垮け璐?", error);
  }
}

// 鍒濆鍖栬嚜瀹氫箟HTML妤间腑妤煎洖澶嶉潰鏉?
function initCommentRepliesPanel() {
  // 纭繚HTML鍏冧欢瀛樺湪锛堥渶瑕佸湪Wix缂栬緫鍣ㄤ腑娣诲姞鍚嶄负 commentRepliesPanel 鐨凥TML鍏冧欢锛?
  try {
    // 鍒濆鏃堕殣钘忛潰鏉?
    $w("#commentRepliesPanel").hide();
    
    // 鐩戝惉鏉ヨ嚜HTML鍏冧欢鐨勬秷鎭?
    $w("#commentRepliesPanel").onMessage(async (event) => {
      const action = event.data.action;
      
      if (action === 'getReplies') {
        // 鑾峰彇鍥炲鏁版嵁
        await handleGetReplies(event.data.commentId);
      } else if (action === 'submitReply') {
        // 鎻愪氦鍥炲
        await handleSubmitReply(event.data);
      } else if (action === 'closeReplies') {
        // 鍏抽棴闈㈡澘
        closeCommentRepliesPanel();
      }
    });
  } catch (error) {
    console.error("鍒濆鍖栨ゼ涓ゼ鍥炲闈㈡澘澶辫触:", error);
  }
}

// 鏄剧ず璇勮鍥炲闈㈡澘锛堟浛浠ｅ師鏉ョ殑 lightbox锛?
async function showCommentReplies(commentId, workNumber, originalComment) {
  try {
    // 鏌ヨ鍥炲鏁版嵁
    const replies = await wixData
      .query("BOFcomment")
      .eq("replyTo", commentId)
      .ascending("_createdDate")
      .find();

    // 鏄剧ずHTML闈㈡澘
    $w("#commentRepliesPanel").show();
    
    // 鍙戦€佸垵濮嬪寲鏁版嵁鍒癏TML鍏冧欢
    $w("#commentRepliesPanel").postMessage({
      action: 'init',
      commentData: {
        commentId: commentId,
        workNumber: workNumber,
        originalComment: originalComment,
        replies: replies.items
      },
      currentUserId: currentUserId
    });
    
    // 婊氬姩鍒伴《閮ㄤ互纭繚闈㈡澘鍙
    $w("#commentRepliesPanel").scrollTo();
  } catch (err) {
    console.error("鏄剧ず璇勮鍥炲澶辫触", err);
  }
}

// 鍏抽棴璇勮鍥炲闈㈡澘
function closeCommentRepliesPanel() {
  try {
    $w("#commentRepliesPanel").hide();
    // 鍒锋柊椤甸潰鏁版嵁
    refreshRepeaters();
    
    // 銆愭柊澧炪€戝悓鏃跺埛鏂拌瘎璁虹郴缁烪TML鍏冧欢鐨勮瘎璁哄垪琛紙濡傛灉鏈夋柊鍥炲锛?
    if ($w("#commentSystemPanel")) {
      try {
        sendCommentsData({
          workFilter: '',
          filterMode: 'default',
          currentPage: 1
        });
        console.log("[璇勮绯荤粺] 鍥炲鍚庡凡鍒锋柊璇勮鍒楄〃");
      } catch (error) {
        console.error("[璇勮绯荤粺] 鍒锋柊璇勮鍒楄〃澶辫触:", error);
      }
    }
  } catch (error) {
    console.error("鍏抽棴鍥炲闈㈡澘澶辫触:", error);
  }
}

// 澶勭悊鑾峰彇鍥炲鏁版嵁璇锋眰
async function handleGetReplies(commentId) {
  try {
    const replies = await wixData
      .query("BOFcomment")
      .eq("replyTo", commentId)
      .ascending("_createdDate")
      .find();
    
    // 灏嗗洖澶嶆暟鎹彂閫佸洖HTML鍏冧欢
    $w("#commentRepliesPanel").postMessage({
      action: 'repliesData',
      replies: replies.items
    });
  } catch (error) {
    console.error("鑾峰彇鍥炲鏁版嵁澶辫触:", error);
    $w("#commentRepliesPanel").postMessage({
      action: 'repliesData',
      replies: []
    });
  }
}

// 澶勭悊鎻愪氦鍥炲璇锋眰
async function handleSubmitReply(data) {
  try {
    const { commentId, workNumber, replyContent } = data;
    
    if (!currentUserId) {
      $w("#commentRepliesPanel").postMessage({
        action: 'submitReplyResult',
        success: false,
        error: '鐢ㄦ埛鏈櫥褰?
      });
      return;
    }
    
    // 鍒涘缓鍥炲鏁版嵁
    const replyData = {
      workNumber: workNumber,
      comment: replyContent,
      score: 0, // 鍥炲涓嶈鍒?
      replyTo: commentId,
      submissionTime: new Date().toISOString()
    };
    
    // 鎻愪氦鍒版暟鎹簱
    const insertedReply = await wixData.insert("BOFcomment", replyData);
    
    // 鍙戦€侀偖浠堕€氱煡锛堝紓姝ユ墽琛岋紝涓嶉樆濉炵敤鎴蜂綋楠岋級
    try {
      await sendReplyNotification(
        commentId,
        replyContent,
        workNumber,
        currentUserId
      );
    } catch (emailError) {
      console.error("鍙戦€侀偖浠堕€氱煡澶辫触锛堜笉褰卞搷鍥炲鎻愪氦锛?", emailError);
    }
    
    // 閫氱煡HTML鍏冧欢鎻愪氦鎴愬姛
    $w("#commentRepliesPanel").postMessage({
      action: 'submitReplyResult',
      success: true
    });
    
  } catch (error) {
    console.error("鎻愪氦鍥炲澶辫触:", error);
    $w("#commentRepliesPanel").postMessage({
      action: 'submitReplyResult',
      success: false,
      error: error.message || '鎻愪氦澶辫触'
    });
  }
}

// 杈呭姪宸ュ叿鍑芥暟

// 銆愪紭鍖栥€戣幏鍙栨墍鏈変綔鍝佺殑璇勫垎骞惰绠楁帓鍚嶇櫨鍒嗕綅锛堟帓闄ゆ窐姹颁綔鍝侊級
// 浣跨敤鎵归噺缂撳瓨鏁版嵁锛岄伩鍏嶉€愪釜鏌ヨ浣滃搧璇勫垎
async function calculateAllWorksRanking() {
  // 濡傛灉宸叉湁缂撳瓨锛岀洿鎺ヨ繑鍥?
  if (allWorksRankingCache) {
    return allWorksRankingCache;
  }

  // 銆愬叧閿€戝鏋滄鍦ㄥ姞杞斤紝绛夊緟鍔犺浇瀹屾垚
  if (isLoadingRanking) {
    console.log("[鎬ц兘浼樺寲] 鎺掑悕鏁版嵁姝ｅ湪鍔犺浇涓紝绛夊緟瀹屾垚...");
    let waitCount = 0;
    while (isLoadingRanking && waitCount < 600) {
      await new Promise(resolve => setTimeout(resolve, 100));
      waitCount++;
    }
    return allWorksRankingCache;
  }

  // 璁剧疆鍔犺浇閿?
  isLoadingRanking = true;

  try {
    console.log("[鎬ц兘浼樺寲] 寮€濮嬭绠楁墍鏈変綔鍝佹帓鍚?..");
    const startTime = Date.now();
    
    // 銆愪紭鍖栥€戠洿鎺ヤ粠鎵归噺缂撳瓨涓幏鍙栨暟鎹?
    if (!batchDataCache || !batchDataCache.workRatings) {
      console.warn("[鎬ц兘鎻愮ず] 鎵归噺缂撳瓨鏈姞杞斤紝閲嶆柊鍔犺浇");
      await loadBatchData();
    }
    
    const workRatings = batchDataCache.workRatings;
    
    // 鏋勫缓浣滃搧璇勫垎鏁扮粍锛屾帓闄ゆ窐姹颁綔鍝?
    const worksWithScores = [];
    for (const [workNumber, ratingData] of Object.entries(workRatings)) {
      // 鎺掗櫎娣樻卑浣滃搧
      if (ratingData.isDQ) continue;
      
      worksWithScores.push({
        sequenceId: parseInt(workNumber),
        averageScore: ratingData.weightedAverage,
        numRatings: ratingData.numRatings
      });
    }

    // 鍙€冭檻鏈夎冻澶熻瘎鍒嗙殑浣滃搧锛?=闃堝€间汉璇勫垎锛?
    const validWorks = worksWithScores.filter(w => w.numRatings >= RATING_CONFIG.MIN_RATINGS_FOR_RANKING);
    
    // 鎸夊钩鍧囧垎闄嶅簭鎺掑簭
    validWorks.sort((a, b) => b.averageScore - a.averageScore);
    
    // 鍒涘缓鎺掑悕鏄犲皠
    const rankingMap = {};
    validWorks.forEach((work, index) => {
      const percentile = (index + 1) / validWorks.length;
      rankingMap[work.sequenceId] = {
        averageScore: work.averageScore,
        numRatings: work.numRatings,
        percentile: percentile,
        rank: index + 1
      };
    });

    allWorksRankingCache = {
      rankingMap: rankingMap,
      totalValidWorks: validWorks.length
    };

    const endTime = Date.now();
    console.log(`[鎬ц兘浼樺寲] 浣滃搧鎺掑悕璁＄畻瀹屾垚锛屽叡${validWorks.length}涓湁鏁堜綔鍝侊紝鑰楁椂: ${endTime - startTime}ms`);
    return allWorksRankingCache;
  } catch (error) {
    console.error("璁＄畻浣滃搧鎺掑悕澶辫触:", error);
    allWorksRankingCache = { rankingMap: {}, totalValidWorks: 0 };
    return allWorksRankingCache;
  } finally {
    // 閲婃斁鍔犺浇閿?
    isLoadingRanking = false;
  }
}

// 鏍规嵁鐧惧垎浣嶈幏鍙栫瓑绾?
function getTierFromPercentile(percentile) {
  if (percentile <= 0.05) return "T0";
  if (percentile <= 0.20) return "T1";
  if (percentile <= 0.40) return "T2";
  if (percentile <= 0.60) return "T3";
  return "T4";
}

// 銆愪紭鍖栥€戞壒閲忚幏鍙栫敤鎴锋寮忚瘎鍒嗙姸鎬?
// 浣跨敤鎵归噺缂撳瓨涓殑浣滃搧鎵€鏈夎€呬俊鎭紝鍑忓皯鏌ヨ
async function batchLoadUserFormalRatings() {
  // 濡傛灉宸叉湁缂撳瓨锛岀洿鎺ヨ繑鍥?
  if (!currentUserId || !isUserVerified || userFormalRatingsCache) {
    return userFormalRatingsCache || {};
  }

  // 銆愬叧閿€戝鏋滄鍦ㄥ姞杞斤紝绛夊緟鍔犺浇瀹屾垚
  if (isLoadingUserFormalRatings) {
    console.log("[鎬ц兘浼樺寲] 鐢ㄦ埛璇勫垎鐘舵€佹鍦ㄥ姞杞戒腑锛岀瓑寰呭畬鎴?..");
    // 绛夊緟鍔犺浇瀹屾垚锛堟渶澶氱瓑寰?0绉掞級
    let waitCount = 0;
    while (isLoadingUserFormalRatings && waitCount < 600) {
      await new Promise(resolve => setTimeout(resolve, 100));
      waitCount++;
    }
    return userFormalRatingsCache || {};
  }

  // 璁剧疆鍔犺浇閿?
  isLoadingUserFormalRatings = true;

  try {
    console.log("[鎬ц兘浼樺寲] 鎵归噺鍔犺浇鐢ㄦ埛璇勫垎鐘舵€?..");
    const startTime = Date.now();
    
    // 銆愪紭鍖栥€戜粠鎵归噺缂撳瓨鑾峰彇浣滃搧鎵€鏈夎€呬俊鎭?
    if (!batchDataCache || !batchDataCache.workOwnerMap) {
      console.warn("[鎬ц兘鎻愮ず] 鎵归噺缂撳瓨鏈姞杞斤紝閲嶆柊鍔犺浇");
      await loadBatchData();
    }
    
    const workOwnerMap = batchDataCache.workOwnerMap;

    // 鑾峰彇鐢ㄦ埛鎵€鏈夎瘎璁?
    const userComments = await wixData
      .query("BOFcomment")
      .eq("_owner", currentUserId)
      .isEmpty("replyTo")
      .limit(1000)
      .find();

    // 璁＄畻鐢ㄦ埛姝ｅ紡璇勫垎鐘舵€?
    const formalRatings = {};
    userComments.items.forEach((comment) => {
      const workOwnerId = workOwnerMap[comment.workNumber];
      if (comment._owner !== workOwnerId) {
        formalRatings[comment.workNumber] = true;
      }
    });

    userFormalRatingsCache = formalRatings;
    const endTime = Date.now();
    console.log(`[鎬ц兘浼樺寲] 鐢ㄦ埛璇勫垎鐘舵€佸姞杞藉畬鎴愶紝鍏?{Object.keys(formalRatings).length}涓綔鍝佹湁姝ｅ紡璇勫垎锛岃€楁椂: ${endTime - startTime}ms`);
    return formalRatings;
  } catch (error) {
    console.error("鎵归噺鍔犺浇鐢ㄦ埛姝ｅ紡璇勫垎鐘舵€佸け璐?", error);
    return {};
  } finally {
    // 閲婃斁鍔犺浇閿?
    isLoadingUserFormalRatings = false;
  }
}

// 妫€鏌ョ敤鎴锋槸鍚﹀浣滃搧鏈夋寮忚瘎鍒嗭紙浣跨敤缂撳瓨锛?
async function checkUserHasFormalRating(workNumber) {
  if (!currentUserId || !isUserVerified) {
    return false;
  }

  if (!userFormalRatingsCache) {
    await batchLoadUserFormalRatings();
  }

  return userFormalRatingsCache[workNumber] || false;
}

// 銆愪紭鍖栥€戞竻鐞嗙紦瀛樻暟鎹?
function clearCaches() {
  userFormalRatingsCache = null;
  replyCountsCache = {};
  workOwnersCache = {};
  workTitlesCache = {}; // 娓呯悊浣滃搧鏍囬缂撳瓨
  allWorksRankingCache = null;
  batchDataCache = null; // 娓呯悊鎵归噺鏁版嵁缂撳瓨
  userTaskDataCache = null; // 娓呯悊浠诲姟鏁版嵁缂撳瓨
  resetCommentDataCache(); // 娓呯悊璇勮鍒嗛〉缂撳瓨
  
  // 閲嶇疆鎵€鏈夊姞杞介攣
  isLoadingUserFormalRatings = false;
  isLoadingBatchData = false;
  isLoadingRanking = false;
  
  console.log("[鎬ц兘浼樺寲] 缂撳瓨鏁版嵁宸叉竻鐞?);
}

// 銆愭柊澧炪€戝閲忕儹鏇存柊 - 璇勮鎻愪氦鍚庡揩閫熸洿鏂扮姸鎬侊紙鏃犻渶瀹屽叏鍒锋柊锛?
async function incrementalUpdateAfterComment(workNumber, score, comment, isAuthorComment = false) {
  try {
    console.log(`[鐑洿鏂癩 寮€濮嬪閲忔洿鏂颁綔鍝?#${workNumber} 鐨勭姸鎬?..`);
    const startTime = Date.now();
    
    // 1. 鏇存柊璇勮璁℃暟缂撳瓨
    if (batchDataCache && batchDataCache.commentCountMap) {
      const currentCount = batchDataCache.commentCountMap[workNumber] || 0;
      batchDataCache.commentCountMap[workNumber] = currentCount + 1;
      commentsCountByWorkNumber[workNumber] = currentCount + 1;
      console.log(`[鐑洿鏂癩 璇勮璁℃暟鏇存柊: ${currentCount} -> ${currentCount + 1}`);
    }
    
    // 2. 濡傛灉涓嶆槸浣滆€呰嚜璇勶紝鏇存柊鐢ㄦ埛姝ｅ紡璇勫垎缂撳瓨鍜屼綔鍝佽瘎鍒嗘暟鎹?
    if (!isAuthorComment) {
      // 鏇存柊鐢ㄦ埛姝ｅ紡璇勫垎鐘舵€?
      if (userFormalRatingsCache) {
        userFormalRatingsCache[workNumber] = true;
        console.log(`[鐑洿鏂癩 鐢ㄦ埛璇勫垎鐘舵€佸凡鏇存柊`);
      }
      
      // 銆愪慨澶嶃€戠瓑寰呰瘎鍒嗘暟鎹洿鏂板畬鎴愬悗鍐嶆洿鏂版樉绀?
      let updatedRatingData = null;
      if (batchDataCache && batchDataCache.workRatings) {
        try {
          // 鍚屾绛夊緟璇勫垎鏁版嵁鏇存柊瀹屾垚
          const newRating = await getWorkWeightedRatingData(workNumber);
          if (newRating && batchDataCache.workRatings) {
            const oldRating = batchDataCache.workRatings[workNumber] || {};
            batchDataCache.workRatings[workNumber] = {
              numRatings: newRating.numRatings,
              weightedAverage: newRating.weightedAverage,
              originalAverage: newRating.originalAverage,
              highWeightCount: newRating.highWeightCount,
              lowWeightCount: newRating.lowWeightCount,
              ratio: newRating.ratio,
              isDQ: oldRating.isDQ
            };
            updatedRatingData = newRating;
            console.log(`[鐑洿鏂癩 璇勫垎鏁版嵁宸叉洿鏂? 浣滃搧 #${workNumber} 鐜版湁 ${newRating.numRatings}浜鸿瘎鍒哷);
          }
        } catch (error) {
          console.error("[鐑洿鏂癩 鏇存柊璇勫垎鏁版嵁澶辫触:", error);
        }
      }
      
      // 娓呯悊鎺掑悕缂撳瓨锛屽己鍒堕噸鏂拌绠楋紙鍥犱负璇勫垎鍙兘褰卞搷鎺掑悕锛?
      allWorksRankingCache = null;
    }
    
    // 3. 鐑洿鏂?Repeater2锛堜綔鍝佸垪琛級涓綋鍓嶉〉鐨勮浣滃搧鐘舵€?
    try {
      const repeater2Data = $w("#repeater2").data;
      let needUpdateRepeater2 = false;
      
      $w("#repeater2").forEachItem(($item, itemData, index) => {
        if (itemData.sequenceId === workNumber) {
          needUpdateRepeater2 = true;
          // 鏇存柊璇勮璁℃暟鏄剧ず
          const newCount = commentsCountByWorkNumber[workNumber] || 0;
          $item("#Commments").text = `${newCount}`;
          
          // 鏇存柊璇勮鐘舵€侊紙寮傛鏇存柊锛?
          updateCommentStatus($item, itemData).then(() => {
            console.log(`[鐑洿鏂癩 浣滃搧 #${workNumber} 鐨勮瘎璁虹姸鎬佸凡鏇存柊`);
          });
          
          // 銆愪慨澶嶃€戠瓑寰呰瘎鍒嗘暟鎹洿鏂板悗鍐嶆洿鏂版樉绀猴紝纭繚浣跨敤鏈€鏂版暟鎹?
          if (!isAuthorComment) {
            updateItemEvaluationDisplay($item, itemData).then(() => {
              console.log(`[鐑洿鏂癩 浣滃搧 #${workNumber} 鐨勮瘎鍒嗘樉绀哄凡鏇存柊`);
            });
          }
        }
      });
      
      if (needUpdateRepeater2) {
        console.log(`[鐑洿鏂癩 Repeater2涓綔鍝?#${workNumber} 宸茬儹鏇存柊`);
      }
    } catch (error) {
      console.error("[鐑洿鏂癩 鏇存柊Repeater2澶辫触:", error);
    }
    
    // 4. 銆愪紭鍖栥€戦€氱煡鏂拌瘎璁虹郴缁熷埛鏂帮紙濡傛灉姝ｅ湪鏌ョ湅璇ヤ綔鍝佺殑璇勮锛?
    // 鏂扮郴缁熶細鑷姩鍦ㄦ彁浜ゅ悗鍒锋柊锛岃繖閲屾棤闇€棰濆鎿嶄綔
    // 鏃х殑 setDropdownValue 宸插簾寮?
    
    const endTime = Date.now();
    console.log(`[鐑洿鏂癩 澧為噺鏇存柊瀹屾垚锛岃€楁椂: ${endTime - startTime}ms`);
    
    return { success: true };
  } catch (error) {
    console.error("[鐑洿鏂癩 澧為噺鏇存柊澶辫触:", error);
    return { success: false, error };
  }
}

// 銆愪紭鍖栥€戠粺涓€鍒锋柊涓や釜repeater锛堝畬鍏ㄥ埛鏂帮紝鐢ㄤ簬鍒犻櫎璇勮绛夐渶瑕佸畬鍏ㄥ悓姝ョ殑鍦烘櫙锛?
async function refreshRepeaters() {
  try {
    console.log("[鎬ц兘浼樺寲] 寮€濮嬪畬鍏ㄥ埛鏂癛epeaters...");
    const startTime = Date.now();
    
    // 娓呯悊缂撳瓨浠ョ‘淇濇暟鎹悓姝?
    clearCaches();
    
    // 閲嶆柊鎵归噺鍔犺浇鎵€鏈夋暟鎹?
    await loadBatchData();
    
    // 銆愪紭鍖栥€戦噸鏂板姞杞戒换鍔℃暟鎹紦瀛?
    if (currentUserId && isUserVerified) {
      try {
        userTaskDataCache = await getUserTaskData(currentUserId);
        console.log("[鎬ц兘浼樺寲] 浠诲姟鏁版嵁缂撳瓨宸查噸鏂板姞杞?);
      } catch (error) {
        console.error("[鎬ц兘浼樺寲] 浠诲姟鏁版嵁閲嶆柊鍔犺浇澶辫触:", error);
        userTaskDataCache = { hasCompletedTarget: false, taskList: [] };
      }
    }
    
    const currentPage = $w("#paginator").currentPage || 1;
    const searchValue = $w("#input1").value;
    const dropdownValue = $w("#dropdown1").value;
    await updateRepeaterData(currentPage, searchValue, dropdownValue);

    // 閲嶆柊鍔犺浇鐢ㄦ埛璇勫垎缂撳瓨
    if (currentUserId && isUserVerified) {
      await batchLoadUserFormalRatings();
    }
    
    // 閲嶆柊鍔犺浇鎺掑悕鏁版嵁
    await calculateAllWorksRanking();

    // 銆愪紭鍖栥€戦€氱煡鏂拌瘎璁虹郴缁烪TML鍏冧欢鍒锋柊璇勮鍒楄〃
    if ($w("#commentSystemPanel")) {
      try {
        await sendCommentsData({
          workFilter: '',
          filterMode: 'default',
          currentPage: 1
        });
        console.log("[璇勮绯荤粺] 宸插埛鏂拌瘎璁哄垪琛?);
      } catch (error) {
        console.error("[璇勮绯荤粺] 鍒锋柊璇勮鍒楄〃澶辫触:", error);
      }
    }

    const endTime = Date.now();
    console.log(`[鎬ц兘浼樺寲] 瀹屽叏鍒锋柊瀹屾垚锛岃€楁椂: ${endTime - startTime}ms`);
  } catch (error) {
    console.error("鍒锋柊Repeaters鏃跺彂鐢熼敊璇?", error);
  }
}

// 瑙ｆ瀽maidata鏂囦欢涓殑闅惧害绛夌骇
async function parseDifficultyLevels($item, maidataUrl) {
  try {
    const { downloadUrl, fileContent } = await getFileDownloadUrlAndContent(
      maidataUrl
    );

    const lv4Pattern = /&lv_4=([\d+]+)/;
    const lv5Pattern = /&lv_5=([\d+]+)/;
    const lv6Pattern = /&lv_6=([\d+]+)/;

    const lv4Match = fileContent.match(lv4Pattern);
    const lv5Match = fileContent.match(lv5Pattern);
    const lv6Match = fileContent.match(lv6Pattern);

    $item("#LevelExpert").text = lv4Match ? lv4Match[1] : "";
    $item("#LevelMaster").text = lv5Match ? lv5Match[1] : "";
    $item("#LevelRe").text = lv6Match ? lv6Match[1] : "";
  } catch (error) {
    console.error("Error fetching file content:", error);
  }
}

// 銆愪紭鍖栥€戞樉绀轰綔鑰呬俊鎭拰鏍峰紡
// 浼樺寲锛氫娇鐢ㄦ壒閲忕紦瀛橈紝鍙湪蹇呰鏃舵煡璇綔鍝佸悕绉?
async function displayAuthorInfo($item, itemData) {
  try {
    let contestItem = null;

    // 銆愪紭鍖栥€戜綔鍝佹墍鏈夎€呬俊鎭凡鍦ㄦ壒閲忕紦瀛樹腑锛屾棤闇€閲嶅鑾峰彇
    // 鍙渶瑕佽幏鍙栦綔鍝佸悕绉扮敤浜庢樉绀?
    const results = await wixData
      .query("enterContest034")
      .eq("sequenceId", itemData.workNumber)
      .find();

    if (results.items.length > 0) {
      contestItem = results.items[0];
    }

    // 璁剧疆text15鏄剧ず浣滃搧鏍囬
    if (contestItem && contestItem.firstName) {
      $item("#text15").text = contestItem.firstName;
    } else {
      $item("#text15").text = "鏈煡浣滃搧";
    }
   
  } catch (error) {
    console.error("鏄剧ず浣滆€呬俊鎭け璐?", error);
    $item("#text15").text = "Unknown";
  }
}

// 鎵归噺鍔犺浇鍥炲鏁伴噺
async function batchLoadReplyCounts(commentIds) {
  const uncachedIds = commentIds.filter(id => !(id in replyCountsCache));
  
  if (uncachedIds.length === 0) {
    return;
  }

  try {
   // console.log(`鎵归噺鍔犺浇${uncachedIds.length}涓瘎璁虹殑鍥炲鏁伴噺...`);
    
    // 鎵归噺鏌ヨ鎵€鏈夊洖澶?
    const allReplies = await wixData
      .query("BOFcomment")
      .hasSome("replyTo", uncachedIds)
      .find();

    // 缁熻姣忎釜璇勮鐨勫洖澶嶆暟閲?
    const counts = {};
    allReplies.items.forEach(reply => {
      const parentId = reply.replyTo;
      counts[parentId] = (counts[parentId] || 0) + 1;
    });

    // 鏇存柊缂撳瓨
    uncachedIds.forEach(id => {
      replyCountsCache[id] = counts[id] || 0;
    });

   // console.log(`鍥炲鏁伴噺鍔犺浇瀹屾垚锛屽叡${Object.keys(counts).length}涓瘎璁烘湁鍥炲`);
  } catch (err) {
    console.error("鎵归噺鍔犺浇鍥炲鏁伴噺澶辫触", err);
    // 涓烘湭鑳藉姞杞界殑ID璁剧疆榛樿鍊?
    uncachedIds.forEach(id => {
      replyCountsCache[id] = 0;
    });
  }
}

// 鏄剧ず鍥炲鏁伴噺锛堜娇鐢ㄧ紦瀛橈級
async function displayReplyCount($item, commentId) {
  try {
    if (!(commentId in replyCountsCache)) {
      await batchLoadReplyCounts([commentId]);
    }

    const replyCount = replyCountsCache[commentId] || 0;

    if (replyCount > 0) {
      $item("#replyCountText").text = `${replyCount}鏉″洖澶峘;
      $item("#replyCountText").show();
    } else {
      $item("#replyCountText").text = "";
      $item("#replyCountText").hide();
    }
  } catch (err) {
    console.error("鏄剧ず鍥炲鏁伴噺澶辫触", err);
    $item("#replyCountText").text = "";
    $item("#replyCountText").hide();
  }
}

// 璁剧疆浣滃搧椤圭洰鐨勪簨浠剁洃鍚櫒
function setupItemEventListeners($item, itemData, downloadUrl) {
  $item("#button3").onClick(() => {
    $w("#htmlDownloadHelper").postMessage({
      action: "download",
      downloadUrl,
      titleValue,
    });
  });

  $item("#checkText").onClick(() => {
    const descriptionText = $item("#descriptionBox").value;
    showTextPopup(descriptionText);
  });

  $item("#vectorImage2").onClick(async () => {
    // 銆愪紭鍖栥€戦€氱煡鏂拌瘎璁虹郴缁熺瓫閫夎浣滃搧鐨勮瘎璁?
    if ($w("#commentSystemPanel")) {
      try {
        await sendCommentsData({
          workFilter: itemData.sequenceId.toString(),
          filterMode: 'default',
          currentPage: 1
        });
        console.log(`[璇勮绯荤粺] 宸插垏鎹㈠埌浣滃搧 #${itemData.sequenceId} 鐨勮瘎璁篳);
      } catch (error) {
        console.error("[璇勮绯荤粺] 鍒囨崲璇勮绛涢€夊け璐?", error);
      }
    }
  });
}

// 鏃ユ湡鏍煎紡鍖栧伐鍏?
function formatDate(date) {
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}.${month}.${day}`;
}


// 鏁版嵁澶勭悊涓庡垎椤?
async function updateRepeaterData(pageNumber, searchValue, dropdownValue) {
  $w("#loadingSpinner").show();

  let query = wixData.query("enterContest034");

  if (searchValue) {
    query = query
      .contains("firstName", searchValue)
      .or(query.eq("sequenceId", Number(searchValue)));
  }

  let results = await query.limit(1000).find();

  // 鏇存柊涓嬫媺鑿滃崟閫夐」锛堟帓闄ゆ窐姹颁綔鍝侊級
  const filteredItems = results.items.filter((item) => item.isDq !== true);
  const options = [{ label: "Please Choose ID", value: "" }].concat(
    filteredItems.map((item) => {
      return {
        label: item.sequenceId + " - " + item.firstName,
        value: item.sequenceId.toString(),
      };
    })
  );

  $w("#inputNumber").options = options;
  $w("#dropdownFilter").options = options;

  let items = results.items;

  if (dropdownValue === "rating") {
    items = await sortByRating(items);
  } else if (dropdownValue === "task") {
    items = await sortByTask(items);
  }

  // 鍒嗛〉澶勭悊
  const totalPages = Math.ceil(items.length / itemsPerPage);
  $w("#paginator").totalPages = totalPages;
  $w("#paginator").currentPage = pageNumber;
  $w("#paginator2").totalPages = totalPages;
  $w("#paginator2").currentPage = pageNumber;

  const startIndex = (pageNumber - 1) * itemsPerPage;
  const pagedItems = items.slice(startIndex, startIndex + itemsPerPage);

  $w("#repeater2").data = pagedItems;

  $w("#repeater2").forEachItem(async ($item, itemData, index) => {
    const commentCount = commentsCountByWorkNumber[itemData.sequenceId] || 0;
    $item("#Commments").text = `${commentCount}`;

    if (index === pagedItems.length - 1) {
      $w("#loadingSpinner").hide();
    }
  });

  if (pagedItems.length === 0) {
    $w("#loadingSpinner").hide();
  }
}

// 鏍囪璋遍潰鏌ョ湅鐘舵€?
async function markSheetAsViewed(sheetId, userId) {
  try {
    const currentItemResult = await wixData
      .query("enterContest034")
      .eq("_id", sheetId)
      .find();
    let currentItem = currentItemResult.items[0];
    let viewedBy = currentItem.viewedBy ? JSON.parse(currentItem.viewedBy) : [];
    let viewedCount = viewedBy.length;

    if (!viewedBy.includes(userId)) {
      viewedBy.push(userId);
      currentItem.viewedBy = JSON.stringify(viewedBy);
      await wixData.update("enterContest034", currentItem);
      viewedCount = viewedBy.length;
    }

    return viewedCount;
  } catch (error) {
    console.error("Error marking sheet as viewed:", error);
    return null;
  }
}

// 鏇存柊涓嬭浇鎸夐挳鐘舵€?
async function updateButtonStatus($item, sheetId) {
  $item("#button3").enable();
  $item("#button3").show();
  $item("#downloadAble").show();
}

// 銆愪紭鍖栥€戣幏鍙栬瘎鍒嗘暟鎹紙鎺掗櫎浣滆€呰嚜璇勶紝浣跨敤鍔犳潈骞冲潎鍒嗭級
// 浼樺厛浣跨敤鎵归噺缂撳瓨锛屽ぇ骞呭噺灏慉PI璋冪敤
async function getRatingData(workNumber) {
  try {
    // 浼樺厛浠庢壒閲忕紦瀛樹腑鑾峰彇
    if (batchDataCache && batchDataCache.workRatings && batchDataCache.workRatings[workNumber]) {
      const cachedData = batchDataCache.workRatings[workNumber];
      return {
        numRatings: cachedData.numRatings,
        averageScore: cachedData.weightedAverage,
        originalAverage: cachedData.originalAverage,
        highWeightCount: cachedData.highWeightCount,
        lowWeightCount: cachedData.lowWeightCount,
        ratio: cachedData.ratio
      };
    }
    
    // 缂撳瓨鏈懡涓椂鎵嶈皟鐢ㄥ悗绔紙闄嶇骇鏂规锛?
    console.warn(`[鎬ц兘鎻愮ず] 浣滃搧 ${workNumber} 鏈湪缂撳瓨涓紝闄嶇骇鏌ヨ`);
    const weightedData = await getWorkWeightedRatingData(workNumber);
    
    return {
      numRatings: weightedData.numRatings,
      averageScore: weightedData.weightedAverage,
      originalAverage: weightedData.originalAverage,
      highWeightCount: weightedData.highWeightCount,
      lowWeightCount: weightedData.lowWeightCount,
      ratio: weightedData.ratio
    };
  } catch (error) {
    console.error("鑾峰彇璇勫垎鏁版嵁澶辫触:", error);
    return {
      numRatings: 0,
      averageScore: 0,
      originalAverage: 0,
      highWeightCount: 0,
      lowWeightCount: 0,
      ratio: 0
    };
  }
}


// 銆愬凡搴熷純銆戠粺璁℃墍鏈変綔鍝佺殑璇勮鏁伴噺锛堜粎涓昏瘎璁猴級
// 鏀圭敤鎵归噺鏁版嵁涓殑 commentCountMap锛屾棤闇€鍗曠嫭鏌ヨ
// 淇濈暀姝ゅ嚱鏁颁綔涓洪檷绾ф柟妗?
async function getAllCommentsCount() {
  // 浼樺厛浠庢壒閲忕紦瀛樿幏鍙?
  if (batchDataCache && batchDataCache.commentCountMap) {
    return batchDataCache.commentCountMap;
  }
  
  // 闄嶇骇鏂规锛氱洿鎺ユ煡璇紙鎬ц兘杈冧綆锛屼粎浣滀负澶囩敤锛?
  console.warn("[鎬ц兘鎻愮ず] 鎵归噺缂撳瓨鏈姞杞斤紝浣跨敤闄嶇骇鏌ヨ璇勮璁℃暟");
  let commentsCountByWorkNumber = {};
  
  try {
    // 涓€娆℃€ф煡璇㈡墍鏈変富璇勮
    const allComments = await wixData
      .query("BOFcomment")
      .isEmpty("replyTo")
      .limit(1000)
      .find();

    allComments.items.forEach((item) => {
      if (commentsCountByWorkNumber[item.workNumber]) {
        commentsCountByWorkNumber[item.workNumber] += 1;
      } else {
        commentsCountByWorkNumber[item.workNumber] = 1;
      }
    });
  } catch (err) {
    console.error("鑾峰彇璇勮璁℃暟澶辫触:", err);
  }

  return commentsCountByWorkNumber;
}

/* 銆愬凡绉婚櫎 - 鏃х郴缁熴€憇etDropdownValue() 宸插簾寮冿紝鍔熻兘宸茶縼绉诲埌HTML鍏冧欢
async function setDropdownValue(sequenceId, pageNumber = 1) {
  // ... 绾?0琛岃缃笅鎷夌瓫閫夌殑浠ｇ爜锛堝凡搴熷純锛?..
}
*/

// 鏇存柊浣滃搧璇勫垎鏄剧ず锛堝熀浜庢帓鍚嶇櫨鍒嗕綅鐨勭瓑绾х郴缁燂紝鎺掗櫎娣樻卑浣滃搧锛?
async function updateItemEvaluationDisplay($item, itemData) {
  try {
    const workNumber = itemData.sequenceId;

    // 娣樻卑浣滃搧涓嶆樉绀鸿瘎鍒?
    if (itemData.isDq === true) {
      $item("#totalscore").text = "";
      $item("#box1").style.backgroundColor = "transparent";
      return;
    }

    const userHasFormalRating = await checkUserHasFormalRating(workNumber);

    if (!userHasFormalRating) {
      $item("#totalscore").text = "";
      $item("#box1").style.backgroundColor = "transparent";
      return;
    }

    const ratingData = await getRatingData(workNumber);
    const evaluationCount = ratingData.numRatings;
    const averageScore = ratingData.averageScore;

    if (evaluationCount > 0) {
      if (evaluationCount >= RATING_CONFIG.MIN_RATINGS_FOR_RANKING) {
        // 鑾峰彇鎺掑悕淇℃伅
        const rankingData = await calculateAllWorksRanking();
        const workRanking = rankingData.rankingMap[workNumber];
        
        if (workRanking) {
          const tier = getTierFromPercentile(workRanking.percentile);
          $item("#totalscore").text = `${tier} (${evaluationCount}浜鸿瘎鍒?`;

          // 鏍规嵁绛夌骇璁剧疆鑳屾櫙鑹?
          if (tier === "T0") {
            $item("#box1").style.backgroundColor = "rgba(255, 215, 0, 0.6)"; // 閲戣壊
          } else if (tier === "T1") {
            $item("#box1").style.backgroundColor = "rgba(135, 206, 235, 0.5)"; // 澶╄摑鑹?
          } else if (tier === "T2") {
            $item("#box1").style.backgroundColor = "rgba(144, 238, 144, 0.4)"; // 娴呯豢鑹?
          } else if (tier === "T3") {
            $item("#box1").style.backgroundColor = "rgba(255, 255, 224, 0.4)"; // 娴呴粍鑹?
          } else {
            $item("#box1").style.backgroundColor = "rgba(211, 211, 211, 0.3)"; // 娴呯伆鑹?
          }
        } else {
          // 鏈夎瘎鍒嗕絾鏈繘鍏ユ帓鍚嶏紙鍙兘琚窐姹版垨鍏朵粬鍘熷洜锛?
          $item("#totalscore").text = "";
          $item("#box1").style.backgroundColor = "transparent";
        }
      } else {
        $item(
          "#totalscore"
        ).text = `璇勫垎閲忎笉瓒?${evaluationCount}浜鸿瘎鍒?`;
        $item("#box1").style.backgroundColor = "rgba(255, 255, 0, 0.3)";
      }
    } else {
      $item("#totalscore").text = "鏆傛棤璇勫垎";
      $item("#box1").style.backgroundColor = "transparent";
    }
  } catch (error) {
    console.error("鏇存柊璇勫垎鏄剧ず鏃跺嚭閿?", error);
    $item("#totalscore").text = "璇勫垎鍔犺浇澶辫触";
  }
}

// 鍩轰簬浠诲姟鎺掑簭浣滃搧锛堜换鍔′綔鍝佷紭鍏堬紝娣樻卑浣滃搧鍚庣疆锛?
async function sortByTask(items) {
  try {
    // 濡傛灉鐢ㄦ埛鏈櫥褰曟垨鏈獙璇侊紝鎸夐粯璁ら『搴忚繑鍥?
    if (!currentUserId || !isUserVerified) {
      return items;
    }

    const itemsWithTaskStatus = await Promise.all(
      items.map(async (item) => {
        const taskCheck = await checkIfWorkInTaskList(currentUserId, item.sequenceId);
        const isTask = taskCheck.inTaskList && !taskCheck.alreadyCompleted;
        const isTaskCompleted = taskCheck.alreadyCompleted;
        const isDQ = item.isDq === true;

        return {
          ...item,
          isTask: isTask, // 鏈畬鎴愮殑浠诲姟
          isTaskCompleted: isTaskCompleted, // 宸插畬鎴愮殑浠诲姟
          isDQ: isDQ // 娣樻卑浣滃搧
        };
      })
    );

    // 鍥涚骇鍒嗙被锛氭湭瀹屾垚鐨勪换鍔?> 宸插畬鎴愮殑浠诲姟 > 鍏朵粬浣滃搧 > 娣樻卑浣滃搧
    const uncompletedTaskItems = itemsWithTaskStatus.filter(item => item.isTask && !item.isDQ);
    const completedTaskItems = itemsWithTaskStatus.filter(item => item.isTaskCompleted && !item.isDQ && !item.isTask);
    const otherItems = itemsWithTaskStatus.filter(item => !item.isTask && !item.isTaskCompleted && !item.isDQ);
    const disqualifiedItems = itemsWithTaskStatus.filter(item => item.isDQ);

    // 鍚勫垎绫诲唴閮ㄦ寜sequenceId鎺掑簭
    uncompletedTaskItems.sort((a, b) => a.sequenceId - b.sequenceId);
    completedTaskItems.sort((a, b) => a.sequenceId - b.sequenceId);
    otherItems.sort((a, b) => a.sequenceId - b.sequenceId);
    disqualifiedItems.sort((a, b) => a.sequenceId - b.sequenceId);

    // 鎺掑簭浼樺厛绾э細鏈畬鎴愪换鍔?> 宸插畬鎴愪换鍔?> 鍏朵粬浣滃搧 > 娣樻卑浣滃搧
    return [...uncompletedTaskItems, ...completedTaskItems, ...otherItems, ...disqualifiedItems];
  } catch (error) {
    console.error("鎸変换鍔℃帓搴忔椂鍑洪敊:", error);
    return items;
  }
}

// 鍩轰簬璇勫垎鎺掑簭浣滃搧锛堟帓闄や綔鑰呰嚜璇勶紝鑰冭檻鐢ㄦ埛璇勫垎鏉冮檺锛屾窐姹颁綔鍝佸悗缃級
async function sortByRating(items) {
  try {
    const itemsWithRating = await Promise.all(
      items.map(async (item) => {
        const ratingData = await getRatingData(item.sequenceId);
        const userHasFormalRating = await checkUserHasFormalRating(item.sequenceId);
        
        // 鍙湁鐢ㄦ埛瀵硅浣滃搧鏈夋寮忚瘎鍒嗘椂锛屾墠鑳界湅鍒板苟鍙備笌鎺掑簭
        const canSeeRating = userHasFormalRating && ratingData.numRatings >= RATING_CONFIG.MIN_RATINGS_FOR_RANKING;
        const averageScore = canSeeRating ? ratingData.averageScore : 0;

        return {
          ...item,
          rating: averageScore,
          numRatings: ratingData.numRatings,
          canSeeRating: canSeeRating, // 鏍囪鐢ㄦ埛鏄惁鑳界湅鍒拌瘎鍒?
          isDQ: item.isDq === true, // 鏍囪鏄惁娣樻卑
        };
      })
    );

    // 涓夌骇鍒嗙被锛氳兘鐪嬪埌璇勫垎鐨勯潪娣樻卑浣滃搧銆佷笉鑳界湅鍒拌瘎鍒嗙殑闈炴窐姹颁綔鍝併€佹窐姹颁綔鍝?
    const visibleRatingItems = itemsWithRating.filter(item => item.canSeeRating && !item.isDQ);
    const hiddenRatingItems = itemsWithRating.filter(item => !item.canSeeRating && !item.isDQ);
    const disqualifiedItems = itemsWithRating.filter(item => item.isDQ);

    // 鑳界湅鍒拌瘎鍒嗙殑浣滃搧鎸夎瘎鍒嗘帓搴?
    visibleRatingItems.sort((a, b) => {
      if (a.rating === b.rating) {
        return b.numRatings - a.numRatings;
      }
      return b.rating - a.rating;
    });

    // 涓嶈兘鐪嬪埌璇勫垎鐨勪綔鍝佹寜sequenceId鎺掑簭
    hiddenRatingItems.sort((a, b) => a.sequenceId - b.sequenceId);

    // 娣樻卑浣滃搧鎸塻equenceId鎺掑簭
    disqualifiedItems.sort((a, b) => a.sequenceId - b.sequenceId);

    // 鎺掑簭浼樺厛绾э細鏈夎瘎鍒嗗彲瑙?> 璇勫垎涓嶅彲瑙?> 娣樻卑浣滃搧
    return [...visibleRatingItems, ...hiddenRatingItems, ...disqualifiedItems];
  } catch (error) {
    console.error("鎺掑簭鏃跺嚭閿?", error);
    return items;
  }
}

// 銆愪繚鐣?- Repeater2浣滃搧鍒楄〃銆戞悳绱㈠拰鍒嗛〉浜嬩欢鐩戝惉鍣?
// 鈿狅笍 姝ゅ嚱鏁扮敤浜庝綔鍝佸垪琛紙repeater2锛夛紝涓嶆槸璇勮绯荤粺
function setupSearchAndPaginationEvents() {
  $w("#input1").onInput(async () => {
    const searchValue = $w("#input1").value;
    const dropdownValue = $w("#dropdown1").value;
    await updateRepeaterData(1, searchValue, dropdownValue);
  });

  $w("#paginator, #paginator2").onClick(async (event) => {
    const pageNumber = event.target.currentPage;
    const searchValue = $w("#input1").value;
    const dropdownValue = $w("#dropdown1").value;
    await updateRepeaterData(pageNumber, searchValue, dropdownValue);
  });

  $w("#dropdown1").onChange(async () => {
    const searchValue = $w("#input1").value;
    const pageNumber = 1;
    const dropdownValue = $w("#dropdown1").value;
    await updateRepeaterData(pageNumber, searchValue, dropdownValue);
  });
}

/* 銆愬凡绉婚櫎 - 鏃ц瘎璁虹郴缁熴€戜互涓嬪嚱鏁板凡搴熷純锛屽姛鑳藉凡杩佺Щ鍒癏TML鍏冧欢
- setupCommentsPaginationEvents() - 璇勮鍒嗛〉锛堝凡搴熷純锛?
- setupSubmitButtonEvent() - 鎻愪氦鎸夐挳锛堝凡搴熷純锛?
- getCommentFilterMode() - 鑾峰彇绛涢€夋ā寮忥紙宸插簾寮冿級
- setupScoreCheckboxEvent() - 璇勫垎绛涢€夛紙宸插簾寮冿級
- loadAllFormalComments() - 鍔犺浇璇勮锛堝凡搴熷純锛?
- setupDropdownFilterEvent() - 璇勮绛涢€夛紙宸插簾寮冿級
*/

// ==================== 璇勮绯荤粺HTML鍏冧欢闆嗘垚 ====================

// 鍒濆鍖栬瘎璁虹郴缁烪TML鍏冧欢
function initCommentSystemPanel() {
  try {
    // 纭繚HTML鍏冧欢瀛樺湪
    if (!$w("#commentSystemPanel")) {
      console.error("[璇勮绯荤粺] HTML鍏冧欢鏈壘鍒?);
      return;
    }

    console.log("[璇勮绯荤粺] 寮€濮嬪垵濮嬪寲...");

    // 鐩戝惉鏉ヨ嚜HTML鍏冧欢鐨勬秷鎭?
    $w("#commentSystemPanel").onMessage(async (event) => {
      const { type, data } = event.data;
      console.log(`[璇勮绯荤粺] 鏀跺埌娑堟伅: ${type}`, data);

      switch (type) {
        case 'COMMENT_SYSTEM_READY':
          await handleCommentSystemReady();
          break;
        case 'REQUEST_WORK_OPTIONS':
          await sendWorkOptions();
          break;
        case 'REQUEST_COMMENTS':
          await sendCommentsData(data);
          break;
        case 'SUBMIT_COMMENT':
          await handleCommentSubmit(data);
          break;
        case 'WORK_NUMBER_CHANGED':
          await handleWorkNumberChange(data.workNumber);
          break;
        case 'GOTO_WORK':
          await handleGotoWork(data.workNumber);
          break;
        case 'VIEW_REPLIES':
          await handleViewReplies(data);
          break;
        case 'DELETE_COMMENT':
          await handleDeleteComment(data, data.isSelfScComment);
          break;
        default:
          console.log('[璇勮绯荤粺] 鏈煡娑堟伅绫诲瀷:', type);
      }
    });

    console.log("[璇勮绯荤粺] 鍒濆鍖栧畬鎴?);
  } catch (error) {
    console.error("[璇勮绯荤粺] 鍒濆鍖栧け璐?", error);
  }
}

// HTML鍏冧欢鍑嗗灏辩华
async function handleCommentSystemReady() {
  console.log("[璇勮绯荤粺] HTML鍏冧欢宸插噯澶囧氨缁?);

  // 鍙戦€佸垵濮嬪寲鏁版嵁
  $w("#commentSystemPanel").postMessage({
    type: 'INIT_COMMENT_SYSTEM',
    data: {
      currentUserId: currentUserId,
      isUserVerified: isUserVerified
    }
  });
}

// 鍙戦€佷綔鍝侀€夐」
async function sendWorkOptions() {
  try {
    // 鏌ヨ鎵€鏈変綔鍝侊紙鎺掗櫎娣樻卑浣滃搧锛?
    const results = await wixData.query("enterContest034").limit(1000).find();
    const filteredItems = results.items.filter((item) => item.isDq !== true);
    
    // 銆愪紭鍖栥€戝悓鏃剁紦瀛樻墍鏈変綔鍝佹爣棰橈紝閬垮厤鍚庣画鏌ヨ
    results.items.forEach((item) => {
      workTitlesCache[item.sequenceId] = item.firstName;
    });
    console.log(`[璇勮绯荤粺] 宸茬紦瀛?${Object.keys(workTitlesCache).length} 涓綔鍝佹爣棰榒);
    
    const options = filteredItems.map((item) => ({
      label: `${item.sequenceId} - ${item.firstName}`,
      value: item.sequenceId.toString()
    }));

    $w("#commentSystemPanel").postMessage({
      type: 'WORK_OPTIONS',
      data: { options }
    });

    console.log(`[璇勮绯荤粺] 宸插彂閫?${options.length} 涓綔鍝侀€夐」`);
  } catch (error) {
    console.error("[璇勮绯荤粺] 鍙戦€佷綔鍝侀€夐」澶辫触:", error);
  }
}

// ==================== 璇勮鍒嗛〉杈呭姪鍑芥暟 ====================
function normalizeWorkFilter(workFilter) {
  if (workFilter === undefined || workFilter === null || workFilter === "") {
    return null;
  }
  const numeric = parseInt(workFilter, 10);
  return Number.isFinite(numeric) ? numeric : null;
}

function getCommentCacheKey(workFilter, filterMode) {
  const normalized = normalizeWorkFilter(workFilter);
  const modeKey = filterMode || "default";
  const ownerKey = modeKey === "YourComment" ? (currentUserId || "guest") : "all";
  return `${normalized !== null ? normalized : "all"}|${modeKey}|${ownerKey}`;
}

function updateCommentPaginationTotals(state, pageLength) {
  if (!state) {
    return;
  }
  const computedCount = (state.pages.size - 1) * state.pageSize + pageLength;
  if (computedCount > state.totalCount) {
    state.totalCount = computedCount;
    state.totalPages = Math.max(1, Math.ceil(state.totalCount / state.pageSize));
  }
}

function resetCommentDataCache() {
  commentDataCache.clear();
  selfScCommentIdCache = null;
}

async function loadSelfScCommentIdSet() {
  if (selfScCommentIdCache) {
    return selfScCommentIdCache;
  }

  if (isLoadingSelfScComments) {
    let waitCount = 0;
    while (isLoadingSelfScComments && waitCount < 200) {
      await new Promise((resolve) => setTimeout(resolve, 50));
      waitCount++;
    }
    return selfScCommentIdCache || new Set();
  }

  isLoadingSelfScComments = true;

  try {
    await loadBatchData();

    const ownerMap = workOwnersCache || {};
    const ownerIds = Array.from(new Set(Object.values(ownerMap).filter(Boolean)));

    if (ownerIds.length === 0) {
      selfScCommentIdCache = new Set();
      return selfScCommentIdCache;
    }

    const scCommentIds = new Set();
    const chunkSize = 50;

    for (let i = 0; i < ownerIds.length; i += chunkSize) {
      const chunk = ownerIds.slice(i, i + chunkSize);
      let query = wixData
        .query("BOFcomment")
        .isEmpty("replyTo")
        .hasSome("_owner", chunk)
        .limit(1000);

      let result = await query.find();

      while (result) {
        result.items.forEach((item) => {
          if (ownerMap[item.workNumber] && ownerMap[item.workNumber] === item._owner) {
            scCommentIds.add(item._id);
          }
        });

        if (result.hasNext()) {
          result = await result.next();
        } else {
          break;
        }
      }
    }

    selfScCommentIdCache = scCommentIds;
    return selfScCommentIdCache;
  } catch (error) {
    console.error("[璇勮绯荤粺] 鍔犺浇浣滆€呰嚜璇勮瘎璁篒D澶辫触:", error);
    selfScCommentIdCache = new Set();
    return selfScCommentIdCache;
  } finally {
    isLoadingSelfScComments = false;
  }
}

async function initializeCommentPaginationState(workFilter, filterMode = "default") {
  const normalizedWorkFilter = normalizeWorkFilter(workFilter);
  const effectiveFilterMode = filterMode || "default";
  const pageSize = commentsPerPage;

  const createQuery = () => {
    let query = wixData.query("BOFcomment");

    if (normalizedWorkFilter !== null) {
      return query.eq("workNumber", normalizedWorkFilter).ascending("_createdDate");
    }

    if (effectiveFilterMode === "YourComment") {
      if (!currentUserId) {
        return query.eq("_id", "__empty__");
      }
      return query.eq("_owner", currentUserId).descending("_createdDate");
    }

    return query.isEmpty("replyTo").descending("_createdDate");
  };

  let totalCount = 0;
  let selfScCommentIds = new Set();
  const isScoreOnly = normalizedWorkFilter === null && effectiveFilterMode === "ScoreOnly";

  if (effectiveFilterMode === "YourComment" && !currentUserId) {
    totalCount = 0;
  } else if (normalizedWorkFilter !== null) {
    totalCount = await wixData.query("BOFcomment").eq("workNumber", normalizedWorkFilter).count();
  } else if (effectiveFilterMode === "YourComment") {
    totalCount = await wixData.query("BOFcomment").eq("_owner", currentUserId).count();
  } else {
    totalCount = await wixData.query("BOFcomment").isEmpty("replyTo").count();
  }

  if (isScoreOnly) {
    selfScCommentIds = await loadSelfScCommentIdSet();
    if (totalCount > 0) {
      totalCount = Math.max(0, totalCount - selfScCommentIds.size);
    }
  }

  const initialTotalPages = totalCount > 0 ? Math.ceil(totalCount / pageSize) : 1;

  const state = {
    workFilter: normalizedWorkFilter,
    rawWorkFilter: workFilter,
    filterMode: effectiveFilterMode,
    pageSize,
    totalCount,
    totalPages: initialTotalPages,
    createQuery,
    lastResult: null,
    fetchLimit: isScoreOnly ? pageSize * 3 : pageSize,
    pages: new Map(),
    buffer: [],
    noMoreData: totalCount === 0,
    isScoreOnly,
    selfScCommentIds,
    loadingPromise: null,
  };

  if (state.noMoreData) {
    state.pages.set(1, []);
  }

  return state;
}

async function fetchMoreComments(state) {
  if (!state || state.noMoreData) {
    return;
  }

  try {
    let result;

    if (!state.lastResult) {
      result = await state.createQuery().limit(state.fetchLimit).find();
    } else if (state.lastResult.hasNext()) {
      result = await state.lastResult.next();
    } else {
      state.noMoreData = true;
      if (state.isScoreOnly && state.buffer.length > 0) {
        const pageNumber = state.pages.size + 1;
        const formatted = await Promise.all(state.buffer.splice(0).map((item) => formatCommentForHTML(item)));
        state.pages.set(pageNumber, formatted);
        updateCommentPaginationTotals(state, formatted.length);
      }
      return;
    }

    state.lastResult = result;

    if (state.isScoreOnly) {
      const filteredItems = result.items.filter((item) => !state.selfScCommentIds.has(item._id));
      state.buffer.push(...filteredItems);

      while (state.buffer.length >= state.pageSize) {
        const pageNumber = state.pages.size + 1;
        const rawItems = state.buffer.splice(0, state.pageSize);
        const formatted = await Promise.all(rawItems.map((item) => formatCommentForHTML(item)));
        state.pages.set(pageNumber, formatted);
        updateCommentPaginationTotals(state, formatted.length);
      }

      if (!result.hasNext()) {
        state.noMoreData = true;
        if (state.buffer.length > 0) {
          const pageNumber = state.pages.size + 1;
          const rawItems = state.buffer.splice(0);
          const formatted = await Promise.all(rawItems.map((item) => formatCommentForHTML(item)));
          state.pages.set(pageNumber, formatted);
          updateCommentPaginationTotals(state, formatted.length);
        }
      }
    } else {
      const pageNumber = state.pages.size + 1;
      const formatted = await Promise.all(result.items.map((item) => formatCommentForHTML(item)));
      state.pages.set(pageNumber, formatted);
      updateCommentPaginationTotals(state, formatted.length);

      if (!result.hasNext()) {
        state.noMoreData = true;
      }
    }
  } catch (error) {
    state.noMoreData = true;
    console.error("[璇勮绯荤粺] 鍒嗛〉鍔犺浇璇勮澶辫触:", error);
    throw error;
  }
}

async function ensureCommentPage(state, requestedPage) {
  if (!state) {
    return 1;
  }

  const maxPage = Math.max(1, state.totalPages);
  const targetPage = Math.max(1, Math.min(requestedPage, maxPage));

  while (!state.pages.has(targetPage) && !state.noMoreData) {
    if (state.loadingPromise) {
      await state.loadingPromise;
    } else {
      state.loadingPromise = fetchMoreComments(state)
        .catch((error) => {
          console.error("[璇勮绯荤粺] 鍔犺浇璇勮椤甸潰鏁版嵁澶辫触:", error);
        })
        .finally(() => {
          state.loadingPromise = null;
        });
      await state.loadingPromise;
    }
  }

  if (!state.pages.has(targetPage)) {
    state.pages.set(targetPage, []);
  }

  return targetPage;
}

// 鍙戦€佽瘎璁烘暟鎹?
async function sendCommentsData(requestData) {
  try {
    const { workFilter = "", filterMode = "default", currentPage = 1 } = requestData || {};
    console.log(`[璇勮绯荤粺] 璇锋眰璇勮鏁版嵁: workFilter=${workFilter}, filterMode=${filterMode}, page=${currentPage}`);

    const cacheKey = getCommentCacheKey(workFilter, filterMode);
    let state = commentDataCache.get(cacheKey);

    if (!state) {
      state = await initializeCommentPaginationState(workFilter, filterMode);
      commentDataCache.set(cacheKey, state);
    }

    const targetPage = await ensureCommentPage(state, parseInt(currentPage, 10) || 1);
    const comments = state.pages.get(targetPage) || [];

    $w("#commentSystemPanel").postMessage({
      type: "UPDATE_COMMENTS",
      data: {
        comments,
        workFilter: workFilter || "",
        filterMode,
        currentPage: targetPage,
        totalPages: Math.max(1, state.totalPages),
        totalCount: state.totalCount,
      },
    });

    console.log(`[璇勮绯荤粺] 宸插彂閫?${comments.length} 鏉¤瘎璁烘暟鎹?(page ${targetPage}/${state.totalPages}, total=${state.totalCount})`);
  } catch (error) {
    console.error("[璇勮绯荤粺] 鍙戦€佽瘎璁烘暟鎹け璐?", error);
    $w("#commentSystemPanel").postMessage({
      type: "UPDATE_COMMENTS_ERROR",
      data: {
        message: error.message || "鍔犺浇璇勮鏁版嵁澶辫触锛岃绋嶅悗閲嶈瘯",
      },
    });
  }
}

// 鏍煎紡鍖栬瘎璁烘暟鎹緵HTML浣跨敤
// 銆愪紭鍖栥€戜紭鍏堜娇鐢ㄦ壒閲忕紦瀛橈紝鍑忓皯鏁版嵁搴撴煡璇紝閬垮厤504瓒呮椂
async function formatCommentForHTML(comment) {
  try {
    let formattedComment = {
      commentId: comment._id,
      workNumber: comment.workNumber,
      score: comment.score,
      commentText: comment.comment,
      _owner: comment._owner,
      isReply: !!comment.replyTo,
      replyTo: comment.replyTo,
      showScore: false,
      isAuthorComment: false,
      canDelete: false,
      ratingInfo: "",
      workTitle: "",
      replyCount: 0,
      isSelfScComment: false
    };

    // 銆愪紭鍖栥€戜紭鍏堜粠鎵归噺缂撳瓨鑾峰彇浣滃搧淇℃伅锛岄伩鍏嶉€愪釜鏌ヨ
    let workOwnerId = null;
    let isWorkDQ = false;
    let workTitle = "";

    if (batchDataCache && batchDataCache.workOwnerMap) {
      workOwnerId = batchDataCache.workOwnerMap[comment.workNumber];
      isWorkDQ = batchDataCache.workDQMap ? (batchDataCache.workDQMap[comment.workNumber] === true) : false;
      workTitle = workTitlesCache[comment.workNumber] || "";
    }

    // 濡傛灉缂撳瓨涓病鏈変綔鍝佹爣棰橈紝灏濊瘯浠庡凡鍔犺浇鐨勪綔鍝侀€夐」涓幏鍙?
    if (!workTitle && workOwnerId) {
      // 閬垮厤鏌ヨ鏁版嵁搴擄紝鍙娇鐢ㄧ紦瀛樻暟鎹?
      workTitle = workTitlesCache[comment.workNumber] || "";
    }

    // 璁剧疆浣滃搧鏍囬锛堜紭鍏堜娇鐢ㄧ紦瀛橈紝閬垮厤504瓒呮椂锛?
    formattedComment.workTitle = workTitle ? `#${comment.workNumber} - ${workTitle}` : `#${comment.workNumber}`;
    
    // 鍒ゆ柇鏄惁涓轰綔鑰呰嚜璇?
    if (workOwnerId) {
      formattedComment.isAuthorComment = comment._owner === workOwnerId;
      formattedComment.isSelfScComment = formattedComment.isAuthorComment;
    }

    // 鍒ゆ柇鏄惁娣樻卑
    if (isWorkDQ) {
      formattedComment.commentText = "*璇ヤ綔鍝佸凡娣樻卑*" + formattedComment.commentText;
    }

    // 鍒ゆ柇鏄惁鏄剧ず璇勫垎
    if (!comment.replyTo) {
      const userHasFormalRating = await checkUserHasFormalRating(comment.workNumber);
      formattedComment.showScore = userHasFormalRating && !formattedComment.isAuthorComment;

      // 鑾峰彇璇勫垎淇℃伅
      if (userHasFormalRating && !formattedComment.isAuthorComment) {
        const ratingData = await getRatingData(comment.workNumber);
        if (ratingData.numRatings >= RATING_CONFIG.MIN_RATINGS_FOR_RANKING) {
          const rankingData = await calculateAllWorksRanking();
          const workRanking = rankingData.rankingMap[comment.workNumber];
          if (workRanking) {
            const tier = getTierFromPercentile(workRanking.percentile);
            formattedComment.ratingInfo = `${tier} (${ratingData.numRatings}浜鸿瘎鍒?`;
          }
        } else if (ratingData.numRatings > 0) {
          formattedComment.ratingInfo = `璇勫垎閲忎笉瓒?${ratingData.numRatings}浜鸿瘎鍒?`;
        }
      }

      // 鑾峰彇鍥炲鏁伴噺
      if (!(comment._id in replyCountsCache)) {
        await batchLoadReplyCounts([comment._id]);
      }
      formattedComment.replyCount = replyCountsCache[comment._id] || 0;
    }

    // 鍒ゆ柇鍒犻櫎鏉冮檺
    if (currentUserId && !comment.replyTo) {
      if (formattedComment.isAuthorComment) {
        // Sc璇勮锛氬彧鏈変綔鑰呰嚜宸辫兘鍒犻櫎
        formattedComment.canDelete = currentUserId === comment._owner;
      } else {
        // 鏅€氳瘎璁猴細娴烽€夌粍鎴愬憳鍙互鍒犻櫎
        const isSeaSelectionMember = await checkIsSeaSelectionMember();
        formattedComment.canDelete = isSeaSelectionMember;
      }
    }

    return formattedComment;
  } catch (error) {
    console.error("鏍煎紡鍖栬瘎璁烘暟鎹け璐?", error);
    return {
      commentId: comment._id,
      workNumber: comment.workNumber,
      score: comment.score,
      commentText: comment.comment,
      showScore: false,
      isAuthorComment: false,
      canDelete: false,
      ratingInfo: "",
      workTitle: `#${comment.workNumber}`,
      replyCount: 0
    };
  }
}

// 澶勭悊璇勮鎻愪氦 - 娣诲姞璇︾粏鐨勮繘搴﹀弽棣?
async function handleCommentSubmit(data) {
  try {
    const { workNumber, score, comment } = data;
    console.log(`[璇勮绯荤粺] 鎻愪氦璇勮: 浣滃搧#${workNumber}, 璇勫垎${score}`);

    // 姝ラ1: 楠岃瘉鐢ㄦ埛鐧诲綍鍜屾姤鍚嶇姸鎬?
    sendSubmitProgress("馃攳 楠岃瘉鐢ㄦ埛韬唤...", "validating");
    
    if (!currentUserId) {
      sendSubmitResult(false, "鉂?鐢ㄦ埛鏈櫥褰?);
      return;
    }

    if (!isUserVerified) {
      sendSubmitResult(false, "鉂?鐢ㄦ埛鏈姤鍚?);
      return;
    }

    // 姝ラ2: 楠岃瘉杈撳叆
    sendSubmitProgress("馃攳 楠岃瘉杈撳叆鏁版嵁...", "validating");
    
    if (!workNumber || !score || !comment) {
      sendSubmitResult(false, "鉂?璇峰～鍐欏畬鏁翠俊鎭?);
      return;
    }

    if (score < 100 || score > 1000) {
      sendSubmitResult(false, "鉂?璇勫垎蹇呴』鍦?00-1000涔嬮棿");
      return;
    }

    // 姝ラ3: 妫€鏌ヤ綔鍝佺姸鎬?
    sendSubmitProgress("馃攳 妫€鏌ヤ綔鍝佺姸鎬?..", "validating");
    
    const workResults = await wixData
      .query("enterContest034")
      .eq("sequenceId", workNumber)
      .find();

    if (workResults.items.length === 0) {
      sendSubmitResult(false, "鉂?浣滃搧涓嶅瓨鍦?);
      return;
    }

    const workItem = workResults.items[0];
    const isAuthor = currentUserId === workItem._owner;
    const isWorkDQ = workItem.isDq === true;

    if (isWorkDQ) {
      sendSubmitResult(false, "鉂?浣滃搧宸叉窐姹帮紝鏃犳硶璇勮");
      return;
    }

    // 姝ラ4: 闈炰綔鑰呮鏌ユ槸鍚﹀凡璇勮
    if (!isAuthor) {
      sendSubmitProgress("馃攳 妫€鏌ヨ瘎璁鸿褰?..", "validating");
      
      const existingComment = await wixData
        .query("BOFcomment")
        .eq("workNumber", workNumber)
        .eq("_owner", currentUserId)
        .isEmpty("replyTo")
        .find();

      if (existingComment.items.length > 0) {
        sendSubmitResult(false, "鉂?宸茶瘎璁鸿繃姝や綔鍝?);
        return;
      }
    }

    // 姝ラ5: 鎻掑叆璇勮
    sendSubmitProgress("馃捑 姝ｅ湪淇濆瓨璇勮...", "saving");
    
    let toInsert = {
      workNumber: workNumber,
      score: score,
      comment: comment,
    };

    const insertedComment = await wixData.insert("BOFcomment", toInsert);

    // 姝ラ6: 鏇存柊绉垎
    sendSubmitProgress("鈿欙笍 鏇存柊绉垎...", "updating");
    
    try {
      await updateUserPoints(currentUserId, 1, false, false);
    } catch (error) {
      console.error("鏇存柊绉垎澶辫触:", error);
    }

    // 姝ラ7: 妫€鏌ュ苟鏍囪浠诲姟瀹屾垚
    sendSubmitProgress("鈿欙笍 妫€鏌ヤ换鍔＄姸鎬?..", "updating");
    
    let taskStatusMessage = "";
    try {
      const result = await markTaskCompleted(currentUserId, workNumber);
      
      if (result.taskCompleted) {
        taskStatusMessage = `\n\n馃幆 浠诲姟瀹屾垚锛佽繘搴? ${result.completedCount}/10`;
        
        // 鏇存柊浠诲姟鏁版嵁缂撳瓨
        if (userTaskDataCache) {
          userTaskDataCache.hasCompletedTarget = result.hasCompletedTarget || false;
        }
      } else if (result.alreadyCompleted) {
        taskStatusMessage = "\n\n鉁?姝や换鍔″凡瀹屾垚杩?;
      } else if (result.isColdWork) {
        taskStatusMessage = "\n\n馃敹 鍐烽棬浣滃搧宸茶瘎鍒嗭紙宸插畬鎴愪换鍔＄洰鏍囷級";
      } else if (!result.isInTaskList) {
        taskStatusMessage = "\n\n馃挕 闈炰换鍔′綔鍝侊紙涓嶈鍏ヨ繘搴︼級";
      }
    } catch (error) {
      console.error("鏍囪浠诲姟瀹屾垚澶辫触:", error);
    }

    // 姝ラ8: 澧為噺鐑洿鏂?
    sendSubmitProgress("馃攧 鏇存柊椤甸潰鏁版嵁...", "updating");
    await incrementalUpdateAfterComment(workNumber, score, comment, isAuthor);

    // 姝ラ9: 鍙戦€佹垚鍔熺粨鏋滃苟绔嬪嵆鍒锋柊璇勮鍒楄〃
    const successMessage = isAuthor 
      ? `鉁?鑷瘎鎻愪氦鎴愬姛锛乗n\n鉁嶏笍 鑷瘎涓嶈鍏ヨ瘎鍒嗙粺璁?{taskStatusMessage}`
      : `鉁?璇勮鎻愪氦鎴愬姛锛乗n\n馃搳 璇勫垎: ${score}${taskStatusMessage}`;
    
    sendSubmitResult(true, successMessage);

    // 绔嬪嵆鍒锋柊璇勮鍒楄〃锛堥噸瑕侊細纭繚鏂拌瘎璁虹珛鍗虫樉绀猴級
    resetCommentDataCache();
    setTimeout(() => {
      sendCommentsData({
        workFilter: '',
        filterMode: 'default',
        currentPage: 1
      });
    }, 500); // 500ms寤惰繜纭繚鏁版嵁搴撳凡瀹屾垚鍐欏叆

    console.log(`[璇勮绯荤粺] 璇勮鎻愪氦鎴愬姛`);
  } catch (error) {
    console.error("[璇勮绯荤粺] 璇勮鎻愪氦澶辫触:", error);
    sendSubmitResult(false, "鉂?鎻愪氦澶辫触锛岃閲嶈瘯\n\n" + (error.message || '鏈煡閿欒'));
  }
}

// 鍙戦€佹彁浜ょ粨鏋?
function sendSubmitResult(success, message) {
  $w("#commentSystemPanel").postMessage({
    type: 'SUBMIT_RESULT',
    data: {
      success: success,
      message: message
    }
  });
}

// 澶勭悊浣滃搧缂栧彿鍙樺寲 - 鏄剧ず璇︾粏鐨勪綔鍝佺姸鎬佸苟鍙戦€佸畬鏁寸殑UI鐘舵€?
async function handleWorkNumberChange(workNumber) {
  console.log(`[璇勮绯荤粺] 浣滃搧缂栧彿鍙樺寲: ${workNumber}`);
  
  try {
    // 鑾峰彇浣滃搧淇℃伅
    const workResults = await wixData
      .query("enterContest034")
      .eq("sequenceId", workNumber)
      .find();

    if (workResults.items.length === 0) {
      sendWorkStatusUpdate('', '');
      sendWorkSelectionState({
        isWorkDQ: false,
        isAuthor: false,
        isAlreadyCommented: false,
        existingComment: null
      });
      return;
    }

    const workItem = workResults.items[0];
    const isAuthor = currentUserId === workItem._owner;
    const isWorkDQ = workItem.isDq === true;

    // 浼樺厛绾?: 娣樻卑浣滃搧
    if (isWorkDQ) {
      sendWorkStatusUpdate('鈿狅笍 璇ヤ綔鍝佸凡娣樻卑锛屾棤娉曡瘎璁?, 'dq');
      sendWorkSelectionState({
        isWorkDQ: true,
        isAuthor: false,
        isAlreadyCommented: false,
        existingComment: null
      });
      return;
    }

    // 浼樺厛绾?: 浣滆€呰嚜璇?
    if (isAuthor) {
      sendWorkStatusUpdate('鉁嶏笍 杩欐槸鎮ㄧ殑浣滃搧锛屽彲浠ヨ繘琛岃嚜璇勶紙Sc璇勮锛塡n馃挕 鑷瘎涓嶈鍏ヨ瘎鍒嗙粺璁★紝鍙娆℃彁浜?, 'author');
      sendWorkSelectionState({
        isWorkDQ: false,
        isAuthor: true,
        isAlreadyCommented: false,
        existingComment: null
      });
      return;
    }

    // 浼樺厛绾?: 妫€鏌ユ槸鍚﹀凡璇勮
    const existingCommentResults = await wixData
      .query("BOFcomment")
      .eq("workNumber", workNumber)
      .eq("_owner", currentUserId)
      .isEmpty("replyTo")
      .find();

    if (existingCommentResults.items.length > 0) {
      const existingComment = existingCommentResults.items[0];
      sendWorkStatusUpdate('鉁?鎮ㄥ凡璇勮杩囨浣滃搧', 'completed');
      sendWorkSelectionState({
        isWorkDQ: false,
        isAuthor: false,
        isAlreadyCommented: true,
        existingComment: {
          comment: existingComment.comment,
          score: existingComment.score
        }
      });
      return;
    }

    // 浼樺厛绾?: 鏈瘎璁猴紝妫€鏌ヤ换鍔＄姸鎬?
    if (currentUserId && isUserVerified) {
      try {
        const taskCheck = await checkIfWorkInTaskList(currentUserId, workNumber);
        const hasCompletedTarget = userTaskDataCache ? (userTaskDataCache.hasCompletedTarget || false) : false;
        
        if (taskCheck.inTaskList && !taskCheck.alreadyCompleted) {
          if (hasCompletedTarget) {
            // 宸插畬鎴愮洰鏍囷紝鏄剧ず涓哄喎闂ㄤ綔鍝?
            sendWorkStatusUpdate('馃敹 杩欐槸涓€涓喎闂ㄤ綔鍝乗n馃挕 鎮ㄥ凡瀹屾垚浠诲姟鐩爣锛岃瘎璁烘浣滃搧涓嶈鍏ヤ换鍔¤繘搴?, 'coldWork');
          } else {
            // 鏈畬鎴愮洰鏍囷紝鏄剧ず涓轰换鍔′綔鍝?
            sendWorkStatusUpdate('馃幆 杩欐槸鎮ㄧ殑浠诲姟浣滃搧锛乗n馃挕 瀹屾垚姝よ瘎璁哄皢璁″叆浠诲姟杩涘害', 'task');
          }
        } else if (taskCheck.alreadyCompleted) {
          sendWorkStatusUpdate('鉁?姝や换鍔″凡瀹屾垚', 'completedTask');
        } else {
          sendWorkStatusUpdate('', '');
        }
      } catch (error) {
        console.error("妫€鏌ヤ换鍔＄姸鎬佸け璐?", error);
        sendWorkStatusUpdate('', '');
      }
    }

    // 姝ｅ父鏈瘎璁虹姸鎬?
    sendWorkSelectionState({
      isWorkDQ: false,
      isAuthor: false,
      isAlreadyCommented: false,
      existingComment: null
    });

  } catch (error) {
    console.error("[璇勮绯荤粺] 鑾峰彇浣滃搧鐘舵€佸け璐?", error);
    sendWorkStatusUpdate('', '');
    sendWorkSelectionState({
      isWorkDQ: false,
      isAuthor: false,
      isAlreadyCommented: false,
      existingComment: null
    });
  }
}

// 鍙戦€佷綔鍝佺姸鎬佹洿鏂板埌HTML鍏冧欢
function sendWorkStatusUpdate(message, statusType) {
  $w("#commentSystemPanel").postMessage({
    type: 'WORK_STATUS_UPDATE',
    data: {
      message: message,
      statusType: statusType
    }
  });
}

// 鍙戦€佹彁浜よ繘搴﹀埌HTML鍏冧欢
function sendSubmitProgress(message, stage) {
  $w("#commentSystemPanel").postMessage({
    type: 'SUBMIT_PROGRESS',
    data: {
      message: message,
      stage: stage
    }
  });
}

// 鍙戦€佷綔鍝侀€夋嫨鐘舵€佸埌HTML鍏冧欢锛堟帶鍒惰緭鍏ユ鐘舵€侊級
function sendWorkSelectionState(state) {
  try {
    $w("#commentSystemPanel").postMessage({
      type: 'WORK_SELECTION_STATE',
      data: state
    });
  } catch (error) {
    console.error("[璇勮绯荤粺] 鍙戦€佷綔鍝侀€夋嫨鐘舵€佸け璐?", error);
  }
}

// 澶勭悊鏌ョ湅鍥炲璇锋眰 - 鏀寔涓昏瘎璁哄拰妤间腑妤煎洖澶?
async function handleViewReplies(data) {
  try {
    const { commentId, workNumber, originalComment, isReply, replyTo } = data;
    
    // 濡傛灉鏄ゼ涓ゼ鍥炲锛岄渶瑕佸厛鏌ヨ鐖惰瘎璁烘暟鎹?
    if (isReply && replyTo) {
      console.log(`[璇勮绯荤粺] 妤间腑妤煎洖澶嶏紝鏌ヨ鐖惰瘎璁? ${replyTo}`);
      
      const parentCommentResult = await wixData
        .query("BOFcomment")
        .eq("_id", replyTo)
        .find();
      
      if (parentCommentResult.items.length > 0) {
        const parentComment = parentCommentResult.items[0];
        await showCommentReplies(
          parentComment._id,
          parentComment.workNumber,
          parentComment.comment
        );
      } else {
        console.error("[璇勮绯荤粺] 鏈壘鍒扮埗璇勮");
      }
    } else {
      // 涓昏瘎璁猴細鐩存帴鏄剧ず鍥炲
      await showCommentReplies(commentId, workNumber, originalComment);
    }
  } catch (error) {
    console.error("[璇勮绯荤粺] 鏌ョ湅鍥炲澶辫触:", error);
  }
}

// 澶勭悊璺宠浆鍒颁綔鍝?- 璁剧疆浣滃搧鎼滅储妗嗐€佸埛鏂颁綔鍝佸垪琛ㄥ苟婊氬姩鍒癮nchor2浣嶇疆
async function handleGotoWork(workNumber) {
  try {
    console.log(`[璇勮绯荤粺] 璺宠浆鍒颁綔鍝?#${workNumber}`);
    
    // 鑾峰彇浣滃搧鏍囬
    const workResults = await wixData
      .query("enterContest034")
      .eq("sequenceId", workNumber)
      .find();
    
    if (workResults.items.length > 0) {
      const workTitle = workResults.items[0].firstName;
      
      // 鏇存柊浣滃搧鎼滅储妗嗭紙input1锛夌殑鍊间负浣滃搧鍚嶇О
      // 杩欎細瑙﹀彂浣滃搧鍒楄〃鐨勬悳绱㈠拰鍒锋柊
      if ($w("#input1")) {
        $w("#input1").value = workTitle;
        
        // 鍒锋柊浣滃搧鍒楄〃锛坮epeater2锛?
        await refreshRepeaters();
        
        // 婊氬姩鍒?anchor2 浣嶇疆
        try {
          if ($w("#anchor2")) {
            await $w("#anchor2").scrollTo();
            console.log(`[璇勮绯荤粺] 宸叉粴鍔ㄥ埌 #anchor2`);
          }
        } catch (scrollError) {
          console.error("[璇勮绯荤粺] 婊氬姩鍒癮nchor2澶辫触:", scrollError);
        }
        
        console.log(`[璇勮绯荤粺] 宸茶烦杞埌浣滃搧: #${workNumber} - ${workTitle}`);
      }
    }
  } catch (error) {
    console.error("[璇勮绯荤粺] 璺宠浆鍒颁綔鍝佸け璐?", error);
  }
}

