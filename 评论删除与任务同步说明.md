# 评论删除与任务同步功能说明

## 功能概述

当审核组删除用户的评论时，系统会自动同步清除该用户在任务系统中的相应完成状态，确保数据一致性。

## 实现逻辑

### 1. 核心函数

#### `unmarkTaskCompleted()` - 取消任务完成状态
**位置**: `src/backend/ratingTaskManager.jsw`

**功能**: 从用户的任务完成列表中移除指定作品，并更新任务完成计数。

**参数**:
- `userId` (string): 用户ID
- `workNumber` (number): 作品序号

**返回值**:
```javascript
{
  success: true/false,
  wasInCompletedList: true/false,  // 作品是否在已完成列表中
  newCompletedCount: number,        // 新的完成数量
  message: string                   // 操作结果描述
}
```

**处理流程**:
1. 获取用户的任务记录
2. 检查作品是否在已完成列表中
3. 如果在，从列表中移除该作品
4. 更新 `totalCompleted` 计数
5. 保存到数据库

### 2. 集成到删除评论功能

#### `deleteComment()` - 删除评论（已增强）
**位置**: `src/backend/auditorManagement.jsw`

**新增逻辑**:
```javascript
// 删除评论后，同步清除任务状态
try {
    // 1. 查询作品信息，判断是否为作者自评
    const workResult = await wixData
        .query(COLLECTIONS.ENTER_CONTEST_034)
        .eq('sequenceId', workNumber)
        .find();
    
    if (workResult.items.length > 0) {
        const workOwner = workResult.items[0]._owner;
        const isAuthorComment = commentOwnerId === workOwner;
        
        // 2. 只有非作者自评的正式评论才需要清除任务状态
        if (!isAuthorComment && !isSelfScComment) {
            const unmarkResult = await unmarkTaskCompleted(commentOwnerId, workNumber);
            // 记录日志...
        }
    }
} catch (taskError) {
    // 任务状态清除失败不影响删除操作本身，只记录日志
    console.error("[删除评论] 清除任务状态失败（不影响删除）:", taskError);
}
```

## 处理场景

### ✅ 会清除任务状态的场景

1. **审核组删除普通用户的正式评论**
   - 评论所有者 ≠ 作品所有者
   - 非自主删除（`isSelfScComment = false`）
   - 该评论对应的作品在用户的任务完成列表中

### ❌ 不会清除任务状态的场景

1. **作者删除自己的自评（Sc评论）**
   - `isSelfScComment = true`
   - 自评不计入任务进度

2. **删除作者自评**
   - `commentOwnerId === workOwner`
   - 自评不计入任务进度

3. **作品不在任务完成列表中**
   - 这是用户的自主评论，不是任务评论
   - 系统会记录但不影响任务进度

## 日志输出

### 成功清除任务状态
```
[删除评论] 尝试清除用户 {userId} 对作品 #{workNumber} 的任务完成状态
[取消] 当前已完成: [1, 5, 10, 15, 20], 总数: 5
[取消] 更新后已完成: [1, 5, 10, 15], 总数: 4
[取消] 数据库已更新
[删除评论] ✓ 任务完成状态已清除（新完成数: 4）
```

### 作品不在完成列表中
```
[删除评论] 尝试清除用户 {userId} 对作品 #{workNumber} 的任务完成状态
[取消] 作品 #{workNumber} 不在已完成列表中，无需处理
[删除评论] 任务状态处理结果: 作品不在已完成列表中
```

### 清除失败（不影响删除）
```
[删除评论] 清除任务状态失败（不影响删除）: {error}
```

## 数据一致性保证

1. **原子性**: 评论删除和任务状态更新分别在独立的事务中执行
2. **容错性**: 任务状态更新失败不会阻止评论删除
3. **日志记录**: 所有操作都有详细的控制台日志，便于调试和审计

## 影响的数据集

### 主要影响
- **UserRatingTasks**: 更新用户的任务完成列表和计数
  - `completedTasks`: 数组，移除被删除评论对应的作品编号
  - `totalCompleted`: 数字，递减 1

### 间接影响
- **BOFcomment**: 评论被删除
- **deleteInfor**: 如果不是自主删除，会记录删除信息

## 使用示例

### 审核组删除评论流程

1. **用户在前端触发删除**
   ```javascript
   // src/pages/Stage_主会场.vz6uu.js
   await handleDeleteComment(itemData, false);
   ```

2. **后端执行删除并同步任务**
   ```javascript
   // src/backend/auditorManagement.jsw
   const deleteResult = await deleteComment(
       commentId,
       auditorId,
       deleteReason,
       false  // 非自主删除
   );
   ```

3. **自动调用任务同步**
   ```javascript
   // 内部自动执行
   await unmarkTaskCompleted(commentOwnerId, workNumber);
   ```

4. **结果反馈**
   - 评论已删除
   - 任务状态已同步
   - 删除记录已保存（如适用）
   - 邮件通知已发送（如适用）

## 测试建议

### 测试场景 1: 删除任务评论
1. 用户 A 完成任务评论作品 #100
2. 审核组删除该评论
3. 验证：用户 A 的 `completedTasks` 不再包含 100
4. 验证：`totalCompleted` 减少 1

### 测试场景 2: 删除非任务评论
1. 用户 B 自主评论作品 #200（非任务作品）
2. 审核组删除该评论
3. 验证：任务状态不受影响

### 测试场景 3: 删除作者自评
1. 作者 C 自评自己的作品 #300
2. 作者 C 删除自己的自评
3. 验证：不创建删除记录
4. 验证：任务状态不受影响

### 测试场景 4: 容错测试
1. 删除评论时，任务系统出现异常
2. 验证：评论仍然被删除
3. 验证：错误被记录到日志

## 注意事项

⚠️ **重要提示**:

1. **只影响任务评论**: 系统只会清除通过任务系统完成的评论的任务状态
2. **不影响自主评论**: 用户的自主评论（非任务评论）删除后不会影响任务进度
3. **作者自评特殊处理**: 作者自评从不计入任务，删除时也不会影响任务状态
4. **容错设计**: 任务状态更新失败不会阻止评论删除，确保核心功能可用

## 技术要点

### 依赖关系
```
auditorManagement.jsw
  ↓ 导入
ratingTaskManager.jsw
  ↓ 调用
unmarkTaskCompleted()
  ↓ 更新
UserRatingTasks 数据集
```

### 数据流
```
删除评论请求
  ↓
deleteComment()
  ↓
获取评论信息（userId, workNumber）
  ↓
判断评论类型（正式评论 vs 自评）
  ↓
如果是正式评论
  ↓
unmarkTaskCompleted(userId, workNumber)
  ↓
从 completedTasks 移除 workNumber
  ↓
更新 totalCompleted
  ↓
保存到数据库
```

## 相关文件

- **核心实现**:
  - `src/backend/ratingTaskManager.jsw` - 任务管理核心逻辑
  - `src/backend/auditorManagement.jsw` - 评论删除功能
  
- **前端调用**:
  - `src/pages/Stage_主会场.vz6uu.js` - 主会场页面，包含删除评论的UI交互
  - `src/pages/DeleteConfirmation.wo8kw.js` - 删除确认弹窗

- **数据集**:
  - `UserRatingTasks` - 用户任务数据
  - `BOFcomment` - 评论数据
  - `deleteInfor` - 删除记录数据
  - `enterContest034` - 作品数据

## 更新日志

**2025-01-20**
- ✅ 新增 `unmarkTaskCompleted()` 函数用于取消任务完成状态
- ✅ 增强 `deleteComment()` 函数，集成任务状态同步逻辑
- ✅ 添加详细的日志记录和错误处理
- ✅ 实现作者自评和正式评论的区分处理

