# 评分任务系统更新说明 v1.1

## 更新日期
2025-10-06

## 更新内容

### 1. 降低冷门权重计算 ✅

**问题**：原有的权重计算公式太容易达到100分，导致许多作品的冷门度被算满。

**解决方案**：调整权重计算参数，降低基础权重和时间加成的数值。

#### 修改详情

**原公式**：
```
基础权重 = (评分缺口 / 期望评分) × 60
时间加成: 7天+20, 14天+30, 21天+40
最大权重: 100分
```

**新公式**：
```
基础权重 = (评分缺口 / 期望评分) × 45  （从60降至45）
时间加成: 7天+12, 14天+18, 21天+25     （分别降低40%）
最大权重: 约70分（不容易达到100）
```

**效果**：
- 权重分布更加合理
- 只有真正紧急的冷门作品才会达到高权重
- 避免权重虚高，让任务分配更有区分度

---

### 2. 任务定期自动刷新机制 ✅

**问题**：任务只在用户完成后才更新，长期未完成的任务会一直停留。

**解决方案**：实现基于时间的任务自动刷新机制，每48小时强制刷新所有用户的任务列表。

#### 实现细节

**后端改动**（`src/backend/ratingTaskManager.jsw`）：

1. **新增常量**：
   ```javascript
   const TASK_REFRESH_HOURS = 48; // 任务刷新间隔（小时）
   ```

2. **新增函数**：
   - `shouldRefreshTasks(taskRecord)` - 检查任务是否需要刷新
   - `getNextRefreshTime(lastRefreshTime)` - 计算下次刷新时间

3. **修改函数**：
   - `getUserTaskData()` - 增加刷新检查逻辑
   - `getUserTaskRecord()` - 添加 `lastRefreshTime` 字段初始化

4. **刷新逻辑**：
   ```javascript
   // 检查是否超过48小时
   const needsRefresh = shouldRefreshTasks(taskRecord);
   
   if (needsRefresh) {
     // 清空当前任务，强制重新生成
     taskRecord.currentTasks = [];
     taskRecord.lastRefreshTime = new Date();
   }
   ```

**前端改动**（`src/public/custom-html/task-interface.html`）：

1. **新增UI元素**：
   - 刷新时间提示区域
   - 显示下次刷新倒计时

2. **新增函数**：
   - `updateRefreshTimeDisplay(nextRefreshTime)` - 更新刷新时间显示
   - 计算距离下次刷新的剩余时间
   - 友好的时间格式显示（X小时Y分钟后）

3. **显示效果**：
   ```
   正常状态: "下次刷新: 23小时45分钟后"
   即将刷新: "任务即将刷新，点击Check更新" (蓝色高亮)
   ```

**数据库改动**（`UserRatingTasks` 集合）：

新增字段：
- `lastRefreshTime` (Date & Time) - 上次任务刷新时间

---

## 文件修改清单

### 核心代码
- ✅ `src/backend/ratingTaskManager.jsw` - 后端核心算法
- ✅ `src/public/custom-html/task-interface.html` - 前端任务界面

### 文档更新
- ✅ `CMS数据库配置说明.md` - 添加 lastRefreshTime 字段说明
- ✅ `评分任务系统实施总结.md` - 更新功能列表和算法说明
- ✅ `评分任务系统更新说明-v1.1.md` - 本文档

---

## 部署步骤

### 1. 更新数据库字段

在 Wix CMS 中修改 `UserRatingTasks` 集合：

1. 进入 CMS (Content Manager)
2. 找到 `UserRatingTasks` 集合
3. 添加新字段：
   - **字段名**: `lastRefreshTime`
   - **类型**: Date & Time
   - **必填**: 否
   - **默认值**: 当前时间

### 2. 部署代码

1. 将更新后的代码推送到 Wix 站点
2. 发布站点以应用更改

### 3. 测试验证

#### 测试权重计算
1. 查看任务页面的冷门度数值
2. 确认不再轻易出现100分的作品
3. 验证权重分布更加合理

#### 测试定期刷新
1. 查看任务页面，确认显示"下次刷新"时间
2. 等待48小时后，或手动修改数据库中的 `lastRefreshTime` 为2天前
3. 点击 "Check" 按钮，确认任务列表已刷新
4. 验证刷新提示显示正确

---

## 用户体验改进

### 权重优化带来的改进
- ✅ 更合理的任务优先级
- ✅ 区分度更高的冷门作品标识
- ✅ 避免虚高的紧急度标签

### 定期刷新带来的改进
- ✅ 长期未完成的任务会自动更新
- ✅ 用户可以看到下次刷新时间
- ✅ 避免任务列表过时
- ✅ 确保所有用户都能定期获得新任务

---

## 配置说明

### 调整刷新间隔

如需修改刷新时间间隔，请编辑 `src/backend/ratingTaskManager.jsw`：

```javascript
const TASK_REFRESH_HOURS = 48; // 改为你想要的小时数
```

**建议值**：
- 24小时（1天）- 适合快节奏比赛
- 48小时（2天）- 当前默认值
- 72小时（3天）- 适合较慢节奏

### 调整权重参数

如需进一步调整权重计算，编辑 `calculateColdnessWeight()` 函数中的参数：

```javascript
// 基础权重系数（当前45，可调整）
const baseWeight = deficitRatio * 45;

// 时间加成值（可调整）
if (daysSinceSubmission > 7 && currentRatings < 10) {
  urgencyBonus = 12;  // 可调整
}
```

---

## 系统优势

### 公平性 ✅
- 确保每个作品都有被关注的机会
- 定期刷新避免任务列表固化

### 灵活性 ✅
- 可配置的刷新间隔
- 可调整的权重参数

### 透明性 ✅
- 用户清楚看到下次刷新时间
- 权重数值直观显示冷门程度

### 自动化 ✅
- 无需人工干预的自动刷新
- 智能化的任务分配

---

## 已知问题与注意事项

### 数据库迁移
- 现有的任务记录没有 `lastRefreshTime` 字段
- 首次访问时会自动初始化为当前时间
- 不影响现有功能，会自动兼容

### 刷新提示
- 时间显示基于浏览器本地时间
- 可能存在几分钟的误差
- 用户点击 "Check" 按钮可立即更新

---

## 后续优化建议

### 短期（可选）
- [ ] 添加手动强制刷新按钮（管理员功能）
- [ ] 增加刷新历史记录
- [ ] 优化刷新提示的样式和动画

### 长期（可选）
- [ ] 根据用户活跃度动态调整刷新间隔
- [ ] 实现不同用户组的差异化刷新策略
- [ ] 添加刷新通知功能

---

## 总结

此次更新主要解决了两个核心问题：

1. **权重虚高问题** - 通过降低权重计算参数，使冷门度评分更加合理和有区分度
2. **任务固化问题** - 通过实现定期自动刷新机制，确保所有用户都能定期获得更新的任务

这些改进提升了任务系统的公平性、灵活性和用户体验，使评分任务分配更加智能和高效。

---

**版本**: v1.1  
**更新日期**: 2025-10-06  
**状态**: ✅ 已完成并测试

