# è¯„åˆ†ä»»åŠ¡ç³»ç»Ÿå®æ–½æ–¹æ¡ˆ - ç®€åŒ–ç‰ˆ

## æ ¸å¿ƒæœºåˆ¶ç®€åŒ–è¯´æ˜

### å…³é”®ç®€åŒ–ç‚¹

1. **ä»»åŠ¡åˆ†é…ä¸ç”¨æˆ·æäº¤æ— å…³**ï¼šç”¨æˆ·æ— è®ºæ˜¯å¦æäº¤ä½œå“ï¼Œåªè¦æ˜¯å‚èµ›ç”¨æˆ·éƒ½ä¼šæ”¶åˆ°ä»»åŠ¡æ¨é€
2. **å•ä»»åŠ¡æ¨é€æœºåˆ¶**ï¼šæ¯æ¬¡åªæ¨é€ä¸€ä¸ªä»»åŠ¡ï¼Œå®Œæˆåæ¨é€ä¸‹ä¸€ä¸ª
3. **å†·é—¨æƒé‡å¯¼å‘**ï¼šä»»åŠ¡åˆ†é…å¼ºå…³è”ä½œå“çš„"å†·é—¨ç¨‹åº¦"
4. **å®æ—¶åŠ¨æ€è°ƒæ•´**ï¼šåŸºäºä½œå“å½“å‰è¯„åˆ†æ•°é‡å®æ—¶è®¡ç®—æƒé‡

---

## åç«¯ç®—æ³•è®¾è®¡

### 1. æ•°æ®ç»“æ„è®¾è®¡

#### ç”¨æˆ·ä»»åŠ¡è¡¨ï¼ˆUserRatingTasksï¼‰
```javascript
{
  _id: "ä»»åŠ¡ID",
  userId: "ç”¨æˆ·ID",
  currentTask: {
    workNumber: "ä½œå“åºå·",
    assignedDate: "åˆ†é…æ—¶é—´",
    status: "pending|completed"
  },
  completedTasks: ["å·²å®Œæˆçš„ä½œå“åºå·æ•°ç»„"],
  totalCompleted: "å®Œæˆæ€»æ•°ï¼ˆç›®æ ‡20ï¼‰"
}
```

#### ä½œå“å†·é—¨æƒé‡è¡¨ï¼ˆWorkColdnessWeightï¼‰
```javascript
{
  workNumber: "ä½œå“åºå·",
  submissionDate: "æäº¤æ—¥æœŸ",
  currentRatingCount: "å½“å‰è¯„åˆ†æ•°",
  expectedRatingCount: "æœŸæœ›è¯„åˆ†æ•°",
  coldnessWeight: "å†·é—¨æƒé‡å€¼ï¼ˆ0-100ï¼‰",
  lastUpdated: "æœ€åæ›´æ–°æ—¶é—´"
}
```

### 2. å†·é—¨æƒé‡è®¡ç®—ç®—æ³•

```javascript
/**
 * è®¡ç®—ä½œå“çš„å†·é—¨æƒé‡
 * æƒé‡èŒƒå›´ï¼š0-100ï¼Œè¶Šé«˜è¶Šå†·é—¨ï¼Œè¶Šä¼˜å…ˆæ¨é€
 */
function calculateColdnessWeight(work) {
  const daysSinceSubmission = getDaysSinceSubmission(work);
  const currentRatings = work.currentRatingCount || 0;
  
  // æœŸæœ›è¯„åˆ†æ•°ï¼šåŸºäºæ—¶é—´çš„ç®€å•çº¿æ€§æ¨¡å‹
  let expectedRatings = 0;
  if (daysSinceSubmission <= 7) {
    expectedRatings = Math.floor(daysSinceSubmission * 1.43); // 7å¤©è¾¾åˆ°10ä¸ª
  } else if (daysSinceSubmission <= 30) {
    expectedRatings = 10 + Math.floor((daysSinceSubmission - 7) * 0.43); // 30å¤©è¾¾åˆ°20ä¸ª
  } else {
    expectedRatings = 20;
  }
  
  // è®¡ç®—è¯„åˆ†ç¼ºå£
  const deficit = Math.max(0, expectedRatings - currentRatings);
  
  // è®¡ç®—å†·é—¨æƒé‡
  if (currentRatings >= 20) {
    return 0; // å·²è¾¾æ ‡ï¼Œæƒé‡ä¸º0
  }
  
  // æƒé‡è®¡ç®—ï¼šç¼ºå£è¶Šå¤§ï¼Œæƒé‡è¶Šé«˜
  const deficitWeight = (deficit / expectedRatings) * 60; // æœ€å¤§60åˆ†
  
  // æ—¶é—´ç´§è¿«åº¦ï¼šè¶…è¿‡7å¤©ä¸”è¯„åˆ†ä¸è¶³ï¼Œé¢å¤–åŠ æƒ
  let urgencyBonus = 0;
  if (daysSinceSubmission > 7 && currentRatings < 10) {
    urgencyBonus = 20;
  }
  if (daysSinceSubmission > 14 && currentRatings < 15) {
    urgencyBonus = 30;
  }
  if (daysSinceSubmission > 21 && currentRatings < 18) {
    urgencyBonus = 40;
  }
  
  const totalWeight = Math.min(100, deficitWeight + urgencyBonus);
  
  return Math.round(totalWeight);
}
```

### 3. ä»»åŠ¡æ¨é€æ ¸å¿ƒç®—æ³•

```javascript
/**
 * ä¸ºç”¨æˆ·ç”Ÿæˆä¸‹ä¸€ä¸ªä»»åŠ¡
 * @param {string} userId - ç”¨æˆ·ID
 * @returns {Object} æ–°ä»»åŠ¡ä¿¡æ¯
 */
async function assignNextTask(userId) {
  // 1. è·å–ç”¨æˆ·ä»»åŠ¡è®°å½•
  const userTask = await getUserTaskRecord(userId);
  
  // 2. è·å–ç”¨æˆ·å·²è¯„åˆ†ä½œå“åˆ—è¡¨
  const completedWorks = userTask.completedTasks || [];
  
  // 3. è·å–ç”¨æˆ·è‡ªå·±çš„ä½œå“ï¼ˆæ’é™¤ï¼‰
  const userOwnWork = await getUserOwnWork(userId);
  
  // 4. è·å–æ‰€æœ‰æ´»è·ƒä½œå“å¹¶è®¡ç®—æƒé‡
  const allWorks = await wixData
    .query("enterContest034")
    .ne("isDq", true) // æ’é™¤æ·˜æ±°ä½œå“
    .find();
  
  // 5. è®¡ç®—æ¯ä¸ªä½œå“çš„å†·é—¨æƒé‡
  const candidateWorks = [];
  
  for (const work of allWorks.items) {
    // æ’é™¤å·²è¯„åˆ†å’Œè‡ªå·±çš„ä½œå“
    if (completedWorks.includes(work.sequenceId) || 
        work.sequenceId === userOwnWork) {
      continue;
    }
    
    // è®¡ç®—æƒé‡
    const coldnessWeight = calculateColdnessWeight(work);
    
    // åªè€ƒè™‘æœªè¾¾æ ‡çš„ä½œå“
    if (coldnessWeight > 0) {
      candidateWorks.push({
        workNumber: work.sequenceId,
        weight: coldnessWeight,
        currentRatings: work.currentRatingCount || 0
      });
    }
  }
  
  // 6. æ²¡æœ‰å€™é€‰ä½œå“ï¼ˆç”¨æˆ·å·²å®Œæˆæ‰€æœ‰ä»»åŠ¡æˆ–æ‰€æœ‰ä½œå“å·²è¾¾æ ‡ï¼‰
  if (candidateWorks.length === 0) {
    return null;
  }
  
  // 7. æŒ‰æƒé‡æ’åºï¼Œé€‰æ‹©æƒé‡æœ€é«˜çš„ä½œå“
  candidateWorks.sort((a, b) => b.weight - a.weight);
  
  // 8. ä»å‰5ä¸ªé«˜æƒé‡ä½œå“ä¸­éšæœºé€‰æ‹©ï¼ˆé¿å…æ‰€æœ‰äººéƒ½æ¨é€åŒä¸€ä¸ªï¼‰
  const topCandidates = candidateWorks.slice(0, Math.min(5, candidateWorks.length));
  const selectedWork = topCandidates[Math.floor(Math.random() * topCandidates.length)];
  
  // 9. åˆ›å»ºæ–°ä»»åŠ¡
  const newTask = {
    workNumber: selectedWork.workNumber,
    assignedDate: new Date(),
    status: "pending"
  };
  
  // 10. æ›´æ–°ç”¨æˆ·ä»»åŠ¡è®°å½•
  await updateUserTaskRecord(userId, newTask);
  
  return {
    workNumber: selectedWork.workNumber,
    weight: selectedWork.weight,
    currentRatings: selectedWork.currentRatings
  };
}
```

### 4. ä»»åŠ¡å®Œæˆå¤„ç†

```javascript
/**
 * å¤„ç†ç”¨æˆ·å®Œæˆè¯„åˆ†ä»»åŠ¡
 * @param {string} userId - ç”¨æˆ·ID
 * @param {number} workNumber - ä½œå“åºå·
 */
async function completeTask(userId, workNumber) {
  try {
    // 1. è·å–ç”¨æˆ·ä»»åŠ¡è®°å½•
    const taskRecord = await getUserTaskRecord(userId);
    
    // 2. éªŒè¯ä»»åŠ¡æ˜¯å¦åŒ¹é…
    if (taskRecord.currentTask.workNumber !== workNumber) {
      console.warn(`ä»»åŠ¡ä¸åŒ¹é…ï¼šæœŸæœ›${taskRecord.currentTask.workNumber}ï¼Œå®é™…${workNumber}`);
      // ä»ç„¶è®°å½•ä¸ºå·²å®Œæˆ
    }
    
    // 3. æ›´æ–°å®Œæˆè®°å½•
    if (!taskRecord.completedTasks.includes(workNumber)) {
      taskRecord.completedTasks.push(workNumber);
      taskRecord.totalCompleted = taskRecord.completedTasks.length;
    }
    
    // 4. æ ‡è®°å½“å‰ä»»åŠ¡ä¸ºå®Œæˆ
    taskRecord.currentTask.status = "completed";
    
    // 5. ä¿å­˜è®°å½•
    await wixData.update("UserRatingTasks", taskRecord);
    
    // 6. æ›´æ–°ä½œå“è¯„åˆ†ç»Ÿè®¡ï¼ˆç”¨äºæƒé‡è®¡ç®—ï¼‰
    await updateWorkRatingCount(workNumber);
    
    // 7. è‡ªåŠ¨åˆ†é…ä¸‹ä¸€ä¸ªä»»åŠ¡
    const nextTask = await assignNextTask(userId);
    
    return {
      success: true,
      completedCount: taskRecord.totalCompleted,
      nextTask: nextTask
    };
    
  } catch (error) {
    console.error("å®Œæˆä»»åŠ¡å¤±è´¥:", error);
    throw error;
  }
}
```

### 5. è¾…åŠ©å‡½æ•°

```javascript
/**
 * è·å–ç”¨æˆ·ä»»åŠ¡è®°å½•
 */
async function getUserTaskRecord(userId) {
  const results = await wixData
    .query("UserRatingTasks")
    .eq("userId", userId)
    .find();
  
  if (results.items.length === 0) {
    // åˆ›å»ºæ–°è®°å½•
    const newRecord = {
      userId: userId,
      currentTask: null,
      completedTasks: [],
      totalCompleted: 0
    };
    
    const inserted = await wixData.insert("UserRatingTasks", newRecord);
    return inserted;
  }
  
  return results.items[0];
}

/**
 * æ›´æ–°ç”¨æˆ·ä»»åŠ¡è®°å½•
 */
async function updateUserTaskRecord(userId, newTask) {
  const record = await getUserTaskRecord(userId);
  record.currentTask = newTask;
  await wixData.update("UserRatingTasks", record);
}

/**
 * è·å–ç”¨æˆ·å·²å®Œæˆçš„è¯„åˆ†ä½œå“åˆ—è¡¨
 */
async function getUserCompletedRatings(userId) {
  const comments = await wixData
    .query("BOFcomment")
    .eq("_owner", userId)
    .isEmpty("replyTo")
    .find();
  
  return comments.items.map(comment => comment.workNumber);
}

/**
 * æ›´æ–°ä½œå“è¯„åˆ†ç»Ÿè®¡
 */
async function updateWorkRatingCount(workNumber) {
  const comments = await wixData
    .query("BOFcomment")
    .eq("workNumber", workNumber)
    .isEmpty("replyTo")
    .find();
  
  // æ’é™¤ä½œè€…è‡ªè¯„
  const work = await wixData
    .query("enterContest034")
    .eq("sequenceId", workNumber)
    .find();
  
  if (work.items.length > 0) {
    const workOwnerId = work.items[0]._owner;
    const validRatings = comments.items.filter(c => c._owner !== workOwnerId);
    
    // æ›´æ–°ä½œå“è¯„åˆ†è®¡æ•°ï¼ˆå¦‚æœæœ‰ä¸“é—¨çš„å­—æ®µï¼‰
    work.items[0].currentRatingCount = validRatings.length;
    await wixData.update("enterContest034", work.items[0]);
  }
}

/**
 * è·å–ç”¨æˆ·è‡ªå·±çš„ä½œå“åºå·
 */
async function getUserOwnWork(userId) {
  const works = await wixData
    .query("enterContest034")
    .eq("_owner", userId)
    .find();
  
  return works.items.length > 0 ? works.items[0].sequenceId : null;
}

/**
 * è®¡ç®—å¤©æ•°å·®
 */
function getDaysSinceSubmission(work) {
  const now = new Date();
  const submissionDate = new Date(work._createdDate);
  const diffTime = Math.abs(now - submissionDate);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}
```

### 6. å®šæ—¶ä»»åŠ¡ï¼šåŒæ­¥ç”¨æˆ·è¯„åˆ†è®°å½•

```javascript
/**
 * æ¯æ—¥è¿è¡Œï¼šåŒæ­¥ç”¨æˆ·çš„å®é™…è¯„åˆ†è®°å½•åˆ°ä»»åŠ¡ç³»ç»Ÿ
 * é˜²æ­¢ç”¨æˆ·ç›´æ¥åœ¨ä¸»ä¼šåœºè¯„åˆ†è€Œç»•è¿‡ä»»åŠ¡ç³»ç»Ÿ
 */
async function syncUserRatingRecords() {
  try {
    console.log("å¼€å§‹åŒæ­¥ç”¨æˆ·è¯„åˆ†è®°å½•...");
    
    // è·å–æ‰€æœ‰å‚èµ›ç”¨æˆ·
    const allUsers = await getRegisteredUsers();
    
    for (const user of allUsers) {
      // è·å–ç”¨æˆ·å®é™…å®Œæˆçš„è¯„åˆ†
      const actualRatings = await getUserCompletedRatings(user.userId);
      
      // è·å–ä»»åŠ¡è®°å½•
      const taskRecord = await getUserTaskRecord(user.userId);
      
      // åˆå¹¶è®°å½•ï¼ˆå»é‡ï¼‰
      const mergedCompletedTasks = [...new Set([
        ...taskRecord.completedTasks,
        ...actualRatings
      ])];
      
      // æ›´æ–°è®°å½•
      taskRecord.completedTasks = mergedCompletedTasks;
      taskRecord.totalCompleted = mergedCompletedTasks.length;
      
      await wixData.update("UserRatingTasks", taskRecord);
      
      // å¦‚æœç”¨æˆ·æ²¡æœ‰å½“å‰ä»»åŠ¡ï¼Œåˆ†é…ä¸€ä¸ª
      if (!taskRecord.currentTask || taskRecord.currentTask.status === "completed") {
        await assignNextTask(user.userId);
      }
    }
    
    console.log("è¯„åˆ†è®°å½•åŒæ­¥å®Œæˆ");
    
  } catch (error) {
    console.error("åŒæ­¥è¯„åˆ†è®°å½•å¤±è´¥:", error);
  }
}

/**
 * è·å–æ‰€æœ‰å·²æŠ¥åçš„å‚èµ›ç”¨æˆ·
 */
async function getRegisteredUsers() {
  // æ ¹æ®ä½ çš„æŠ¥åç³»ç»Ÿè°ƒæ•´æŸ¥è¯¢é€»è¾‘
  const registrations = await wixData.query("Team").find();
  return registrations.items.map(reg => ({ userId: reg._owner }));
}
```

---

## å‰ç«¯å®ç°æ–¹æ¡ˆï¼ˆè‡ªå®šä¹‰HTMLï¼‰

### HTMLç»“æ„

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .progress-section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .progress-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 20px;
    }
    
    .progress-bar-container {
      background: #e2e8f0;
      height: 32px;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      margin-bottom: 12px;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.6s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    
    .progress-text {
      color: #718096;
      font-size: 14px;
      text-align: right;
    }
    
    .task-section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .task-title {
      font-size: 20px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    
    .task-icon {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }
    
    .current-task {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
    }
    
    .task-label {
      font-size: 12px;
      color: #d63031;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .task-work-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .work-number {
      font-size: 28px;
      font-weight: 800;
      color: #2d3748;
    }
    
    .coldness-badge {
      background: #d63031;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .task-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #636e72;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .action-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    .action-button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }
    
    .completed-list {
      margin-top: 24px;
    }
    
    .completed-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 12px;
    }
    
    .completed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 8px;
    }
    
    .completed-item {
      background: #e2e8f0;
      padding: 12px 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
    }
    
    .no-task {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
    
    .no-task-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .loading {
      text-align: center;
      padding: 60px;
      color: #718096;
    }
    
    .spinner {
      border: 4px solid #e2e8f0;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- è¿›åº¦åŒºåŸŸ -->
    <div class="progress-section">
      <div class="progress-title">è¯„åˆ†è¿›åº¦</div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar">
          <span id="progressPercentage">0%</span>
        </div>
      </div>
      <div class="progress-text" id="progressText">å·²å®Œæˆ 0 / 20</div>
    </div>
    
    <!-- ä»»åŠ¡åŒºåŸŸ -->
    <div class="task-section">
      <div class="task-title">
        <svg class="task-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 11l3 3L22 4"></path>
        </svg>
        å½“å‰ä»»åŠ¡
      </div>
      
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <div>åŠ è½½ä¸­...</div>
      </div>
      
      <div id="taskContent" style="display: none;">
        <div class="current-task">
          <div class="task-label">ğŸ”¥ éœ€è¦å…³æ³¨çš„ä½œå“</div>
          <div class="task-work-info">
            <div>
              <span style="font-size: 14px; color: #636e72;">ä½œå“ç¼–å·</span>
              <div class="work-number">#<span id="taskWorkNumber">--</span></div>
            </div>
            <div class="coldness-badge" id="coldnessBadge">å†·é—¨åº¦: --</div>
          </div>
          <div class="task-meta">
            <div class="meta-item">
              <span>ğŸ“Š</span>
              <span id="currentRatings">-- ä¸ªè¯„åˆ†</span>
            </div>
            <div class="meta-item">
              <span>ğŸ¯</span>
              <span>ç›®æ ‡: 20 ä¸ªè¯„åˆ†</span>
            </div>
          </div>
          <button class="action-button" id="goToRateBtn">å‰å¾€è¯„åˆ†</button>
        </div>
        
        <!-- å·²å®Œæˆåˆ—è¡¨ -->
        <div class="completed-list">
          <div class="completed-title">å·²å®Œæˆè¯„åˆ† (<span id="completedCount">0</span>)</div>
          <div class="completed-grid" id="completedGrid">
            <!-- åŠ¨æ€å¡«å…… -->
          </div>
        </div>
      </div>
      
      <div id="noTaskState" style="display: none;" class="no-task">
        <div class="no-task-icon">ğŸ‰</div>
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">å¤ªæ£’äº†ï¼</div>
        <div>ä½ å·²ç»å®Œæˆäº†æ‰€æœ‰ä»»åŠ¡</div>
      </div>
    </div>
  </div>
  
  <script>
    let currentUserId = null;
    let taskData = null;
    
    // ç›‘å¬æ¥è‡ªWixé¡µé¢çš„æ¶ˆæ¯
    window.addEventListener('message', async (event) => {
      if (event.data.type === 'INIT_TASK_PAGE') {
        currentUserId = event.data.userId;
        await loadTaskData();
      }
      
      if (event.data.type === 'TASK_COMPLETED') {
        await loadTaskData();
      }
    });
    
    // åŠ è½½ä»»åŠ¡æ•°æ®
    async function loadTaskData() {
      try {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('taskContent').style.display = 'none';
        document.getElementById('noTaskState').style.display = 'none';
        
        // å‘Wixé¡µé¢è¯·æ±‚æ•°æ®
        window.parent.postMessage({
          type: 'GET_TASK_DATA',
          userId: currentUserId
        }, '*');
        
      } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
      }
    }
    
    // æ¥æ”¶ä»»åŠ¡æ•°æ®
    window.addEventListener('message', (event) => {
      if (event.data.type === 'TASK_DATA_RESPONSE') {
        taskData = event.data.data;
        renderTaskPage();
      }
    });
    
    // æ¸²æŸ“ä»»åŠ¡é¡µé¢
    function renderTaskPage() {
      document.getElementById('loadingState').style.display = 'none';
      
      const { currentTask, completedTasks, totalCompleted } = taskData;
      
      // æ›´æ–°è¿›åº¦
      const progress = Math.min((totalCompleted / 20) * 100, 100);
      document.getElementById('progressBar').style.width = progress + '%';
      document.getElementById('progressPercentage').textContent = Math.round(progress) + '%';
      document.getElementById('progressText').textContent = `å·²å®Œæˆ ${totalCompleted} / 20`;
      
      // æ¸²æŸ“å½“å‰ä»»åŠ¡
      if (currentTask && currentTask.status === 'pending') {
        document.getElementById('taskContent').style.display = 'block';
        document.getElementById('taskWorkNumber').textContent = currentTask.workNumber;
        document.getElementById('coldnessBadge').textContent = `å†·é—¨åº¦: ${currentTask.weight || '--'}`;
        document.getElementById('currentRatings').textContent = `${currentTask.currentRatings || 0} ä¸ªè¯„åˆ†`;
      } else {
        document.getElementById('noTaskState').style.display = 'block';
      }
      
      // æ¸²æŸ“å·²å®Œæˆåˆ—è¡¨
      document.getElementById('completedCount').textContent = totalCompleted;
      const completedGrid = document.getElementById('completedGrid');
      completedGrid.innerHTML = '';
      
      completedTasks.forEach(workNum => {
        const item = document.createElement('div');
        item.className = 'completed-item';
        item.textContent = `#${workNum}`;
        completedGrid.appendChild(item);
      });
    }
    
    // å‰å¾€è¯„åˆ†æŒ‰é’®
    document.getElementById('goToRateBtn').addEventListener('click', () => {
      if (taskData && taskData.currentTask) {
        window.parent.postMessage({
          type: 'GO_TO_RATE',
          workNumber: taskData.currentTask.workNumber
        }, '*');
      }
    });
    
    // é¡µé¢åŠ è½½å®Œæˆï¼Œé€šçŸ¥çˆ¶é¡µé¢
    window.parent.postMessage({ type: 'TASK_PAGE_READY' }, '*');
  </script>
</body>
</html>
```

---

## Wixé¡µé¢é›†æˆä»£ç 

```javascript
// src/pages/Mission_ä»»åŠ¡.w3eih.js

import wixUsers from 'wix-users';
import wixWindow from 'wix-window';
import { 
  getUserTaskData,
  completeUserTask,
  assignNextTask 
} from 'backend/ratingTaskManager.jsw';

let currentUserId = null;

$w.onReady(async function () {
  // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
  if (!wixUsers.currentUser.loggedIn) {
    wixWindow.lightbox.close();
    return;
  }
  
  currentUserId = wixUsers.currentUser.id;
  
  // ç­‰å¾…HTMLç»„ä»¶å‡†å¤‡å°±ç»ª
  $w('#html1').onMessage(async (event) => {
    const { type, data } = event.data;
    
    switch (type) {
      case 'TASK_PAGE_READY':
        // HTMLé¡µé¢å‡†å¤‡å¥½äº†ï¼Œå‘é€åˆå§‹åŒ–æ•°æ®
        await initTaskPage();
        break;
        
      case 'GET_TASK_DATA':
        // è¯·æ±‚ä»»åŠ¡æ•°æ®
        await sendTaskData();
        break;
        
      case 'GO_TO_RATE':
        // è·³è½¬åˆ°è¯„åˆ†é¡µé¢
        await goToRatePage(data.workNumber);
        break;
    }
  });
});

/**
 * åˆå§‹åŒ–ä»»åŠ¡é¡µé¢
 */
async function initTaskPage() {
  $w('#html1').postMessage({
    type: 'INIT_TASK_PAGE',
    userId: currentUserId
  });
}

/**
 * å‘é€ä»»åŠ¡æ•°æ®åˆ°HTMLç»„ä»¶
 */
async function sendTaskData() {
  try {
    const taskData = await getUserTaskData(currentUserId);
    
    $w('#html1').postMessage({
      type: 'TASK_DATA_RESPONSE',
      data: taskData
    });
    
  } catch (error) {
    console.error('è·å–ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
  }
}

/**
 * è·³è½¬åˆ°è¯„åˆ†é¡µé¢
 */
async function goToRatePage(workNumber) {
  // è·³è½¬åˆ°ä¸»ä¼šåœºé¡µé¢ï¼Œå¹¶è‡ªåŠ¨å®šä½åˆ°è¯¥ä½œå“
  wixWindow.openLightbox('Stage_ä¸»ä¼šåœº', {
    targetWorkNumber: workNumber
  });
  
  // æˆ–è€…ä½¿ç”¨é¡µé¢è·³è½¬
  // wixLocation.to(`/stage?work=${workNumber}`);
}
```

---

## åç«¯Web Methodsæ–‡ä»¶

åˆ›å»º `src/backend/ratingTaskManager.jsw`:

```javascript
import wixData from 'wix-data';

/**
 * è·å–ç”¨æˆ·ä»»åŠ¡æ•°æ®
 */
export async function getUserTaskData(userId) {
  try {
    // è·å–ä»»åŠ¡è®°å½•
    const taskRecord = await getUserTaskRecord(userId);
    
    // åŒæ­¥å®é™…è¯„åˆ†
    const actualRatings = await getUserCompletedRatings(userId);
    const mergedCompleted = [...new Set([...taskRecord.completedTasks, ...actualRatings])];
    
    // å¦‚æœéœ€è¦æ›´æ–°è®°å½•
    if (mergedCompleted.length > taskRecord.completedTasks.length) {
      taskRecord.completedTasks = mergedCompleted;
      taskRecord.totalCompleted = mergedCompleted.length;
      await wixData.update("UserRatingTasks", taskRecord);
    }
    
    // å¦‚æœæ²¡æœ‰å½“å‰ä»»åŠ¡ï¼Œåˆ†é…ä¸€ä¸ª
    if (!taskRecord.currentTask || taskRecord.currentTask.status === 'completed') {
      const newTask = await assignNextTask(userId);
      if (newTask) {
        taskRecord.currentTask = {
          workNumber: newTask.workNumber,
          weight: newTask.weight,
          currentRatings: newTask.currentRatings,
          status: 'pending'
        };
      }
    } else {
      // æ›´æ–°å½“å‰ä»»åŠ¡çš„å®æ—¶ä¿¡æ¯
      const workInfo = await getWorkInfo(taskRecord.currentTask.workNumber);
      taskRecord.currentTask.weight = calculateColdnessWeight(workInfo);
      taskRecord.currentTask.currentRatings = workInfo.currentRatingCount || 0;
    }
    
    return {
      currentTask: taskRecord.currentTask,
      completedTasks: taskRecord.completedTasks,
      totalCompleted: taskRecord.totalCompleted
    };
    
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
    throw error;
  }
}

// ... (å¤åˆ¶å‰é¢çš„æ‰€æœ‰è¾…åŠ©å‡½æ•°)
```

---

## æ•°æ®åº“é›†åˆé…ç½®

éœ€è¦åœ¨Wixåå°åˆ›å»ºä»¥ä¸‹é›†åˆï¼š

1. **UserRatingTasks** é›†åˆ
   - userId (Text, å¿…å¡«)
   - currentTask (JSON)
   - completedTasks (JSON - Array)
   - totalCompleted (Number)
   - _createdDate (è‡ªåŠ¨)
   - _updatedDate (è‡ªåŠ¨)

2. **enterContest034** é›†åˆï¼ˆå·²å­˜åœ¨ï¼Œæ·»åŠ å­—æ®µï¼‰
   - currentRatingCount (Number) - å­˜å‚¨å½“å‰è¯„åˆ†æ•°

---

è¿™ä¸ªæ–¹æ¡ˆå¤§å¤§ç®€åŒ–äº†ç³»ç»Ÿå¤æ‚åº¦ï¼Œæ ¸å¿ƒå°±æ˜¯åŸºäºå†·é—¨æƒé‡çš„å•ä»»åŠ¡æ¨é€æœºåˆ¶ã€‚ä½ è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿéœ€è¦æˆ‘è°ƒæ•´å“ªäº›éƒ¨åˆ†å—ï¼Ÿ

