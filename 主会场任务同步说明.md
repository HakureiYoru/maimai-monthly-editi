# 主会场任务同步功能说明

## 📋 问题描述

**原问题**：
- 用户在任务页面看到的任务可能已经超时需要刷新
- 切换到主会场后，任务状态没有同步更新
- 导致主会场显示的"未评论（任务！！）"提示可能是基于旧任务列表

## ✅ 解决方案

在主会场页面加载时，自动检查并刷新任务（如果已超过刷新时间间隔）。

## 🔧 实现细节

### 文件修改：`src/pages/Stage_主会场.vz6uu.js`

#### 1. 导入函数
```javascript
import { markTaskCompleted, checkIfWorkInTaskList, getUserTaskData } from "backend/ratingTaskManager.jsw";
```

#### 2. 页面初始化时检查
```javascript
// 页面初始化
$w.onReady(async function () {
  await checkUserVerification();
  updateCommentControlsVerificationStatus();

  // 检查并刷新任务（如果超过刷新时间间隔）
  if (currentUserId && isUserVerified) {
    try {
      await getUserTaskData(currentUserId);
      console.log("[主会场] 任务同步检查完成");
    } catch (error) {
      console.error("[主会场] 任务同步检查失败:", error);
    }
  }

  commentsCountByWorkNumber = await getAllCommentsCount();
  // ... 其他初始化代码
});
```

## 🎯 工作原理

### 同步检查流程

1. **用户进入主会场**
   - 检查用户是否登录且已验证
   
2. **调用 `getUserTaskData()`**
   - 此函数会自动检查 `lastRefreshTime`
   - 如果超过刷新间隔（当前设置2分钟），自动刷新任务
   - 更新任务列表到最新状态

3. **任务状态同步**
   - 主会场显示的任务提示基于最新任务列表
   - "未评论（任务！！）"高亮提示准确显示

## 📊 用户体验改进

### 改进前：
```
任务页面 → 主会场
   ↓          ↓
 最新任务   旧任务（可能过期）
   ↓          ↓
 任务A,B,C  仍显示旧任务的高亮
```

### 改进后：
```
任务页面 → 主会场
   ↓          ↓
 自动刷新   自动同步刷新
   ↓          ↓
 最新任务A,B,C → 准确显示最新任务高亮
```

## 🧪 测试验证

### 测试场景
1. **访问任务页面**
   - 查看当前任务（例如：#123, #456, #789）
   
2. **等待刷新间隔（当前2分钟）**
   - 不做任何操作

3. **访问主会场**
   - 打开浏览器控制台
   - 应看到：`[主会场] 任务同步检查完成`
   - 如果任务已刷新，还会看到：`用户 {userId} 任务已超时，将刷新任务列表`

4. **验证任务高亮**
   - 主会场的任务高亮应基于最新任务列表
   - "未评论（任务！！）"提示应准确显示

### 预期结果
- ✅ 进入主会场时自动同步任务
- ✅ 控制台显示同步日志
- ✅ 任务状态准确一致
- ✅ 无JavaScript错误

## 🔄 双重保障机制

### 1. 任务页面刷新
- 用户访问任务页面时检查
- Check按钮手动刷新

### 2. 主会场同步（新增）
- 用户进入主会场时检查
- 自动同步最新任务状态

### 3. 定时检查
- 两个页面都会检查 `lastRefreshTime`
- 超过刷新间隔自动刷新
- 确保数据始终同步

## 💡 优化说明

### 性能考虑
- ✅ 只在用户登录且已验证时执行
- ✅ 使用异步调用，不阻塞页面加载
- ✅ 失败时不影响主会场正常使用
- ✅ 有详细的日志记录便于调试

### 代码质量
- ✅ 添加 try-catch 错误处理
- ✅ 清晰的日志标识 `[主会场]`
- ✅ 不影响现有功能
- ✅ 无linter错误

## 📝 调试日志

### 正常同步
```
[主会场] 任务同步检查完成
```

### 任务刷新
```
用户 {userId} 任务已超时，将刷新任务列表
[主会场] 任务同步检查完成
```

### 错误情况
```
[主会场] 任务同步检查失败: Error: ...
```

## ⚙️ 配置参数

### 刷新间隔（调试用）
```javascript
// src/backend/ratingTaskManager.jsw
const TASK_REFRESH_HOURS = 1/30; // 2分钟
```

### 生产环境（记得改回）
```javascript
const TASK_REFRESH_HOURS = 48; // 48小时=2天
```

## 📋 总结

通过在主会场添加任务同步检查，确保了：

1. **数据一致性** - 任务页面和主会场显示相同的任务状态
2. **用户体验** - 任务提示准确，不会误导用户
3. **自动化** - 无需用户手动操作，自动保持同步
4. **可靠性** - 双重检查机制，确保任务及时更新

---

**更新日期**: 2025-10-06  
**版本**: v1.1.1  
**状态**: ✅ 已实现并测试

