<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½œå“è¯„åˆ†æ’è¡Œæ¦œ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Dancing+Script:wght@700&display=swap');
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: transparent;
      font-family: 'Noto Sans SC', sans-serif;
      padding: 20px;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      background: rgba(250, 250, 250, 0.83);
      border-radius: 25px;
      padding: 25px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      background-image: 
        radial-gradient(circle at 20% 20%, rgba(173, 216, 230, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 182, 193, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(144, 238, 144, 0.08) 0%, transparent 50%);
    }

    .chart-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .main-title {
      font-family: 'Dancing Script', cursive;
      font-size: clamp(28px, 4vw, 48px);
      background: linear-gradient(135deg, #4A90E2, #7B68EE, #FF69B4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      font-weight: 700;
    }

    .subtitle {
      font-size: clamp(14px, 2vw, 18px);
      color: #666;
      font-weight: 300;
      letter-spacing: 1px;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      position: relative;
      overflow: hidden;
    }

    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 400px;
      font-size: 18px;
      color: #7B68EE;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(123, 104, 238, 0.1);
      border-left-color: #7B68EE;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      font-weight: 500;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .score-color {
      background: linear-gradient(135deg, #4A90E2, #357ABD);
    }

    .comment-color {
      background: linear-gradient(135deg, #FF6B9D, #E55A87);
    }

    /* ç§»é™¤æŸ±çŠ¶å›¾ç›¸å…³CSSæ ·å¼ */

    /* å¡ç‰‡å¼æ’è¡Œæ¦œ */
    .ranking-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .rank-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(250, 250, 250, 0.8));
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .rank-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    /* æœªè¯„åˆ†ä½œå“çš„ç°è‰²æ ·å¼ */
    .rank-card.no-rating {
      background: linear-gradient(135deg, rgba(169, 169, 169, 0.6), rgba(211, 211, 211, 0.6));
      opacity: 0.7;
    }

    .rank-card.no-rating .work-number {
      color: #999 !important;
    }

    .rank-card.no-rating .metric-value {
      color: #999 !important;
    }

    .rank-card.no-rating::before {
      background: #999 !important;
    }

    .rank-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--rank-color);
    }

    .rank-number {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--rank-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .work-number {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--rank-color), var(--rank-color-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .metrics {
      display: flex;
      justify-content: space-between;
      gap: 16px;
    }

    .metric {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .metric-value {
      font-size: 20px;
      font-weight: 700;
    }

    .score-value {
      color: #4A90E2;
    }

    .comment-value {
      color: #FF6B9D;
    }

    .stats-info {
      margin-top: 30px;
      padding: 20px;
      background: rgba(123, 104, 238, 0.1);
      border-radius: 16px;
      text-align: center;
      font-size: 14px;
      color: #666;
      border: 1px solid rgba(123, 104, 238, 0.2);
    }

    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .toggle-btn {
      padding: 10px 20px;
      border: 2px solid #4A90E2;
      background: transparent;
      color: #4A90E2;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .toggle-btn.active {
      background: #4A90E2;
      color: white;
    }

    .toggle-btn:hover {
      background: #4A90E2;
      color: white;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .no-data-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px;
        margin: 5px;
      }
      
      .chart-container {
        padding: 20px;
        margin: 10px 0;
      }
      
      .chart-header {
        padding: 15px;
        margin-bottom: 20px;
      }
      
      .chart-legend {
        gap: 15px;
      }
      
      .legend-item {
        padding: 6px 12px;
        font-size: 12px;
      }

      .ranking-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 10px;
        margin: 2px;
      }
      
      .chart-header {
        padding: 10px;
        margin-bottom: 15px;
      }
      
      .chart-container {
        padding: 15px;
      }
      
      .chart-legend {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .view-toggle {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="chart-header">
      <h1 class="main-title">ğŸµ ä½œå“è¯„åˆ†æ’è¡Œæ¦œ ğŸµ</h1>
      <p class="subtitle">åŸºäºè¯„è®ºçƒ­åº¦å’Œè¯„åˆ†çš„ç»¼åˆæ’å</p>
    </div>

    <div class="chart-container">
      <div class="chart-legend">
        <div class="legend-item">
          <div class="legend-color score-color"></div>
          <span>å¹³å‡è¯„åˆ†</span>
        </div>
        <div class="legend-item">
          <div class="legend-color comment-color"></div>
          <span>è¯„è®ºæ•°é‡</span>
        </div>
      </div>

      <div class="view-toggle">
        <button class="toggle-btn active" onclick="switchSort('comments')">æŒ‰è¯„è®ºæ•°é‡</button>
        <button class="toggle-btn" onclick="switchSort('score')">æŒ‰è¯„åˆ†æ’åº</button>
      </div>
      
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        æ­£åœ¨åŠ è½½æ•°æ®...
      </div>

      <!-- å¡ç‰‡å¼æ’è¡Œæ¦œ -->
      <div id="cardView" class="ranking-grid" style="display: none;"></div>

      <!-- ç§»é™¤æŸ±çŠ¶å›¾è§†å›¾ -->

      <div class="no-data" id="noData" style="display: none;">
        <div class="no-data-icon">ğŸ“Š</div>
        <h3>æš‚æ— æ•°æ®</h3>
        <p>ç­‰å¾…è¯„è®ºæ•°æ®åŠ è½½ä¸­...</p>
      </div>
      
      <div class="stats-info" id="statsInfo" style="display: none;">
        <span id="statsText"></span>
      </div>
    </div>
  </div>

  <script>
    let chartData = null;
    let currentView = 'cards';
    let sortMode = 'comments'; // 'comments' æˆ– 'score'

    function log(message) {
      console.log(`[çº¯CSSå›¾è¡¨] ${message}`);
    }

    function switchSort(mode) {
      sortMode = mode;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // å¦‚æœæœ‰æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“
      if (chartData) {
        renderChart(chartData);
      }
    }

    function hideLoadingSpinner() {
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('noData').style.display = 'none';
    }

    function showNoData() {
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('cardView').style.display = 'none';
      document.getElementById('noData').style.display = 'block';
      document.getElementById('statsInfo').style.display = 'none';
    }

    function showStatsInfo(data) {
      const statsInfo = document.getElementById('statsInfo');
      const statsText = document.getElementById('statsText');
      
      const totalWorks = data.length;
      const totalComments = data.reduce((sum, item) => sum + item.count, 0);
      const avgScore = data.reduce((sum, item) => sum + item.score, 0) / totalWorks;
      
      statsText.textContent = `å…±æ˜¾ç¤º ${totalWorks} ä¸ªä½œå“ â€¢ æ€»è¯„è®ºæ•°: ${totalComments} â€¢ å¹³å‡è¯„åˆ†: ${avgScore.toFixed(1)}`;
      statsInfo.style.display = 'block';
    }

    function getRankColor(rank) {
      switch(rank) {
        case 1: return { color: '#FFD700', light: '#FFF8DC' }; // é‡‘è‰²
        case 2: return { color: '#C0C0C0', light: '#F5F5F5' }; // é“¶è‰²
        case 3: return { color: '#CD7F32', light: '#F4E4BC' }; // é“œè‰²
        default: return { color: '#4A90E2', light: '#E3F2FD' }; // è“è‰²
      }
    }

    function createCardView(data) {
      const cardView = document.getElementById('cardView');
      cardView.innerHTML = '';

      // æ ¹æ®æ’åºæ¨¡å¼å’Œè¯„åˆ†çŠ¶æ€å¯¹æ•°æ®è¿›è¡Œæ’åº
      let sortedData = [...data];
      
      // åˆ†ç¦»å·²è¯„åˆ†å’Œæœªè¯„åˆ†çš„ä½œå“
      const ratedWorks = sortedData.filter(item => item.hasUserRating);
      const unratedWorks = sortedData.filter(item => !item.hasUserRating);
      
      // å¯¹å·²è¯„åˆ†ä½œå“è¿›è¡Œæ’åº
      if (sortMode === 'score') {
        ratedWorks.sort((a, b) => b.score - a.score);
      } else {
        ratedWorks.sort((a, b) => b.count - a.count);
      }
      
      // å¯¹æœªè¯„åˆ†ä½œå“è¿›è¡Œæ’åºï¼ˆæŒ‰ç¼–å·å¤§å°æ’åºï¼‰
      unratedWorks.sort((a, b) => parseInt(a.workNumber) - parseInt(b.workNumber));
      
      // åˆå¹¶æ•°æ®ï¼šå·²è¯„åˆ†çš„åœ¨å‰ï¼Œæœªè¯„åˆ†çš„åœ¨å
      const finalData = [...ratedWorks, ...unratedWorks];

      finalData.forEach((item, index) => {
        const rank = index + 1;
        const colors = getRankColor(rank);
        
        const card = document.createElement('div');
        card.className = item.hasUserRating ? 'rank-card' : 'rank-card no-rating';
        card.style.setProperty('--rank-color', colors.color);
        card.style.setProperty('--rank-color-light', colors.light);
        
        // å¯¹äºæœªè¯„åˆ†çš„ä½œå“ï¼Œæ˜¾ç¤º"?"è€Œä¸æ˜¯è¯„åˆ†
        const scoreDisplay = item.hasUserRating ? Math.round(item.score) : '?';
        
        card.innerHTML = `
          <div class="rank-number">${rank}</div>
          <div class="work-number">#${item.workNumber}</div>
          <div class="metrics">
            <div class="metric">
              <div class="metric-label">å¹³å‡è¯„åˆ†</div>
              <div class="metric-value score-value">${scoreDisplay}</div>
            </div>
            <div class="metric">
              <div class="metric-label">è¯„è®ºæ•°é‡</div>
              <div class="metric-value comment-value">${item.count}</div>
            </div>
          </div>
        `;

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        card.onclick = () => {
          log(`ç‚¹å‡»äº†ä½œå“ #${item.workNumber}`);
        };

        cardView.appendChild(card);
      });
    }

    // ç§»é™¤æŸ±çŠ¶å›¾å‡½æ•°

    function renderChart(data) {
      hideLoadingSpinner();
      
      createCardView(data);
      document.getElementById('cardView').style.display = 'grid';
      
      showStatsInfo(data);
    }

    function processMessage(data) {
      try {
        log(`æ¥æ”¶åˆ°æ•°æ®: ${data.workNumbers?.length || 0} ä¸ªä½œå“`);
        
        if (data && data.workNumbers && data.scores && data.commentsCounts && data.userRatings) {
          // æ•°æ®å¤„ç†å’Œæ’åº
          let combined = data.commentsCounts.map((count, index) => ({ 
            count, 
            score: data.scores[index] || 0, 
            workNumber: data.workNumbers[index],
            hasUserRating: data.userRatings[index] || false, // ç”¨æˆ·æ˜¯å¦è¯„è¿‡è¯¥ä½œå“
            index 
          }));
          
          // è¿‡æ»¤æ‰æ— æ•ˆæ•°æ®
          combined = combined.filter(item => item.workNumber && item.count > 0);
          
          // å–å‰20åä»¥æ˜¾ç¤ºæ›´å¤šä½œå“
          combined = combined.slice(0, 20);

          if (combined.length === 0) {
            showNoData();
            return;
          }

          chartData = combined;
          renderChart(combined);
          
          const ratedCount = combined.filter(item => item.hasUserRating).length;
          const unratedCount = combined.length - ratedCount;
          log(`å›¾è¡¨åˆ›å»ºæˆåŠŸï¼Œæ˜¾ç¤º ${combined.length} ä¸ªä½œå“ï¼ˆå·²è¯„åˆ†: ${ratedCount}, æœªè¯„åˆ†: ${unratedCount}ï¼‰`);
        } else {
          log('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
          showNoData();
        }
      } catch (error) {
        log('å¤„ç†æ•°æ®æ—¶å‡ºé”™: ' + error.message);
        showNoData();
      }
    }

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', () => {
      log('çº¯CSSå›¾è¡¨é¡µé¢åŠ è½½å®Œæˆ');
      
      // å‘çˆ¶é¡µé¢å‘é€å°±ç»ªæ¶ˆæ¯
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'chart-ready' }, '*');
          log('å·²å‘çˆ¶é¡µé¢å‘é€å°±ç»ªæ¶ˆæ¯');
        }
      } catch (error) {
        log('å‘é€å°±ç»ªæ¶ˆæ¯å¤±è´¥: ' + error.message);
      }
      
      // 5ç§’åæ˜¾ç¤ºæµ‹è¯•æ•°æ®
      setTimeout(() => {
        if (!chartData) {
          log('5ç§’åä»æœªæ”¶åˆ°æ•°æ®ï¼Œæ˜¾ç¤ºæµ‹è¯•å›¾è¡¨');
          const testData = {
            workNumbers: ['1', '2', '3', '4', '5', '213', '42', '88', '156', '77'],
            scores: [850, 750, 920, 680, 780, 962, 690, 810, 745, 665],
            commentsCounts: [15, 8, 23, 5, 12, 7, 9, 11, 6, 4],
            userRatings: [true, false, true, false, true, true, false, true, false, false]
          };
          processMessage(testData);
        }
      }, 5000);
    });

    // å¤šç§æ¶ˆæ¯ç›‘å¬æ–¹å¼
    window.addEventListener('message', (event) => {
      log('æ¥æ”¶åˆ°æ¶ˆæ¯');
      processMessage(event.data);
    });

    window.receiveChartData = function(data) {
      log('ç›´æ¥å‡½æ•°è°ƒç”¨æ”¶åˆ°æ•°æ®');
      processMessage(data);
    };

    // å…¨å±€å˜é‡è½®è¯¢
    setInterval(() => {
      if (window.chartData && !window.chartDataProcessed) {
        log('è½®è¯¢æ£€æµ‹åˆ°å…¨å±€å˜é‡æ•°æ®');
        processMessage(window.chartData);
        window.chartDataProcessed = true;
      }
    }, 1000);
  </script>
</body>
</html>

