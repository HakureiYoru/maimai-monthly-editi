# Majnet 上传队列系统说明

## 概述

为了避免多个谱面同时上传导致服务器压力过大或被 Cloudflare 拦截，后台提供了一个串行上传队列。该队列由 `data.js` 的 `enterContest034_afterInsert` 钩子自动触发，调用 `uploadContestItemToMajnet` 将任务加入队列，无需前端介入。

## 工作方式

- 自动排队：`UploadQueue` 以先进先出（FIFO）方式依次处理上传任务。
- 延迟保护：每个任务之间强制等待 `UPLOAD_DELAY` 毫秒（默认 2000ms）。
- 会话复用：同一批任务共享一次登录会话，减少登录次数。

## 日志

示例日志：

```
[UploadQueue] 任务已加入队列: 作品标题_1234567890 | 队列长度: 3
[UploadQueue] 等待 1500ms 后执行任务: 作品标题_1234567890
[UploadQueue] 开始执行任务: 作品标题_1234567890 | 等待时长: 5.2秒 | 剩余队列: 2
[UploadQueue] 任务完成: 作品标题_1234567890 | 成功: true
[UploadQueue] 队列处理完成
```

## 配置参数

位于 `MAJNET_CONFIG`：

- `UPLOAD_DELAY`: 上传间隔时间，默认 2000ms。
- `BASE_TIMEOUT`: 上传请求的基础超时时间，默认 30000ms。
- `MAX_TIMEOUT`: 上传请求的最大超时时间，默认 120000ms。
- `USER_AGENT`: 访问 Majnet 时使用的 UA 字符串。

## 注意事项

1. 队列只保存在内存中，服务重启后需要重新提交未完成的任务。
2. 登录会话 30 分钟后过期，队列会自动重新登录。
3. 仅保留 `uploadContestItemToMajnet` 作为上传入口，原先的批量上传与队列状态查询接口已移除。如需手动触发上传，请复用这一入口函数。

## 测试建议

- 同时触发多条上传请求，确认日志中任务按顺序执行且间隔约 2 秒。
- 模拟超时或断网，确认错误被记录且后续任务仍可继续处理。

## 更新日志

- **2025-12-08**: 移除未使用的批量上传与队列状态查询接口，上传流程仅保留自动入口。
- **2024-12-02**: 初始实现队列系统（引入 UploadQueue，`uploadChartToMajnet` 支持队列）。
